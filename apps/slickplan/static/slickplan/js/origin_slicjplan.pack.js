    /**
     * Created by osvaldo on 12/07/16.
     */
    Slickplan.module(function(e,t,i){t.subscribe("route/account/company",function(){var a=t.require("config"),o=t.require("form"),n=t.require("notification"),s=t.require("string");if(t.currentUserCan("account_branding")){var r;t.$main.on("change","#colorinput",function(){var t=this.value||!1;t&&(t="#"+t.replace("#",""),e("#header-wrapper").attr("style","background-color: "+t+" !important"),e("#header > .logo + div + ul").attr("style","background-color: "+t+" !important; box-shadow: -20px 12px 10px "+t+" !important"))}).on("change",'input:radio[name="form[company_logo_type]"]',function(){var t=parseInt(e(this).val(),10),i=e("#header div.logo");if(1===t)i.removeClass("logo-text").addClass("logo-img").find("img").attr("src",e(this).data("value"));else{var a="logo-text";t=e("#form-name2").val(),t.length&&(t="<span>"+s.charsEncode(t)+"</span>",a+=" second"),i.removeClass("logo-img second").addClass(a).children("a").filter(":last").html("<span>"+s.charsEncode(e("#form-name1").val())+"</span>"+t)}}).on("change","#form-name1, #form-name2",function(){e("#form-uselogo1").is(":checked")&&e("#form-uselogo1").change()}).on("change","#form-darkfont",function(){e(this).is(":checked")?t.$body.addClass("darkFont"):t.$body.removeClass("darkFont")}).on("focus","#form-subdomain",function(){this.value=e.trim(this.value).replace(".slickplan.com","")}).on("blur","#form-subdomain",function(){this.value=e.trim(this.value).toLowerCase().replace(".slickplan.com","")+".slickplan.com"}),t.subscribe("upload/files_added_pluploadbtn",function(t,i,a,s){o.clearErrors(),n.clearAll(),e("#custom-right > .input > .loading").length?e("#custom-right > .input > .loading").css({visibility:"visible"}):e(".input.logochang > .loading").css({visibility:"visible"}),r=i,r.start()}),t.subscribe("upload/file_uploaded_pluploadbtn",function(t,i,a,o,s){o.success?(e("#header .logo.logo-img a img, #image-form-companylogo").attr("src",o.file_path).removeClass("isloading"),e("#custom-right > .input > .loading").length?e("#custom-right > .input > .loading").css({visibility:"hidden"}):e(".input.logochang > .loading").css({visibility:"hidden"}),o.success.length>1&&n.success(o.success)):o.error&&n.error(o.error),r=i,r.refresh()}),t.subscribe("upload/error_pluploadbtn",function(a,l,c,d){switch(c.message){case"File extension error.":c.message=t.__("Can't upload {1}. Only image files (JPG, PNG, GIF) are allowed",c.file.name);break;case"File size error.":var u=s.humanReadableFileSize(e(d).data("maxsize"));c.message=t.__("Can't upload {1}. Maximum file size: {2}",c.file.name,u)}n.error(t.__("An error occurred")),o.error(t.$main.find(".input.logochang"),c.message,i,i,-270),r=l,r.refresh()})}else{var l=t.__('<a href="{1}">Upgrade</a> to brand your account with custom colors and logo',a.get("payment_url","#"));t.$main.on("click",'label[for="form-darkfont"], label[for="form-uselogo1"], label[for="form-uselogo2"], #uploadblocked, #colordefault, #colorinput, #colorpicker.disabled',function(t){return"object"===e.type(t)&&"function"===e.type(t.preventDefault)&&t.preventDefault(),n.error(l),!1})}})}),Slickplan.module(function(e,t,i){t.subscribe("route/account/users",function(){var i=t.require("form"),a=t.require("websocket"),o=t.require("notification"),n=t.require("config"),s=t.require("string"),r=n.get("account"),l=[],c=function(e,t){for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1};t.$main.on("click","#letters a",function(t){t.preventDefault();var i=e(this),a=i.text().toUpperCase();if("ALL"===a)l=[];else if(i.parent().hasClass("inactive")||0==l.length)i.addClass("filter").parent().removeClass("inactive"),l.push(a);else{i.removeClass("filter");for(var o=[],n=0;n<l.length;n++)"string"===e.type(l[n])&&l[n]!==a&&o.push(l[n]);l=o}var s=e("#letters");l.length?(s.find("li.all").addClass("active").end().find("a").not(".filter").parent().not(".all").addClass("inactive"),e("#usersbox > *").not(":last").each(function(){var t=e(this);c(l,e.trim(t.children("span").filter(":first").text()).charAt(0).toUpperCase())||c(l,e.trim(t.children("span").filter(":last").text()).charAt(0).toUpperCase())?t.show():t.hide()})):(s.find("li.all").removeClass("active").end().find("a").removeClass("filter").parent().removeClass("inactive"),e("#usersbox > *").not(":last").show())}),t.$body.on("click","#usersbox a.delete",function(t){if(t.preventDefault(),!confirm("Are you sure you want to delete this user?"))return!1;var i=e(this).parent("div"),s=!i.hasClass("notactive");a.request({data:{"delete":i.data("id")},success:function(t){t.error?o.error(t.error):(i.animate({opacity:0},400,function(){e(this).animate({width:0,padding:0},250,function(){e(this).remove()})}),--r.contributors,s&&--r.active_contributors,n.set("account",r))}})}).on("submit","#modal-add-user form",function(l){l.preventDefault(),a.clearAll();var c=e(this),d=e("#mform-add-first-name"),u=e("#mform-add-last-name"),p=e("#mform-add-email"),m=e("#mform-add-password");i.clearErrors(c);var f=[{value:d.val(),tiperror:d.parent(),rules:{empty:"First Name must not be empty"},css:{bottom:5},left:11},{value:u.val(),tiperror:u.parent(),rules:{empty:"Last Name must not be empty"},css:{bottom:5}},{value:p.val(),tiperror:p.parent(),rules:{empty:"Email must not be empty",email:"Email is not valid"},css:{bottom:5},left:11}];m.val()&&f.push({value:m.val(),tiperror:m.parent(),rules:{length:[6,"Password must be at least 6 characters"]},css:{bottom:5}});var h=i.validate(f);if(h){var g=i.serializeObject(c);g.modal=1,a.request({data:g,$loading:c.find(".loading").css({visibility:"visible"}),success:function(a){if(a.errors)a.errors.first_name&&i.error(d.parent(),a.errors.first_name,{bottom:5}),a.errors.last_name&&i.error(u.parent(),a.errors.last_name,{bottom:5}),a.errors.email&&i.error(p.parent(),a.errors.email,{bottom:5});else{var l=e("<div />").data("id",a.id).data("email",a.email).html("<span>"+s.charsEncode(d.val())+"</span> <span>"+s.charsEncode(u.val())+'</span><a href="#" class="delete">Delete</a><a href="#" class="edit">Edit</a>');a.admin&&l.addClass("admin"),l.addClass("contrib-box new-user").prependTo("#usersbox"),setTimeout(function(){l.removeClass("new-user")},5e3),c.closest(".modal").dialog("close"),o.success(t.__("New user created. Login credentials have been sent to their email")),++r.contributors,++r.active_contributors,n.set("account",r)}},error:function(e,t,i){c.closest(".modal").dialog("close")}})}}).on("click","a.edit",function(t){t.preventDefault();var i=e(this).parent("div");e("#modal-edit-user.modal").find("#mform-edit-first-name").val(i.children("span").filter(":first").text()).end().find("#mform-edit-last-name").val(i.children("span").filter(":last").text()).end().find("#mform-edit-email").val(i.data("email")).end().find("#mform-edit-user-id").val(i.data("id")).end().find("#mform-edit-password").val("").end().find("#mform-edit-user-type").prop("checked",i.hasClass("admin")).change().end().find("#mform-edit-active").prop("checked",!i.hasClass("notactive")).change().end().dialog("open").find("input").filter(":first").focus()}).on("submit","#modal-edit-user form",function(n){n.preventDefault(),a.clearAll();var s=e(this),r=e("#mform-edit-first-name"),l=e("#mform-edit-last-name"),c=e("#mform-edit-email"),d=e("#mform-edit-password"),u=e("#mform-edit-active");i.clearErrors(s);var p=[{value:r.val(),tiperror:r.parent(),rules:{empty:"First Name must not be empty"},css:{bottom:5},left:11},{value:l.val(),tiperror:l.parent(),rules:{empty:"Last Name must not be empty"},css:{bottom:5}},{value:c.val(),tiperror:c.parent(),rules:{empty:"Email must not be empty",email:"Email is not valid"},css:{bottom:5},left:11}];d.val()&&p.push({value:d.val(),tiperror:d.parent(),rules:{length:[6,"Password must be at least 6 characters"]},css:{bottom:5}});var m=i.validate(p);if(m){var f=i.serializeObject(s);f.modal=1,a.request({data:f,$loading:s.find(".loading").css({visibility:"visible"}),success:function(a){if(a.error)s.closest(".modal").dialog("close"),o.error(a.error);else if(a.errors)a.errors.first_name&&i.error(r.parent(),a.errors.first_name,{bottom:5}),a.errors.last_name&&i.error(l.parent(),a.errors.last_name,{bottom:5}),a.errors.email&&i.error(c.parent(),a.errors.email,{bottom:5}),a.errors.active&&i.error(u.parent(),a.errors.active,{bottom:110},null,-18);else{var n=e("#usersbox div#userb-"+e("#mform-edit-user-id").val());n.addClass("contrib-box new-user").data("email",c.val()),n.children("span:first").text(r.val()),n.children("span").filter(":last").text(l.val()),setTimeout(function(){n.removeClass("new-user")},5e3),s.find("#mform-edit-user-type").prop("checked")?n.addClass("admin"):n.removeClass("admin"),u.prop("checked")?n.removeClass("notactive"):n.addClass("notactive"),s.closest(".modal").dialog("close"),o.success(t.__("User updated"))}},error:function(e,t,i){s.closest(".modal").dialog("close")}})}}).on("click",'#usersbox > a, #main button[data-modal="add-user"]',function(e){var i=parseInt(t.currentUserCan("contributors",!0),10);return 0===i||i>0&&r.active_contributors>=i?(e.preventDefault(),e.stopPropagation(),o.error(t.__('<a href="{1}">Upgrade</a> your account to add '+(0===i?"":"more ")+"users",n.get("payment_url","#"))),!1):void 0})})}),Slickplan.module(function(e,t,i){t.subscribe("route/account/messages",function(){function i(t){var i=t.find("textarea").data("formatting").toString().split(" ");e("#modal-formatting table tr + tr").hide();for(var a=0;a<i.length;++a)e("#modal-formatting table tr."+i[a]).show()}"object"===e.type(e.ui)&&"undefined"!==e.type(e.ui.tabs)&&e("#manage-messages").tabs({activate:function(e,t){i(t.newPanel)},create:function(e,t){i(t.panel)}}),t.$main.on("click","#manage-messages button.todefault",function(t){t.preventDefault(),e(this).closest("div").find("textarea[data-default]").each(function(){e(this).val(e(this).data("default"))})})})}),Slickplan.module(function(e,t,i){t.subscribe("route/account/payment route/squeeze",function(i){var a,o=t.require("ajax"),n=t.require("config"),s=t.require("form"),r=t.require("http"),l=t.require("notification"),c="route/squeeze"===i.type,d=(n.get("account"),n.get("plans")),u=e(".ccard-new > .plan"),p=t.$main.find("form").filter(":first");if(c){var m=e(".ccard-new form"),f=e("#freeform"),h=f.find('input[name="form[free]"]');p=m}var g=function(t){u.find("h2").text(d[t].name);for(var i=d[t].meta.description.split("\n"),a="",o=0,n=i.length;n>o;++o){i[o]=e.trim(i[o]);var s=i[o].substr(0,1);i[o]=e.trim(i[o].substr(1)),a+='<li><i class="fa fa-fw fa-'+("+"===s?"check":"times")+'"></i> '+i[o]+"</li>"}u.find("ul").html(a);var r,l="";d[t].meta.price_original&&d[t].meta.price_original>d[t].meta.price?(l+='<del class="price-wrap">$'+d[t].meta.price_original.toFixed(2)+"</del>",l+='<ins class="price-wrap">$'+d[t].meta.price.toFixed(2)+"</ins>"):l+='<b class="price-wrap">$'+d[t].meta.price.toFixed(2)+"</b>",u.find(".monthly .price").html(l),l="",d[t].meta.price_annual_original&&d[t].meta.price_annual_original>d[t].meta.price_annual?(r=Math.round(12*d[t].meta.price_annual_original*100)/100,l+='<del class="price-wrap">$'+r.toFixed(2)+"</del>",r=Math.round(12*d[t].meta.price_annual*100)/100,l+='<ins class="price-wrap">$'+r.toFixed(2)+"</ins>"):(r=Math.round(12*d[t].meta.price_annual*100)/100,l+='<b class="price-wrap">$'+r.toFixed(2)+"</b>"),u.find(".yearly .price").html(l)};c&&t.$body.on("click","a[data-planid]",function(t){t.preventDefault(),l.clearAll(),s.clearErrors(m);var i=parseInt(e(this).data("planid"),10),o=a=e(this);if(1===i){if(o.hasClass("disabled"))return!1;o.addClass("disabled").html('<i class="fa fa-refresh fa-spin"></i>'),f.trigger("submit")}else d&&d[i]&&e("html, body").stop().animate({scrollTop:150},300,"easeOutCubic",function(){u.stop().animate({opacity:0},150,function(){g(i),p.find('input[name="form[type]"]').val(i).data("type",i),h.val(0),e("#squeeze").removeClass("no-hide").removeClass(function(e,t){return(t.match(/(^|\s)current-plan-[0-9]+/g)||[]).join(" ")}).addClass("current-plan-"+i),e("#pricing").children(".plan").length<=3&&e("#squeeze").addClass("no-hide"),u.stop().animate({opacity:1},150)})})}),t.$body.on("submit","form.payment-form",function(i){i.preventDefault(),l.clearAll(),o.clearAll();var n=c?"freeform"===this.id&&"object"===e.type(a)&&a instanceof e&&a.length:!1;p=e(this),s.clearErrors(p);var u=!0,m={},f=parseInt(p.find('input[name="form[type]"]').val(),10);if(!f||!d[f])return l.error(t.__("Select a plan"),m),!1;if(c||(n=1===f),!n){var h=e("#form-ccname"),g=e("#form-ccnumber"),v=e("#form-cvv"),b=e("#form-zip"),_=[{value:h.val(),tiperror:h.parent(),rules:{empty:"Name on Card must not be empty"},css:{bottom:7},left:12},{value:v.val(),tiperror:v.parent(),rules:{empty:"Security Code must not be empty",regexp:[/^[0-9]{3,4}$/,"Invalid Security Code"]},css:c?{bottom:7,left:151}:{bottom:-29,left:-53},bottom:c?0:10},{value:b.val(),tiperror:b.parent(),rules:{empty:"Zip/Postal Code must not be empty"},css:{bottom:-29,left:-43},bottom:10}],y=g.data("original");y&&y===g.val()||_.push({value:g.val(),tiperror:g.parent(),rules:{empty:"Credit Card number must not be empty",callback:[s.ccValidation,"Invalid credit card number"]},css:{bottom:7},left:12}),delete y,u=s.validate(_);var w=parseInt(e("#form-expyear").val(),10),C=parseInt(e("#form-expmonth").val(),10);w&&C||(s.error(e("#form-expdate"),"You must select an expiration date",{bottom:9,left:235},!1,12),u=!1)}if(u){c&&!n?p.find('button[type="submit"]').html('<i class="fa fa-refresh fa-spin"></i>'):c||p.find('.submit input[type="submit"]').hide();var k=[{name:"ajax",value:1}];c&&k.push({name:"form[squeeze]",value:1});var x=s.serializeObject(p,k);o.request({url:p.attr("action"),data:x,$loading:c?null:p.find(".submit > .loading").css({visibility:"visible"}),success:function(i){if(c?n?a.text("Select & Continue").removeClass("disabled"):p.find('button[type="submit"]').html("Continue"):p.find('.submit input[type="submit"]').show(),i.redirect)r.redirect(i.redirect);else if(i.errors)e.each(i.errors,function(e,t){s.error(p.find('input[name="form['+e+']"]').parent("div"),t)}),m.under=p.find(".ccard-choser"),l.error(t.__("An error occured"),m);else if(i.error)if(i.bytes_to_archive)t.publish("account/archive_dialog",["storage",i.bytes_to_archive]);else if(i.storage_remove)t.publish("account/archive_dialog",["storage",!0]);else if(i.archive_sitemaps)t.publish("account/archive_dialog",["sitemaps",i.archive_sitemaps]);else if(i.archive_users)t.publish("account/archive_dialog",["contributors",i.archive_users]);else{m.under=p.find(".ccard-choser");var o=i.error;i.is_external&&(o=o.replace(/([\.]+)$/,"")+'. Need&nbsp;Help?&nbsp;<a href="#" data-modal="feedback" data-modalclass="paymenterr">Contact&nbsp;Support</a>',window.SLICKPLAN_PAYMENT_ERROR=i.log||null),l.error(o,m)}else c&&i.success&&r.redirect("/dashboard")},error:function(){c?n?a.text("Select & Continue").removeClass("disabled"):p.find('button[type="submit"]').html("Continue"):p.find('.submit input[type="submit"]').show()}})}else m.under=p.find(".ccard-choser"),l.error(t.__("An error occured"),m),c&&"object"===e.type(a)&&a instanceof e&&a.length&&a.text("Select & Continue")}).on("change","input, select",function(){if(s.clearErrors(e(this).parent()),"form-ccnumber"===this.id){var i=s.ccValidation(this.value);i?t.$main.find("#form-cctype"+i).prop("checked",!0):t.$main.find(".ccard-choser").children('input[type="radio"]').prop("checked",!1)}}),c?t.$body.on("click","#squeeze-info-fixed .close",function(t){t.preventDefault(),e("#squeeze-info-fixed").remove()}):t.$body.on("click",".plan-row",function(){l.clearAll();var t=e(this),i=parseInt(t.data("planid"),10);d[i]&&(t.addClass("selected").siblings(".selected").removeClass("selected"),p.find('input[name="form[type]"]').val(i),1===i?e("#payment-form").hide():(e("#payment-form").show(),g(i)))}).find(".plan-row.selected").trigger("click"),e("#interval-button").on("click",".year, .month",function(){var t=e(this),i=t.hasClass("year")?"year":"month";t.parent().closest(".month, .year").removeClass("month year").addClass(i),t.siblings('input[type="checkbox"]').prop("checked","year"===i).trigger("change")}).find('input[type="checkbox"]').trigger("change").end().disableSelection(),t.$body.on("click","#ccard-chooser > input + label",function(e){e.preventDefault()}),t.subscribe("modal/archive/archived",function(){p.trigger("submit")})})}),Slickplan.module(function(e,t,i){t.subscribe("route/account/preferences",function(){"object"===e.type(e.ui)&&"undefined"!==e.type(e.ui.draggable)&&e(".switch > input + label").append("<div />").children("div").draggable({containment:"parent",axis:"x",grid:[41,41],drag:function(e,t){t.helper.parent("label").prev("input").prop("checked",t.position.left>20)}}),t.$main.on("change",'fieldset.basecamp input[name="form[basecamp_version]"]',function(){0===parseInt(this.value,10)?e(this).closest("fieldset").addClass("classic"):e(this).closest("fieldset").removeClass("classic")})})}),Slickplan.module(function(e,t,i){t.subscribe("route/account/settings route/account/index",function(){var i,a,o=t.require("config"),n=t.$main.filter(".account-settings").find("select");n.selectmenuslickplan("destroy"),n.selectmenuslickplan({style:"popup",maxHeight:400,format:function(e){return t.require("string").charsEncode(e)}}),t.$main.on("click","#deleteavatar",function(t){t.preventDefault(),i&&e("#image-form-avatar").attr("src",i).removeClass("isloading"),e(this).hide(),e("#new-avatar").val("0"),a&&a.refresh()}),t.subscribe("upload/files_added_pluploadbtn",function(n,s){var r=t.require("form"),l=t.require("notification");r.clearErrors(),l.clearAll(),i=e("#user-box img").attr("src"),e("#image-form-avatar").attr("src",o.get("statics_path")+"img/loading_small.gif").addClass("isloading"),a=s,a.start()}),t.subscribe("upload/file_uploaded_pluploadbtn",function(i,o,n,s){if(s.success&&(e("#new-avatar").val(s.file_id),e("#image-form-avatar").attr("src",s.file_path).removeClass("isloading"),e("#deleteavatar").show(),s.success.length>1)){var r=t.require("notification");r.success(s.success)}a=o,a.refresh()}),t.subscribe("upload/error_pluploadbtn",function(o,n,s,r){var l=t.require("form"),c=t.require("notification");i&&e("#image-form-avatar").attr("src",i).removeClass("isloading"),c.error(t.__("An error occurred")),l.error(e(r).closest(".input"),s.message),a=n,a.refresh()}),t.subscribe("account/settings_saved",function(i,a,n){if(a&&a[1]&&"settings"===a[1]&&n&&n.form){var s=t.require("websocket"),r=o.get("account").subdomain;if("function"===e.type(s.getSession)&&r){var l=s.getSession();l&&"object"===e.type(l)&&"undefined"!==e.type(l.publish)&&l.publish("account_data_changed_"+r,{user_id:o.get("user_id"),first_name:n.form.first_name,last_name:n.form.last_name,username:n.form.username,email:n.form.email,avatar:n.form.avatar,subdomain:r})}}})})}),Slickplan.module(function(e,t,i){t.subscribe("route/account/index route/account/settings route/account/preferences route/account/company route/account/messages route/account/close",function(i){t.$main.find("input[data-loading]").each(function(){var t=new Image;t.src=e(this).data("loading")});var a=t.require("form"),o=t.require("http"),n=t.require("notification"),s=t.require("websocket"),r=i.type;t.$main.find(".submit").append('<div class="loading" />').end().on("submit","form",function(i){i.preventDefault(),s.clearAll();var l=e(this);a.clearErrors(l);var c=[];l.find('.switch > input[type="checkbox"]:not(:checked)').each(function(){c.push({name:e(this).attr("name"),value:0})});var d=a.serializeObject(l,c);d.ajax=1,s.request({url:o.url(l.attr("action")),data:d,$loading:l.find(".submit > .loading").css({visibility:"visible"}),success:function(i){if(l.find('.submit input[type="submit"]').show(),i.redirect)o.redirect(i.redirect);else if(i.errors)e.each(i.errors,function(e,t){a.error(l.find('input[name="form['+e+']"]').parent("div"),t)}),n.error(t.__("An error occured"));else if(i.error)n.error(i.error);else{if(t.$main.hasClass("account-settings")&&e("#form-firstname").length){var s=e("#user-box");s.children("p").filter(":first").text(e("#form-firstname").val()+" "+e("#form-lastname").val()),s.find("img").attr("src",e("#image-form-avatar").attr("src"))}n.success(i.success.length>5?i.success:t.__("New settings saved")),t.publish("account/settings_saved",[r,d])}},error:function(){l.find('.submit input[type="submit"]').show()}})}).on("change","input, select",function(){a.clearErrors(e(this).parent())})})}),Slickplan.module(function(e,t,i){t.subscribe("route/configure",function(){var a=t.require("form"),o=t.require("websocket"),n=t.require("http"),s=t.require("notification"),r=t.require("scrollbar"),l=e("#customize-wrapper"),c=l.height();e("#customize").show(),l.hide(),e("#customize").on("click",function(t){t.preventDefault(),e(this).hide(),l.show().css({opacity:0,height:0}).animate({opacity:1,height:c},400),e("html, body").animate({scrollTop:1100},400)}),t.$main.on("submit","form",function(i){i.preventDefault(),o.clearAll();var l=e(this);a.clearErrors(l);var c=e("#form-first-name"),d=e("#form-last-name"),u=e("#form-username"),p=e("#form-company-name"),m=e("#form-subdomain");m.val(e.trim(m.val().toLowerCase().replace(".slickplan.com","")));var f=a.validate([{value:d.val(),tiperror:d.parent(),rules:{empty:t.__("First/Last Name must not be empty")}},{value:c.val(),tiperror:d.parent(),rules:{empty:t.__("First/Last Name must not be empty")}},{value:u.val(),tiperror:u.parent(),rules:{empty:t.__("Username must not be empty")}},{value:p.val(),tiperror:p.parent(),rules:{empty:t.__("Company Name must not be empty")},css:{bottom:56}},{value:m.val(),tiperror:m.parent(),rules:{empty:t.__("URL must not be empty"),alnum:t.__("URL can contain only letters and/or numbers"),is:["www",t.__('URL must not contain "{1}"',"www")],is:["help",t.__('URL must not contain "{1}"',"help")],is:["campusuite",t.__('URL must not contain "{1}"',"campusuite")]},css:{left:"59%"}}]);if(f&&e("fieldset.existing").length){var h=parseInt(e("fieldset.existing").data("sitemaps"),10),g=parseInt(e('input[name="form[account_type]"]:checked').data("sitemaps"),10);if(h>g)return g=h-g,e(".modal").dialog("close"),e("#modal-archive.modal form").each(function(){this.reset()}),e("#modal-archive.modal").data("limit",g).dialog("open"),e("#modal-archive h1 span").html(g),r.init(e("#modal-archive.sitemaps-scroll .table-scroll"),{thumbSize:64}),rowShadow(),!1}f?o.request({data:a.serializeObject(l),$loading:l.find(".submit .loading").css({visibility:"visible"}),success:function(t){t.errors?(t.errors.first_name&&a.error(c.parent(),t.errors.first_name,{left:"49%"}),t.errors.last_name&&a.error(d.parent(),t.errors.last_name),t.errors.username&&a.error(u.parent(),t.errors.username),t.errors.company_name&&a.error(p.parent(),t.errors.company_name,{bottom:56}),t.errors.coupon&&a.error(e("#form-coupon").parent(),t.errors.coupon,{bottom:30}),t.errors.subdomain&&a.error(m.parent(),t.errors.subdomain,{left:"59%"}),s.error("Errors occurred. Fill in all fields marked below.")):t.redirect&&n.redirect(t.redirect)}}):s.error(t.__("Errors occurred. Fill in all fields marked below."))}).on("focus","input, button",function(){var t=e(this).closest(".input").data("fieldset");t=t?t:"default";var i=e("fieldset.info."+t);i.length&&i.show().siblings(".info").hide()}).on("click","fieldset.existing > div",function(){e("fieldset.existing > div").removeClass("checked");var t=e(this).addClass("checked").find("input").prop("checked",!0).val();2>=t?e("fieldset.footer").hide():e("fieldset.footer").show()}).on("change","#form-darkfont",function(){e(this).is(":checked")?t.$body.addClass("darkFont"):t.$body.removeClass("darkFont")}).on("click","#pluploadbtn2",function(t){e("#pluploadbtn").parent().find('input[type="file"]').trigger("click")});var d;t.subscribe("upload/files_added_pluploadbtn",function(i,a,o,n){var s=t.require("form"),r=t.require("notification");s.clearErrors(),r.clearAll(),e("#custom-right > .input > .loading").length?e("#custom-right > .input > .loading").css({visibility:"visible"}):e(".input.logochang > .loading").css({visibility:"visible"}),d=a,d.start()}),t.subscribe("upload/file_uploaded_pluploadbtn",function(i,a,o,n,s){if(n.success&&(e("#hidden-upload-input").val(n.file_id),e("#image-form-companylogo").attr("src",n.file_path).removeClass("isloading"),e("#custom-right > .input > .loading").length?e("#custom-right > .input > .loading").css({visibility:"hidden"}):e(".input.logochang > .loading").css({visibility:"hidden"}),n.success.length>1)){var r=t.require("notification");r.success(n.success)}d=a,d.refresh()}),t.subscribe("upload/error_pluploadbtn",function(a,o,n,s){var r=t.require("form"),l=t.require("notification");l.error(t.__("An error occurred")),r.error(e("#custom-right > .input"),n.message,i,i,-270),d=o,d.refresh()})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap route/dashboard",function(){function a(t){var i=m+"s",a=e(".usersbox."+i),o=e('<div class="contrib-box '+m+(t.approval?" approval":"")+(t.locking?" admin":"")+(t.admin?" admintype":"")+' new-user" id="box-contributor-'+t.value+'" data-first="'+p.charsEncode(t.first_name)+'" data-last="'+p.charsEncode(t.last_name)+'" data-email="'+p.charsEncode(t.email)+'" title="'+p.charsEncode(t.email)+'">                <span>'+t.first_name+" "+t.last_name+'</span>                <a href="#" class="delete">delete</a>                <a href="#" class="edit" data-topmodal="edit-contributor" data-id="'+t.value+'">edit</a>                <input type="hidden" name="form['+i+'][]" value="'+t.value+'">                <input type="hidden" name="form[admin][]" value="'+(t.locking?t.value:0)+'">                <input type="hidden" name="form[approval][]" value="'+(t.approval?t.value:0)+'">                </div>');a.prepend(o),setTimeout(function(){o.removeClass("new-user")},3600),n(),s()}function o(){var o=e(this),n=o.closest("form"),s=o.closest(".top-modal"),l=o.closest("form").find(".autocomplete-placeholder");o.autocomplete({source:function(t,i){var a=u.get("users_list",{}),o=u.get("user_id",0),n=[];e.each(a,function(e,t){e!=o&&(t.owner||t.active)&&n.push(t)});for(var s=e.ui.autocomplete.filter(n,t.term),r=[],l=e("#modal-create-sitemap, #modal-contributors").find('input[name^="form[editors]"], input[name^="form[viewers]"]'),c=0,d=s.length;d>c;++c)l.filter('[value="'+s[c].value+'"]').length||r.push(s[c]);i(r)},delay:0,cancelBlur:!0,appendTo:l,open:function(a,n){o.off("blur");var s=l.find(".ui-autocomplete").filter(":visible").css({left:0,top:"+=10px"}).quickOuterHeight()||0;l.css({height:s}).addClass("opened"),l.find(".tip-error").remove(),l.find("li.ui-menu-item").each(function(){var a=e(this).removeClass("admin"),o=e.trim(a.text());o=o.replace(/\s([^\s]+@[^\s]+)$/," <span>$1</span>"),a.html(o);var n=a.data("ui-autocomplete-item");"viewer"===m&&n&&n.type&&9===parseInt(n.type,10)&&(a.removeClass("ui-menu-item").addClass("ui-menu-item-disabled admin"),a.off().on("click",function(e){l.find(".tip-error").remove(),r.error(a.closest(".autocomplete-placeholder"),t.__("Admins can be added as editors only"),{top:a.position().top+a.quickOuterHeight()-30},i,10)}))})},close:function(e,t){l.find(".tip-error").remove(),l.css({height:0}).removeClass("opened")},select:function(e,t){return"viewer"===m&&9===parseInt(t.item.type,10)?!1:(a({first_name:t.item.first_name,last_name:t.item.last_name,email:t.item.email,value:t.item.value,locking:n.find("#tm-sitemap-admin-check").is(":checked"),approval:n.find("#tm-sitemap-approval-check").is(":checked"),admin:9===parseInt(t.item.type,10)}),void s.dialog("close"))}})}function n(t){t=t||[".usersbox.viewers",".usersbox.editors"];for(var i=0;i<t.length;i++)e(t[i]).html(e(t[i]+" > div").get().sort(function(t,i){return t=e(t).find("span").text().toLowerCase(),i=e(i).find("span").text().toLowerCase(),i>t?-1:t>i?1:0}))}function s(){e(".contrib-box").not(".notactive").each(function(){var t=e(this);t.draggable({revert:"invalid",appendTo:t.closest("form"),containment:t.closest(".ui-dialog"),scroll:!1,helper:"clone",start:function(){t.addClass("temp-hide")},stop:function(){t.removeClass("temp-hide")}})})}var r=t.require("form"),l=t.require("websocket"),c=t.require("http"),d=t.require("notification"),u=t.require("config"),p=t.require("string"),m="viewer",f=0;s(),e(".usersbox").each(function(){var t=e(this);t.droppable({activeClass:"drop-active",accept:t.hasClass("viewers")?".usersbox.editors .contrib-box:not(.admintype)":".usersbox.viewers .contrib-box",drop:function(t,i){var a=e(this);if(a.find('input[value="'+i.draggable.find('input[name^="form[editors]"], input[name^="form[viewers]"]').filter(":first").val()+'"]').length)return i.draggable.removeClass("ui-draggable-dragging new-user").css("left","").css("top",""),!1;var o=a.hasClass("viewers")?"viewers":"editors",r=i.draggable.clone().removeClass("ui-draggable-dragging new-user").css("left","").css("top","").find('input[name^="form[editors]"], input[name^="form[viewers]"]').attr("name","form["+o+"][]").end();"viewers"===o&&r.removeClass("admin").find('input[name^="form[admin]"]').val(0),i.draggable.remove(),r.removeClass("temp-hide"),a.append(r),n(),s()}}),t.on("click","a.delete",function(t){t.preventDefault();var i=e(this).closest("div");i.hasClass("notactive")?i.css({opacity:.5}).removeClass("notactive").animate({opacity:0},400,function(){i.remove()}):i.animate({opacity:0},400,function(){i.remove()})})}),e('#topmodal-add-contributor input[type="text"]').each(o),t.$body.on("submit","#topmodal-add-contributor form",function(e){e.preventDefault()}).on("submit","#topmodal-add-new-contributor form, #topmodal-edit-contributor form",function(i){i.preventDefault(),l.clearAll();var n=e(this);r.clearErrors(n);var s=n.find('input[name*="[first_name]"]'),d=n.find('input[name*="[last_name]"]'),h=n.find('input[name*="[email]"]'),g=r.validate([{value:s.val(),tiperror:s.parent(),rules:{empty:"First Name must not be empty"}},{value:d.val(),tiperror:d.parent(),rules:{empty:"Last Name must not be empty"}},{value:h.val(),tiperror:h.parent(),rules:{empty:"Email must not be empty",email:"Email is not valid"}}]);if(g){var v=n.closest(".top-modal"),b=r.serializeObject(n),_=!1;b.modal=1,(t.$main.hasClass("dashboard")||t.$main.hasClass("sitemap"))&&(b.dash=1),b.add?(b.add.type=m,b.add.user_id=f):b.edit&&(_=!0,b.edit.type=m,b.edit.user_id=f),l.request({url:c.url(n.attr("action")),data:b,$loading:n.find(".loading").css({visibility:"visible"}),success:function(t){if(t.errors)t.errors.first_name&&r.error(s.parent(),t.errors.first_name),t.errors.last_name&&r.error(d.parent(),t.errors.last_name),t.errors.email&&r.error(h.parent(),t.errors.email);else if(t.id){var i=s.val()+" "+d.val();_&&e("#box-contributor-"+t.id).remove(),a({first_name:s.val(),last_name:d.val(),email:h.val(),value:t.id,admin:_?n.find("#tme-sitemap-admin-check").is(":checked"):n.find("#tmn-sitemap-admin-check").is(":checked"),approval:_?n.find("#tme-sitemap-approval-check").is(":checked"):n.find("#tmn-sitemap-approval-check").is(":checked")}),v.dialog("close");var l=u.get("users_list",{});_&&l[t.id]||(l[t.id]={first_name:s.val(),last_name:d.val(),email:h.val(),name:i,label:i+" "+h.val(),value:t.id,active:1}),u.set("users_list",l),e('#topmodal-add-contributor input[type="text"]').each(o),f=0,e("#share-email .recipients").append('                                    <div class="checkbox border">                                        <input type="checkbox" id="form-recipient-'+t.id+'" name="recipients[]" value="'+p.charsEncode(h.val())+'">                                        <label for="form-recipient-'+t.id+'">'+p.charsEncode(i)+"</label>                                    </div>                                "),e("#share-email .recipients > .checkbox").removeClass("first").filter(":nth-child(3n)").addClass("first")}},error:function(e,t,i){v.dialog("close")}})}}).on("submit","#modal-contributors > form",function(i){i.preventDefault(),l.clearAll();var a=e(this),o=a.closest(".modal"),n=r.serializeObject(a);l.request({data:n,$loading:a.find(".loading").css({visibility:"visible"}),success:function(i){o.dialog("close"),d.success(t.__("Contributors updated successfully")),
    u.get("all_privileges",!1)&&(e("#sitemap-menu #action-approve").remove(),e("#modal-contributors .usersbox > .approval").length||e("#sitemap-menu a.text.close").closest("li").before('<li><a href="#" class="text icon approve" id="action-approve">Approve Sitemap</a></li>')),i&&i.contributors&&i.contributors.length&&t.publish("sitemap/contributors_changed",[i.contributors])},error:function(e,t,i){o.dialog("close")}})}),t.subscribe("top_modal/open/topmodal-add-contributor",function(t,i){i.find(".autocomplete-placeholder").css({height:0}).removeClass("opened").find("ul").empty(),e("#modal-create-sitemap, #modal-contributors").find("div.approval").length?i.addClass("no-approval"):i.removeClass("no-approval")}),t.subscribe("top_modal/open/topmodal-add-new-contributor",function(t,i){e("#modal-create-sitemap, #modal-contributors").find("div.approval").length?i.addClass("no-approval"):i.removeClass("no-approval")}),t.subscribe("top_modal/after_open/topmodal-add-contributor",function(t,i,a){m=a.data("type"),"editor"!==m&&"viewer"!==m&&(m="viewer"),e("#topmodal-add-contributor, #topmodal-add-new-contributor").removeClass("type-editor type-viewer").addClass("type-"+m)}),t.subscribe("top_modal/after_open/topmodal-edit-contributor",function(t,i,a){var o=a.closest("div");f=parseInt(a.data("id"),10),m=a.closest(".usersbox").hasClass("editors")?"editor":"viewer",e("#topmodal-edit-contributor").removeClass("type-editor type-viewer").addClass("type-"+m),e("#form-econtributor-firstname").val(o.data("first")),e("#form-econtributor-lastname").val(o.data("last")),e("#form-econtributor-email").val(o.data("email")),e("#tme-sitemap-admin-check").prop("checked",10*o.find('input[type="hidden"][name^="form[admin]"]').val()>0).trigger("change"),e("#tme-sitemap-approval-check").prop("checked",10*o.find('input[type="hidden"][name^="form[approval]"]').val()>0).trigger("change");var n=e("#modal-create-sitemap, #modal-contributors").find("div.approval"),s=parseInt(n.find(".edit").data("id"),10);n.length&&f!==s?i.addClass("no-approval"):i.removeClass("no-approval")})})}),Slickplan.module(function(e,t,i){t.subscribe("route/dashboard",function(){function i(){t.$main.find("input:checkbox").each(function(){var i=e(this);i.is(":checked")&&i.closest("tr").addClass("active"),i.change(function(){t.$main.find("tr").removeClass("active").end().find("input:checkbox:checked").closest("tr").addClass("active")})})}function a(){t.$body.children(".loading").remove();var i=t.$main.find("tbody");e('<div class="loading" />').css({width:i.width(),height:i.height(),top:i.offset().top,left:i.offset().left}).appendTo(t.$body)}function o(e,i){r.clearAll(),a();var o=t.$main.find('.top input[name="search"]').val();r.request({data:{AJAX:1,page:e,order:[m.data("orderby"),m.data("orderdir")],search:"SEARCH SITEMAPS"===o?"":o},dataType:"html",success:i,error:function(e,i,a){t.$body.children(".loading").remove()}})}function n(){var i=e(this).hasClass("ui-version")?e(this).closest("tr"):e(this),a=i.find("select").val();if(i.find("td.dashrow").length)var o=i.find("td.dashrow > a").attr("href").split("/");else var o=i.find(".checkbox + a").attr("href").split("/");if(o[o.length-1]=a,i.find(":checkbox").val(a),i.find(".checkbox + a, td.last > a, td.dashrow > a").attr("href",o.join("/")),i.find("span.verspan").hide(),i.find("span.verspan-"+a).show(),"select"===this.tagName.toLowerCase()){var n=i.find(".approved");if(n.length){var s=n.data("version"),r=parseFloat(s),l=parseFloat(e(this).find("option:selected").text());l===r?c.clearAll(!0):c.info(t.__("Version {1} is approved. For assistance contact your sitemap admin.",s))}}}var s=t.require("form"),r=t.require("websocket"),l=t.require("http"),c=t.require("notification"),d=t.require("helper"),u=t.require("config"),p=e("#modal-create-sitemap"),m=e("#sitemaps-table");d.rowShadow(),p.find("div.plainupload > a.button").show(),p.on("click","div.plainupload > a.button",function(t){t.preventDefault(),s.clearErrors(e(this).parent()),e(this).next("input:file").show().focus().trigger("click")}).on("submit","form",function(i){i.preventDefault(),r.clearAll();var a=e(this);s.clearErrors(a),a.find(".input").removeClass("error");var o=e("#form-name"),n=e("#form-version");if(o.val().length){var d=(parseFloat(n.val()),a.closest(".modal")),u=s.serializeObject(a);u.modal=1,r.request({data:u,$loading:a.find(".loading").css({visibility:"visible"}),success:function(e){if(e.success&&e.redirect){if(a.find("input:file").length&&a.find("input:file").val())return a.find('input[type="text"]').removeAttr("name"),a.attr("action",e.redirect),a.find(".usersbox").empty(),a.off("submit"),d.off("submit","form"),void a.trigger("submit");l.redirect(e.redirect)}else e.error&&c.error(e.error);d.dialog("close")},error:function(e,t,i){d.dialog("close")}})}else s.error(o.parent(),t.__("Sitemap name must not be empty"),{bottom:5})}),i(),t.$main.on("click","thead th:not(.right) > a",function(a){a.preventDefault();var s=e(this).attr("href").split("/");s=s[s.length-1].split("-"),m.data("orderby",s[0]).data("orderdir",s[1]),o(1,function(a){a=jQuery("<div />").append(a),t.$body.children(".loading").remove(),t.$main.find(".pagination li").removeClass("current").filter("li.first").next("li").addClass("current"),m.html(a.find("#sitemaps-table").html()),e("ul.pagination").replaceWith(a.find("ul.pagination")),a=null,e("select").selectmenuslickplan({style:"popup",format:function(e){return t.require("string").charsEncode(e)}}),i(),t.$main.find("tbody tr:not(.no-sitemaps)").each(n),t.$main.find("tbody select").change(n)})}).on("click",".pagination a",function(a){var s=e(this).parent("li");return s.hasClass("archive")?!0:s.hasClass("current")?!1:s.hasClass("first")?(t.$main.find(".pagination li.current").prev("li").not(".first").children("a").trigger("click"),!1):s.hasClass("last")?(t.$main.find(".pagination li.current").next("li").not(".last").children("a").trigger("click"),!1):(a.preventDefault(),void o(parseInt(e(this).html(),10),function(a){a=e("<div />").html(a),t.$body.children(".loading").remove(),s.siblings().removeClass("current").end().addClass("current"),m.html(a.find("#sitemaps-table").html()),s.closest("ul").replaceWith(a.find("ul.pagination")),a=null,e("select").selectmenuslickplan({style:"popup",format:function(e){return t.require("string").charsEncode(e)}}),i(),t.$main.find("tbody tr:not(.no-sitemaps)").each(n),t.$main.find("tbody select").change(n),d.rowShadow()}))}).on("click","#delete, #archive, #unarchive",function(i){i.preventDefault(),r.clearAll();var o=[],n=u.get("account");t.$main.find("input:checkbox:checked").each(function(){o.push(e(this).val())});var s=e(this).attr("id");if(!o.length)return c.error(t.__("Select sitemap/s to "+s)),!1;if("unarchive"===s){if(n.sitemaps_limit>-1&&n.sitemaps_count+o.length>n.sitemaps_limit)return c.error(t.__('Your {1} account needs to be <a href="{2}">upgraded</a> before you can unarchive this sitemap',n.name,u.get("payment_url","#"))),!1}else if("delete"===s){var l=!1;if(t.$main.find("input:checkbox:checked").each(function(){return e(this).closest("tr").find('select[name="version"] > option').length>1?(l=!0,!1):void 0}),!l&&!confirm(t.__("Are you sure you want to delete selected sitemaps?")))return!1}var d={AJAX:1};d[s]=o,a(),r.request({data:d,success:function(i){if(t.$body.children(".loading").remove(),"delete"===s&&i.versions){var a=e("#modal-delete"),r=e("#deletemtbl > tr").filter(":first").clone();e("#deletemtbl > tr").remove();for(var l=0;l<i.versions.length;l++){var d=r.clone();d.find("input").attr("id","formdel-ids-"+i.versions[l].id).val(i.versions[l].id).next("label").attr("for","formdel-ids-"+i.versions[l].id).text(i.versions[l].title),d.find("td").filter(":first").next("td").text(i.versions[l].version).next("td").children("div").text(i.versions[l].author),e("#deletemtbl").append(d)}a.dialog("open"),a.height(a.children("form").outerHeight());var p=t.$window.height()-a.outerHeight();return void a.parent().css({top:p>0?p/2:0})}i.success?(e('#dashboard-autocomplete input[type="reset"]').trigger("click"),"unarchive"===s?n.sitemaps_count+=o.length:(n.sitemaps_count-=o.length,n.sitemaps_count<0&&(n.sitemaps_count=0)),u.set("account",n),c.success(t.__("Sitemap"+(o.length>1?"s":"")+" successfully "+s+"d"))):i.error&&alert(i.error)},error:function(e,i,a){t.$body.children(".loading").remove()}})}),e("#modal-delete").on("submit","form",function(i){i.preventDefault(),r.clearAll();var a=e(this).closest(".modal");return e(this).find(":checkbox:checked").length<1?(a.dialog("close"),c.error(t.__("No sitemaps selected to delete.")),!1):void r.request({data:s.serializeObject(e(this)),$loading:e(this).find(".loading").css({visibility:"visible"}),success:function(i){a.dialog("close"),i.success?(e('#dashboard-autocomplete input[type="reset"]').trigger("click"),c.success(t.__("Sitemaps successfully deleted"))):c.error(t.__("An error occured. Please try again later."))},error:function(e,t,i){a.dialog("close")}})}).on("change","#form-select-all",function(){e("#modal-delete td input").prop("checked",this.checked).change()}),t.$main.find("tbody tr:not(.no-sitemaps)").each(n),t.$main.on("change","tbody select",n).on("submit","#dashboard-autocomplete",function(o){o.preventDefault(),r.clearAll();var l=e(this).find('input[name="search"]');a(),l.autocomplete("close");var c=s.serializeObject(e(this));r.request({data:c,dataType:"html",success:function(a){a=jQuery("<div />").append(a),e(".pagination").html(a.find(".pagination").html()),t.$body.children(".loading").remove(),m.html(a.find("#sitemaps-table").html()),a=null,e("select").selectmenuslickplan({style:"popup",format:function(e){return t.require("string").charsEncode(e)}}),i(),t.$main.find("tbody tr:not(.no-sitemaps)").each(n),t.$main.find("tbody select").change(n),e("#dashboard-autocomplete").find('input[type!="text"]').hide().end().find('input[type="'+(c.search?"reset":"submit")+'"]').css({display:"block"})}})}).on("click",'#dashboard-autocomplete input[type="reset"]',function(t){t.preventDefault();var i=e("#dashboard-autocomplete");i[0].reset(),i.trigger("submit")}),m.on("click","a.archived",function(e){e.preventDefault(),c.error(t.__("Unarchive this sitemap to view or make edits"))}),t.$main.find('.top input[name="search"]').each(function(){var t=e(this);t.focus(function(){e(this).parent("form").addClass("focus")}).blur(function(){e(this).parent("form").removeClass("focus")}).autocomplete({delay:0,source:u.get("autocomplete",[]),position:{my:"left-4 top",at:"left bottom",of:t},select:function(){setTimeout(function(){e("#dashboard-autocomplete").trigger("submit")},100)}})})})}),Slickplan.module(function(e,t,i){t.subscribe("route/deal",function(){var i=t.require("form"),a=t.require("ajax"),o=t.require("http"),n=e("#dealpage > form").on("submit",function(e){return e.preventDefault(),!1}),s=n.find('input[name="coupon_code"]');e("#new-user, #existing-user").on("click",function(o){if(o.preventDefault(),e(this).closest(".submit").hasClass("loading"))return!1;a.clearAll(),i.clearErrors(n);var r=i.validate([{value:s.val(),tiperror:s.parent(),rules:{empty:t.__("Offer Code must not be empty")},css:{bottom:30},left:13}]);if(r){var l=this.id.replace("-user","");"new"===l&&"hidden"===e('input[name="coupon_code"]').attr("type")?(e("#registerbox").data("planid",l).stop().css({opacity:0}).show().animate({opacity:1},444),e("#overlay").stop().css({opacity:0}).show().animate({opacity:1},333)):(n.children(".submit").addClass("loading"),a.request({data:{coupon_code:s.val(),user_type:l},success:function(t){t.redirect?window.location=t.redirect:t.success?(e("#registerbox").data("planid",l).stop().css({opacity:0}).show().animate({opacity:1},444),e("#overlay").stop().css({opacity:0}).show().animate({opacity:1},333)):t.error&&(i.error(s.parent("div"),t.error,{bottom:30},!1,13),n.children(".submit").removeClass("loading"))},error:function(){n.children(".submit").removeClass("loading")}}))}}),t.$body.on("click","#registerbox .close",function(t){t.preventDefault(),e("#registerbox").animate({opacity:0},333),e("#overlay").animate({opacity:0},444,function(){e("#overlay, #registerbox").hide()}),n.children(".submit").removeClass("loading")}),t.$body.on("submit","#registerbox > form",function(n){n.preventDefault();var s=e(this);a.clearAll(),i.clearErrors(s);var r=s.find('input[name="email"]'),l=s.find('input[name="password"]'),c=s.find('input[name="password2"]'),d=s.find('input[name="terms"]'),u=r.parent(),p=i.validate([{value:r.val(),tiperror:u,rules:{empty:t.__("Email must not be empty"),email:t.__("Email is not valid")},css:{bottom:114},left:13},{value:l.val(),tiperror:u,rules:{empty:t.__("Password must not be empty"),length:[6,t.__("Password must be at least 6 characters")]},css:{bottom:60},left:13},{value:c.val(),tiperror:u,rules:{empty:t.__("Password must not be empty"),callback:[function(){return c.val()===l.val()},t.__("Passwords do not match")]},css:{bottom:6},left:13},{input:d,tiperror:u,rules:{checked:t.__("You must accept the terms & conditions to continue")},css:{bottom:-38},left:18}]);p&&a.request({data:i.serializeObject(s),$loading:s.find(".submit .loading").css({visibility:"visible"}),success:function(t){t.redirect?o.redirect(t.redirect):t.errors&&e.each(t.errors,function(e,t){var a=!1,o=13;switch(e){case"email":a={bottom:114};break;case"password":a={bottom:60};break;case"password2":a={bottom:6};break;case"terms":a={bottom:-38},o=18}i.error(u,t,a,!1,o)})}})})})}),Slickplan.module(function(e,t,i){t.subscribe("route/error",function(){var i=t.require("form"),a=t.require("ajax"),o=t.require("http"),n=t.require("notification");t.$body.on("submit","#errorpage > form",function(t){t.preventDefault(),a.clearAll();var s=e(this).find("textarea")[0];if(e("html, body").animate({scrollTop:0},300),s.value==s.defaultValue||""==s)n.error(s.defaultValue);else{n.success("Your message has been sent. You will be redirected in a few seconds."),setTimeout(function(){window.location=e('#errorpage input[name="error[redirect]"]').val()},4e3);var r=i.serializeObject(e(this));r.ajax=1,a.request({url:o.url(e(this).attr("action")),data:r})}})})}),Slickplan.module(function(e,t,i){t.subscribe("after_init",function(){function i(e){var i=d.wysiwyg("form-feedback");i&&i.save();var a=e.closest(".modal"),o=r.serializeObject(e);o.ajax=1,a.hasClass("modalclass-paymenterr")&&window.SLICKPLAN_PAYMENT_ERROR&&(o.errormsg=window.SLICKPLAN_PAYMENT_ERROR),u.request({url:l.url(e.attr("action")),data:o,$loading:e.find(".loading").css({visibility:"visible"}),clear:!0,success:function(e){if(e.success){var i=d.wysiwyg("form-feedback");i&&i.setContent(""),a.dialog("close"),c.success(t.__("Feedback sent")),window.SLICKPLAN_PAYMENT_ERROR=null}else e.error&&c.error(e.error)},error:function(){e.closest(".modal").dialog("close")}})}function a(t,i,a,o){var n='<div class="item item'+t+" "+(o?o:"")+'">';t&&(n+='<a href="#" class="delete" data-id="'+t+'"><i class="fa fa-times"></i></a>'),n+='<span class="filename">'+i.name+"</span>",a&&(n+='<span class="message"> - '+a+"</span>"),n+='<span class="progress"></span></div>',e("#pluploadfileslist").show().append(n)}function o(){e("#pluploadfileslist").empty().hide(),m=[]}var n,s=t.require("config"),r=t.require("form"),l=t.require("http"),c=t.require("notification"),d=t.require("helper"),u=t.require("websocket"),p=!1,m=[];d.wysiwygInit("form-feedback",!1,{width:510,height:132}),t.$window.on("load debouncedresize",function(){t.$body.height()>t.$window.height()&&!t.$main.hasClass("payment-info")?t.$main.find("form").addClass("fixed"):t.$main.find("form").removeClass("fixed")}),t.subscribe("after_init/sitemap",function(){if(e('meta[name="csrf-token"]').length){var i,a=6e4,o=function(){u.request("ping",{silent:!0,success:function(i){if(i)if(i._modal&&"object"===e.type(i._modal)&&i._modal.modal&&i._modal.notification_id){if(i._modal.script_src||i._modal.script_tpl){var a="modal-dynamic-notification-"+i._modal.notification_id,o="tpl-"+a,n="script-"+a,r=function(){i._modal.script_src&&!window.document.getElementById(n)&&t.$body.append('<script src="'+i._modal.script_src+'" id="'+n+'" type="text/javascript"></script>')};i._modal.html_tpl&&!window.document.getElementById(o)?(t.$body.append('<div id="'+o+'"></div>'),e("#"+o).load(i._modal.html_tpl,function(){r()})):i._modal.script_tpl&&!window.document.getElementById(o)?(t.$body.append('<script id="'+o+'" type="text/template"></script>'),e("#"+o).load(i._modal.script_tpl,function(){r()})):r(),u.request("system_notification",{data:{id:i._modal.notification_id},silent:!0})}}else i._notify&&"object"===e.type(i._notify)&&i._notify.message&&i._notify.options&&!c.isActive()?c.display(i._notify.message,i._notify.options):i.js_version&&t.globalOption("version_notify")!==i.js_version&&i.js_version!=s.get("app_js_version",i.js_version)&&!c.isActive()&&(c.info('Weâ€™ve made some improvements, please save your work and <a href="javascript:location.reload()">refresh</a> the page'),t.globalOption("version_notify",i.js_version))},complete:function(){i=setTimeout(o,a)}})};t.$window.on("load",function(){i=setTimeout(o,1e4)}),t.subscribe("onunload",function(){clearTimeout(i)})}});var f=e("#back-to-top");f.length&&(f.on("click",function(){e("html, body").animate({scrollTop:0},333)}),t.$window.scroll(function(){t.$window.scrollTop()>10?f.addClass("show"):f.removeClass("show")}));var h=e("#modal-old-browser");h.length&&(h.dialog("open"),e("#upgrade-info").remove()),t.$body.on("submit","#modal-feedback > form",function(t){t.preventDefault();var a=e(this);r.clearErrors();var o=e.trim(e("#form-feedback").val().replace(/(<([^>]+)>)/gi,"")),s=r.validate([{value:o,tiperror:e("#form-feedback").parent(),rules:{empty:"Feedback must not be empty"},css:{top:91,bottom:"auto"},left:-19}]);s&&(n?(a.find(".loading").css({visibility:"visible"}),p=!1,n.start()):i(a))}).on("change","input.check-all",function(){var i=e(this),a=i.closest(".scrollable-wrapper");a.length||(a=t.$window);var o=a.scrollTop();i.closest("table").find('input[type="checkbox"]:not(.check-all)').reverse().prop("checked",!this.checked).siblings("label").trigger("click"),a.scrollTop(o)}),e("#pluploadfileslist").on("click",".delete",function(t){t.preventDefault();var i=e(this).data("id");n&&n.removeFile(i),e(this).closest(".item").remove(),e("#pluploadfileslist").find(".item").length||o()}),t.subscribe("upload/files_added_pluploadbtndrop",function(e,i,o,s){var r=t.require("form"),l=t.require("notification");r.clearErrors(),l.clearAll(),plupload.each(o,function(e){a(e.id,e,"("+plupload.formatSize(e.size)+")")}),n=i}),t.subscribe("upload/file_uploaded_pluploadbtndrop",function(e,t,i,a,o){a&&a.success&&a.file_id&&m.push(a.file_id)}),t.subscribe("upload/uploads_complete_pluploadbtndrop",function(t,a){e("#pluploadfileslist").find(".item").remove(),e("#feedback_files").val(m.join(",")),o(),n=a,n.refresh(),e("#modal-feedback").children("form").find(".loading").css({visibility:"visible"}),p||i(e("#modal-feedback").children("form"))}),t.subscribe("upload/error_pluploadbtndrop",function(e,t,i,o){a(!1,i.file,i.message,"error"),p=!0,n=t,n.stop(),n.refresh()}),t.subscribe("upload/uploads_progress_pluploadbtndrop",function(t,i,a,o){var n=e("#pluploadfileslist");n.find(".delete").hide(),n.find(".item"+a.id+" .progress").html(" - "+a.percent+"%")}),t.subscribe("modal/open/modal-feedback",function(e,i){var a=i.find(".uploadbutton.dynamic");if(a.length){var o=a.attr("id");t.publish("upload/dynamic_uploader/init",[a.get(0),o,o])}}),t.subscribe("modal/before_close/modal-feedback",function(e,i){var a=i.find(".uploadbutton.dynamic");a.length&&t.publish("upload/dynamic_uploader/destroy",[a.attr("id")])});var g=e("#modal-oldpricing"),v=null,b=function(){v&&(clearTimeout(v),v=null),v=setTimeout(function(){if(v!==!1){var e=g.find(".slides-controls .control.current"),t=e.next(".control");t.length?(t.trigger("click"),b()):v=!1}},1e4)},_="",y=0;t.$window.on("hashchange",function(e,i){var a=window.location.hash.replace(/^#/,"");t.publish("hashchange",[window.location.hash.replace(/^#/,""),_,i]),_=a}).on("load",function(){e("#sitemap-top").scrollTo(0,0),g.length&&(g.on("dialogopen",function(){var e=g.find(".slides-controls").empty();if(e.length){for(var t=g.find(".slides").css({left:730}).children(".slide").length,i="",a=0;t>a;++a)i+='<span class="control"><i class="fa fa-circle-thin"></i><i class="fa fa-circle"></i></span>';e.html(i),setTimeout(function(){g.find(".slides").addClass("anim"),e.find(".control").filter(":first").trigger("click",[!0]),b()},250)}else setTimeout(function(){g.find(".slides").css({marginLeft:0,opacity:1,left:0})},250)}),g.dialog("open"))}).on("load scroll resize",function(){var e=Math.max(0,t.$window.scrollLeft());y!==e&&(y=e,d.addCssRule("#header-wrapper, #sitemap-top, #main.sitemap, #preview-head-fixed","margin-left: "+e+"px"))}).trigger("hashchange",[!0]),g.length&&g.on("click",".slides-controls .control",function(t,i){var a=e(this);if(a.hasClass("current"))return!1;a.addClass("current").siblings(".control").removeClass("current");var o=730*a.prevAll(".control").length,n={left:-o};i?n.opacity=1:v=!1,g.find(".slides").css(n)}).on("click","button.oldpricing-free",function(t){t.preventDefault(),g.dialog("close"),setTimeout(function(){e("#account-free").find('a[data-planid="1"]').trigger("click")},200)}).on("click","button.oldpricing-chose, button.oldpricing-justclose",function(e){e.preventDefault(),g.dialog("close")}).on("click","button[data-type]",function(i){i.preventDefault(),g.dialog("close");var a=e(this),o=r.serializeObject(a.closest("form"),[{name:"button_type",value:a.data("type")}]);u.request("new_pricing",{data:o,success:function(i){i&&(i.redirect?l.redirect(i.redirect):i.success?"string"===e.type(i.success)&&i.success.length>2&&c.success(i.success):i.error&&(i.bytes_to_archive?t.publish("account/archive_dialog",["storage",i.bytes_to_archive,!0,"v4_modal"]):i.storage_remove?t.publish("account/archive_dialog",["storage",!0,!0,"v4_modal"]):i.archive_sitemaps?t.publish("account/archive_dialog",["sitemaps",i.archive_sitemaps,!0,"v4_modal"]):i.archive_users?t.publish("account/archive_dialog",["contributors",i.archive_users,!0,"v4_modal"]):c.error(i.error)))}})})})}),Slickplan.module(function(e,t,i){t.subscribe("before_init",function(){var a=t.require("config"),o=t.require("form"),n=t.require("sitemap"),s=t.require("notification"),r=t.require("helper"),l=t.require("svg"),c=t.require("string"),d=t.require("color"),u=t.require("scrollbar"),p=2001;e("html").removeClass("no-js").addClass("js"),e('input[type="text"], input[type="password"], textarea').attr("autocomplete","off").attr("autocapitalize","off").attr("autocorrect","off"),e(":input.autoselect").on("focus dblclick",function(){e(this).select()}),t.$document.data("ui-dialog-overlays",99999),e('.modal .submit > input[type="submit"]').after('<div class="loading" />'),e.disableSelection||e.fn.extend({disableSelection:function(){return this.on((e.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(e){e.preventDefault()})}}),e("#sitemap-wrapper p, .switch > input + label, .radio > input + label, .checkbox > input + label, body > ul, .usersbox, .disableSelection, #sitemap-top h1 > span").disableSelection(),u&&u.init("#scroll-area",{trackSize:441}),e("#header").find("li.settings").on("mouseenter",function(){e(this).addClass("hover")}).on("mouseleave",function(){e(this).removeClass("hover")}).end().find("ul ul").each(function(){e(this).addClass("items-"+(e(this).children("li").length-1))});var m=e("#header-wrapper.withTrialText").find(".logo-text");m.length&&m.width(Math.max(10,1e3-m.siblings("ul").outerWidth(!0)-m.siblings("#user-box").outerWidth(!0)));var f=e("#colorpicker");if(e.farbtastic&&f.length&&(f.farbtastic("#colorinput"),t.$body.on("click","#colordefault",function(t){t.preventDefault(),e.farbtastic("#colorpicker").setColor("#008DF5"),e("#form-darkfont").prop("checked",!1).trigger("change")})),"object"===e.type(e.ui)&&("undefined"!==e.type(e.ui.selectmenu)&&e("select:not(.plain)").selectmenuslickplan({style:"popup",format:function(e){return c.charsEncode(e)}}),e.ui.dialog!==i)){e("div.modal").each(function(){var i=e(this),a=i.attr("id");t.publish("modal/before_init/"+a,[i]),i.dialog({appendTo:document.body,autoOpen:!1,modal:!0,show:{effect:"fade",duration:250},hide:{effect:"fade",duration:300},create:function(){i.parent(".ui-dialog").attr("id",a+"-wrapper")},open:function(){if(e(".modal:not(#"+a+")").dialog("close"),"modal-export"===a)e("#modal-export").find('input[type="radio"]').filter(":first").prop("checked",!0).change();else if("modal-open"===a){var o=i.find("select");o.selectmenuslickplan("destroy"),o.selectmenuslickplan({style:"popup",format:function(e){return c.charsEncode(e)}})}if(p+=10,i.parent().css("z-index",p),e(".ui-widget-overlay").filter(":last").attr("class","ui-widget-overlay modal-hooked modal-overlay modalid-"+a).hide().css({zIndex:p-1}).fadeIn(250,function(){i.parent().addClass("anim")}),i.find(".loading").css({visibility:"hidden"}),"modal-confirm"===a){var n=i.find("#modal-confirm-custom").data();n&&"object"===e.type(n)&&n.mime&&n.s3&&n.uploader_key&&(t.publish("upload/dynamic_uploader/destroy",[n.uploader_key]),i.find("#modal-confirm-custom").removeData(),i.find(".moxie-shim").remove())}t.publish("modal/open/"+a,[i]);var s=i.find(".table-scroll"),r=s.find("tr"),l=s.data("how-many")||4;if(s.length&&"modal-color-load"!==a&&r.length>l){var d=r.filter(":last").outerHeight()*l;s.height(d),u&&u.init(s,{thumbSize:64,trackSize:d})}},beforeClose:function(){if(i.is(":visible")){i.addClass("closing");var n=e(".ui-widget-overlay.modalid-"+a).clone();e(".ui-widget-overlay.modalid-"+a).remove(),o.clearErrors(i),n.appendTo(t.$body).fadeOut(300,function(){e(this).remove()}),i.css({overflow:"hidden"}).parent().css({overflow:"hidden"}),t.publish("modal/before_close/"+a,[i])}},close:function(){p-=10,i.removeClass("closing").parent().removeClass("anim"),t.publish("modal/close/"+a,[i])},resizable:!1,draggable:!1,width:i.width(),height:i.height()})});var h=function(a){var s=a.hasClass("tooltip-modal")?"ui-tooltip-modal"+(a.hasClass("tooltip-modal-left")?" tooltip-modal-left":""):"ui-top-modal";s+=a.hasClass("resizeable")?" sl-resizeable":"",s+=a.hasClass("resizeable-x")?" sl-resizeable-x":"",s+=a.hasClass("resizeable-y")?" sl-resizeable-y":"";var r=a.attr("id");t.publish("top_modal/before_init/"+r,[a]),a.dialog({appendTo:document.body,autoOpen:!1,modal:!0,stack:!0,dialogClass:s,show:{effect:"fade",duration:250},hide:{effect:"fade",duration:300},create:function(){a.parent(".ui-dialog").attr("id",r+"-wrapper")},open:function(){a.parent(".ui-dialog").addClass(r),o.clearErrors(!0),n.hideAddHelperPlaceholder(!1),p+=10,a.parent().css("z-index",p),e(".ui-widget-overlay:not(.modal-hooked)").attr("class","ui-widget-overlay modal-hooked topmodal-overlay modalid-"+r).css({zIndex:p-1}),t.publish("top_modal/open/"+r,[a])},beforeClose:function(){if(a.is(":visible")){n.getOptions();e(".ui-widget-overlay.modalid-"+r).remove(),o.clearErrors(!0),o.clearErrors(a.css({overflow:"hidden"}).parent().css({overflow:"hidden"})),t.publish("top_modal/before_close/"+r,[a])}},close:function(){p-=10,t.publish("top_modal/close/"+r,[a])},resizable:a.hasClass("resizeable"),resize:function(e){var t=a.find("#form-cell-note");t.length&&(t.trigger("keyup",[!0]),n.addCellNoteWidth(i,t.parent().width()))},draggable:!1,width:a.width(),height:a.height(),minWidth:a.width(),maxWidth:Math.max(a.width(),t.getWindowWidth()-100)}),a.on("click",".tooltip-modal-titlebar .close",function(e){e.preventDefault();var t=a.find(".buttons button.cancel");t.length?t.trigger("click"):a.dialog("close")})};e("div.top-modal").each(function(){h(e(this))}),t.$body.on("click","[data-modal]",function(i){i.preventDefault();var o=e(this),n=a.get("account"),r=o.data("modal"),l=o.data("modalclass");if(("create-sitemap"===r||"save-as"===r)&&n.sitemaps_limit>-1&&n.sitemaps_count>=n.sitemaps_limit)return s.error(t.__('Your {1} account needs to be <a href="{2}">upgraded</a> to create a new sitemap',n.name,a.get("payment_url","#"))),!1;var c=e("#modal-"+r+".modal");if(!c.length)return t.noPermissions();if(c.removeClass(function(e,t){return(t.match(/(^|\s)modalclass-\S+/g)||[]).join(" ")}),l){l=l.split(" ");for(var d=0;d<l.length;++d)l[d]&&c.addClass("modalclass-"+l[d])}e(".modal").dialog("close"),t.publish("modal/before_open/modal-"+r,[c]),"feedback"!==r&&c.find("form").each(function(){"export-tab"!==this.id&&this.reset()}),c.dialog("open").find(":text").filter(":first").focus()}).on("click","[data-topmodal]",function(i){i.preventDefault();var a=e(this),o=a.data("topmodal"),s=e("#topmodal-"+o);if(!s.length)return t.noPermissions();var u=s.parent(),p=n.getCurrentCell(),m=l.getElement(p,!0),f=n.getOptions(),h=!1,g=!1,v=e(".top-modal");v.length&&v.dialog("close"),u.removeClass("topFive linetext cell_color cell_text_color batchediting");var b={my:"center",at:"center",of:a};a.hasClass("cellmodal")?(b={my:"right center",at:"left center",of:m,left_offset:-2},a.hasClass("desc")?b={my:"right top",at:"right bottom",of:m,top_offset:3,left_offset:10}:a.hasClass("url")?b={my:"right top",at:"right bottom",of:m,top_offset:3,left_offset:10}:a.hasClass("archetype")&&(b={my:"left top",at:"left bottom",of:m,left_offset:-8,top_offset:3})):a.hasClass("batchediting")?(b={my:"right top",at:"right bottom",of:a,left_offset:20,top_offset:10},h=!0,u.addClass("batchediting"),g=!0):a.parent().hasClass("batchediting")&&(b={my:"right center",at:"left center",of:a.parent().find(".color-box").parent(),left_offset:-2},h=!0,u.addClass("batchediting"),g=!0);var _=n.getScrollWrapper(),y=_.scrollTop();u.removeData("li").removeData("type"),s.find("form").each(function(){this.reset()}),s.dialog("open");var w=a.data("type")||!1;if(w&&u.data("type",w),g){if(a.hasClass("desc")){var C=e("#sitemap-batch-edit .ui-selectmenu.batchediting.desc").data("batchdata")||"";e("#topmodal-cell-note").css({height:""}).find(".note-text").html(C?C:"&nbsp;").show().end().find("textarea").val(C).height(e("#topmodal-cell-note .note-text").height()).hide().end().height(e("#topmodal-cell-note > div").outerHeight()).parent(".ui-tooltip-modal").css({top:"+=13px",left:"+=10px"});var k=r.wysiwyg("form-cell-note");k&&k.setContent(C)}else if(a.hasClass("url")){var x=e("#sitemap-batch-edit .ui-selectmenu.batchediting.url").data("batchdata")||"http://";e("#topmodal-cell-url").find("#form-cell-url").val(x).end().height(e("#topmodal-cell-url > div").outerHeight()).parent(".ui-tooltip-modal").css({top:"+=13px",left:"-=10px"}),e("#topmodal-cell-url #form-cell-url").putCursorAtEnd()}}else if(a.hasClass("linetext")&&"farbtastic"===o){u.addClass("topFive");var S=a.data("color")||a.next("li").data("color");S&&(S=S.replace(/[^0-9a-f]/gi,""),3!==S.length&&6!==S.length||(e.farbtastic("#colorpicker").setColor("#"+S),e("#colorinput").val(S)))}else if(a.hasClass("custom")&&"farbtastic"===o){u.addClass("topFive").data("type","custom");var D=e("#sitemap-top").find("form select").val();if("all"!==D&&D){var S=defaultColors[currentSection][D].replace(/[^0-9a-f]/gi,"");3!==S.length&&6!==S.length||(e.farbtastic("#colorpicker").setColor("#"+S),e("#colorinput").val(S))}}else if(m&&"object"===e.type(m)&&m instanceof e&&m.length)if(a.hasClass("color")){u.addClass("cell_color");var S=l.getData(p,f.data_color)||n.getColorSchemeItem(p);S&&(e.farbtastic("#colorpicker").setColor(d.toHex(S)),e("#colorinput").val(S)),e("#topmodal-farbtastic").find('input[type="reset"]').data("oldcolor",S||"").end().find("h1 > span").html(a.text())}else if(a.hasClass("textcolor")){u.addClass("cell_text_color");var S=l.getData(p,f.data_text_color)||n.getColorSchemeItem("text_color");S&&(e.farbtastic("#colorpicker").setColor(d.toHex(S)),e("#colorinput").val(S)),e("#topmodal-farbtastic").find('input[type="reset"]').data("oldcolor",S||"").end().find("h1 > span").html(a.text())}else if(a.hasClass("desc")){var C=l.getData(p,f.data_desc)||"";e("#topmodal-cell-note").css({height:""}).find(".note-text").html(C?c.charsDecode(C):"&nbsp;").show().end().find("textarea").val(C).height(e("#topmodal-cell-note").find(".note-text").height()).hide().end().height(e("#topmodal-cell-note").children("div").outerHeight()).parent(".ui-tooltip-modal").css({
    top:"+=13px",left:"+=10px"});var k=r.wysiwyg("form-cell-note");k&&k.setContent(C)}else if(a.hasClass("archetype")){var s=e("#topmodal-cell-archetype").parent(".ui-tooltip-modal").css({top:"+=13px",left:"-=1px"}).end();n.scrollToView(m.closest("#section-svg-wrapper"),s.get(0))}e(".ui-top-modal").css({cursor:"move"}).find("div.ui-dialog-content").css({cursor:"default"}).end().draggable({cancel:"div.ui-dialog-content",containment:"window",scroll:!1,start:function(){var e=a.removeClass("topFive").position();a.data("lastLeft",e.left).data("lastTop",e.top)},drag:function(t,i){e(".top-modal-tip-error").css({left:"+="+(i.position.left-a.data("lastLeft"))+"px",top:"+="+(i.position.top-a.data("lastTop"))+"px"}),a.data("lastLeft",i.position.left).data("lastTop",i.position.top)}}),w||u.hasClass("topFive")?s.find(".breset").val(t.__("Cancel")):s.find(".breset").val(t.__("Reset")),l.position(u,b,{min:{top:0,left:0},max:{left:_.scrollLeft()+t.getWindowWidth()-u.width()-5}},h),_.scrollTop(y),s.find("input").filter(":visible").filter(":first").blur(),t.publish("top_modal/after_open/topmodal-"+o,[s,a])}).on("click",".top-modal .close, .modal .close",function(t){t.preventDefault();var i=e(this).closest(".top-modal, .modal");"topmodal-farbtastic"!==i.attr("id")&&i.dialog("close")}).on("click",".modal-overlay",function(){t.$body.children(".ui-dialog").children(".modal").not("#modal-oldpricing").not(".disable-close").filter(":visible").dialog("close")}).on("click",".topmodal-overlay",function(){return!1})}t.$main.on("submit","form",function(e){s.clearAll()}),t.$window.on("debouncedresize",function(){t.$body.children(".ui-dialog").filter(":visible").children(".modal").each(function(){e(this).dialog("option","position",{my:"center",at:"center",of:window})})}),t.subscribe("route/deal/upgrade",function(){var i=e("#modal-oldpricing").find("form");i.on("submit",function(a){a.preventDefault();var n=t.require("ajax"),r=t.require("http"),l=e(this);i.hide();var c=o.serializeObject(l,[{name:"ajax",value:1}]);n.request({url:r.url(),data:c,clear:!0,success:function(e){e&&(e.error?(s.error(e.error),i.show()):r.redirect("/dashboard"))},error:function(){i.show()}})})}),t.$body.find(".jtooltip").each(function(){var t,i=e(this),a=i.find(".jcontent");a.length?(t=a.html(),a.remove()):(t=i.attr("title"),i.removeAttr("title")),i.data("tooltip-content",t)}),t.$document.tooltip({items:".jtooltip",show:!1,hide:{effect:"fadeOut",duration:100,delay:100},content:function(){return e(this).data("tooltip-content")},position:{my:"center bottom+10",at:"center top",using:function(t){e(this).css(t)}},open:function(e,t){t.tooltip.stop().css({opacity:0}).animate({opacity:1,top:t.tooltip.position().top-15},150)}})})}),Slickplan.module(function(e,t,i){t.subscribe("route/auth/login route/auth/index route/login route/forgot",function(){var i=t.require("form"),a=t.require("ajax"),o=t.require("http"),n=t.require("notification"),s=e("#login-box"),r=function(){var e=s.find("fieldset").filter(":visible");if(e.length){var t=e.find(".tip-error").filter(":visible").filter(":last").parent().children("input");t.length||(t=e.find('input[type="text"]').filter(":first")),setTimeout(function(){t.focus()},50)}};if(s.find("h1 strong").length){var l=s.find("h1 strong").width()+s.find("h1 span").width()+242;s.find("form").width()<l&&s.find("form").css({width:l,marginLeft:-(l/2)}).find("fieldset").css({width:l-72}).end().find('input[type="text"], input[type="password"]').css({width:l-82})}var c,d=s.find("h1").filter(":first").children("span").html();s.on("click",".forgot",function(t){t.preventDefault();var a=e(this);c=/username/i.test(a.html())?"username":"password",a.closest("fieldset").fadeOut(400,function(){s.find("form").animate({height:"-=80",marginTop:"+=40"},400),e(this).next("fieldset").fadeIn(400),i.clearErrors()}).siblings("h1").find("span").fadeOut(400,function(){e(this).html(a.html()).fadeIn(400)})}),t.$body.on("click","#login-box:not(.close-form) .button",function(t){t.preventDefault(),e("#form-notify > a").trigger("click");var i=e(this);i.closest("fieldset").fadeOut(400,function(){s.find("form").animate({height:"+=80",marginTop:"-=40"},400),e(this).prev("fieldset").fadeIn(400),e("#forgot-form .input").find("input").val("").end().find("p").remove()}).siblings().prev("h1").find("span").fadeOut(400,function(){e(this).html(d).fadeIn(400)})}),e("#forgot-form").on("click",'input[type="submit"]',function(s){s.preventDefault(),a.clearAll(),i.clearErrors();var r=e("#forgot-form > div.input > p");r.length||(r=e("<p></p>").appendTo("#forgot-form > div.input")),r.hide();var l=e("#form-forgot").val();l?a.request({url:o.url(e("#forgot-form").data("action")),$loading:e("#forgot-form .loading").css({visibility:"visible"}),data:{forgot:l,type:c},success:function(a){a.error?i.error(e("#form-forgot").parent("div"),t.__("No user found")):(e("#form-forgot").val(""),n.success(t.__("An email with instructions has been sent")))}}):i.error(e("#form-forgot").parent("div"),t.__("Email must not be empty"))}),s.on("click",'fieldset:first input[type="submit"]',function(a){i.clearErrors();var o=e(this).next(".loading").css({visibility:"visible"}),n=e("#form-username"),s=e("#form-password"),r=i.validate([{value:n.val(),tiperror:n.parent(),rules:{empty:t.__("Username must not be empty")}},{value:s.val(),tiperror:s.parent(),rules:{empty:t.__("Password must not be empty")}}]);return r?!0:(o.css({visibility:"hidden"}),!1)}),s.on("keydown","fieldset input",function(t){t.keyCode&&13==t.keyCode&&(t.preventDefault(),e(this).closest("fieldset").find('input[type="submit"]').trigger("click"))}),e("#form-notify").css({top:"+=2"}),e('#login-box.forgot-form input[type="submit"]').on("click",function(a){i.clearErrors();var o=e(this).next(".loading").css({visibility:"visible"}),n=e("#forgotpassword0"),s=e("#forgotpassword1"),r=i.validate([{value:n.val(),tiperror:n.parent(),rules:{empty:t.__("Password must not be empty")}},{value:s.val(),tiperror:s.parent(),rules:{empty:t.__("Password must not be empty")}}]);return r&&n.val().length<6&&(i.error(n.parent(),t.__("Password must be at least 6 characters")),r=!1),r&&n.val()!==s.val()&&(i.error(s.parent(),t.__("Passwords do not match")),r=!1),r||o.css({visibility:"hidden"}),r}),/login\/saved/.test(document.location.href)&&n.success(t.__("New password saved. Please login below.")),/password/.test(document.location.hash)&&s.find(".forgot").filter(":last").trigger("click"),r()})}),Slickplan.module(function(e,t,i){var a="default",o=!1,n=function(i,n){var s=t.require("http"),r=t.require("notification");i?i.redirect?s.redirect(i.redirect):i.archive_dialog&&i.archive_dialog_argument?("true"===i.archive_dialog_argument&&(i.archive_dialog_argument=!0),t.publish("account/archive_dialog",[i.archive_dialog,i.archive_dialog_argument,o,a])):i.error?r.error(i.error):"function"===e.type(n)&&n(i):r.error("Unknown error")};t.subscribe("after_init",function(){var o=e("#modal-archive"),s=e("#modal-archive-contributors"),r=e("#modal-archive-files");if(o.length||s.length||r.length){var l=t.require("form"),c=t.require("websocket"),d=t.require("config"),u=t.require("string"),p=t.require("sitemap");o.find(".table-scroll tr").css({cursor:"pointer"}).on("click",function(){var t=e(this).find(":checkbox");t.prop("checked",!t.is(":checked")).change()}),s.find(".table-scroll tr").css({cursor:"pointer"}).on("click",function(){var t=e(this).find(":checkbox");t.prop("checked",!t.is(":checked")).change()}),o.on("change",":checkbox",function(){var e=o.data("limit")-o.find(":checkbox:checked").length;0>=e?o.data("submit",1).find("h1 em").html(t.__("Done. Click Archive to continue.")):o.removeData("submit").find("h1 em").html(t.__("You need to archive <span>{1}</span> sitemaps to continue",e))}),s.on("change",":checkbox",function(){var e=s.data("limit")-s.find(":checkbox:checked").length;0>=e?s.data("submit",1).find("h1 em").html(t.__("Done. Click Deactivate to continue.")):s.removeData("submit").find("h1 em").html(t.__("You need to deactivate <span>{1}</span> users to continue",e))}),r.on("click",".single-file",function(){e(this).toggleClass("selected");var i=r.data("limit");r.find(".single-file.selected").each(function(){var t=e(this).data("size");t&&(i-=parseInt(t,10))}),i>0?r.removeData("submit").find("h1 em").html(t.__("You need to delete <span>{1}</span> of files to continue",u.humanReadableFileSize(i))):r.data("submit",1).find("h1 em").html(t.__("Done. Click Delete to continue."))}),o.on("submit","form",function(s){if(s.preventDefault(),c.clearAll(),1!==o.data("submit"))return!1;var r=e(this),u=l.serializeObject(r,[{name:"ajax",value:1},{name:"extra_type",value:a}]);c.request("account_archive",{data:u,$loading:r.find(".submit > .loading").css({visibility:"visible"}),success:function(a){n(a,function(a){if(a.success&&a.sitemaps!==i){o.removeData("submit").removeData("limit").dialog("close");var n=d.get("account");n.sitemaps_count=a.sitemaps,d.set("account",n),e("fieldset.existing").length&&e("fieldset.existing").data("sitemaps",a.sitemaps),t.publish("modal/archive/archived",[r])}})}})}),s.on("submit","form",function(o){if(o.preventDefault(),c.clearAll(),1!==s.data("submit"))return!1;var r=e(this),u=l.serializeObject(r,[{name:"ajax",value:1},{name:"extra_type",value:a}]);c.request("account_archive",{data:u,$loading:r.find(".submit > .loading").css({visibility:"visible"}),success:function(a){n(a,function(a){if(a.success&&a.contributors!==i){s.removeData("submit").removeData("limit").dialog("close");var o=d.get("account");o.contributors=a.contributors,a.active_contributors!==i&&(o.active_contributors=a.active_contributors),d.set("account",o),e("fieldset.existing").length&&e("fieldset.existing").data("contributors",a.contributors),t.publish("modal/archive/archived",[r])}})}})}),r.on("submit","form",function(i){if(i.preventDefault(),c.clearAll(),1!==r.data("submit"))return!1;var o=e(this),s=[];r.find(".single-file.selected").each(function(){var t=e(this).data("file");t&&s.push(t)});var l=r.data("type");if(s.length)c.request("account_archive",{data:{archive_type:"storage",archive:s,extra_type:a},$loading:r.find(".submit > .loading").css({visibility:"visible"}),success:function(i){n(i,function(i){if("undefined"!==e.type(i.storage_used)){r.removeData("submit").removeData("limit").dialog("close");var a=d.get("account");switch(a.storage_used=i.storage_used,d.set("account",a),l){case"plan":t.publish("modal/archive/archived",[o]);break;case"storage_remove":e("#additional-space-remove").trigger("click",[!0]);break;case"storage_update":e("#modal-additional-space .onetimesubmit button").trigger("click",[!0])}if(i.usage_text&&e(".usage-text").text(i.usage_text),i.clear_cells&&i.clear_cells.length){for(var n=0,s=i.clear_cells.length;s>n;++n)p.removeCellData(i.clear_cells[n],p.getOption("data_file"),!0);p.fullRefresh()}}})}});else switch(l){case"plan":t.publish("modal/archive/archived",[o]);break;case"storage":case"storage_remove":case"storage_update":e("#additional-space-remove").trigger("click",[!0])}}),o.on("click","thead a[data-sort]",function(t){t.preventDefault();var i=e(this).data("sort"),a=e(this).parent().hasClass("desc")?"asc":"desc";o.find("thead th").removeClass("desc asc"),e(this).parent().addClass(a);var n=[],s=[];o.find("tbody tr").each(function(){var t=e(this).data("time");"name"===i&&(t=e(this).children("td").filter(":first").children("span").text().toLowerCase()+t),t+=""+Math.random(),n[t]=e(this),s.push(t)}),s.sort(),"desc"===a&&s.reverse();for(var r=e("<tbody>"),l=0;l<s.length;++l)r.append(n[s[l]].clone(!0)),n[s[l]].remove();o.find("tbody").replaceWith(r)}),s.on("click","thead a[data-sort]",function(t){t.preventDefault();var i=e(this).parent().hasClass("desc")?"asc":"desc";s.find("thead th").removeClass("desc asc"),e(this).parent().addClass(i);var a=[],o=[];s.find("tbody tr").each(function(){key=e(this).children("td").filter(":first").children("span").text().toLowerCase(),key+=""+Math.random(),a[key]=e(this),o.push(key)}),o.sort(),"desc"===i&&o.reverse();for(var n=e("<tbody>"),r=0;r<o.length;++r)n.append(a[o[r]].clone(!0)),a[o[r]].remove();s.find("tbody").replaceWith(n)})}}),t.subscribe("account/archive_dialog",function(i,s,r,l,c){var d=t.require("websocket"),u=t.require("config"),p=t.require("string"),m=t.require("helper"),f=t.require("scrollbar");switch(o=l,a=c||"default",s){case"storage":if(r===!0)m.confirmDialog({close:!o,title:t.__("You need to delete all your files to continue"),yes_label:"Yes, Delete",no_label:"Cancel",on_yes:function(){d.request("account_archive",{data:{archive_type:"storage",archive:"all",extra_type:a},success:function(i){n(i,function(i){if("undefined"!==e.type(i.storage_used)){var a=u.get("account");a.storage_used=i.storage_used,u.set("account",a),t.publish("modal/archive/archived")}})}})}});else{var h=e("#modal-archive-files");o?h.addClass("disable-close"):h.removeClass("disable-close"),h.data("limit",r).data("type","plan").dialog("open"),h.find("h1").show().find("span").text(p.humanReadableFileSize(r));var g=h.find(".files-scroll").show();g.removeData("plugin_tinyscrollbar").removeClass("tinyscrollbar-enabled").empty(),d.request("get_cell_files_library",{data:{file_types:"all",sort:"filesize-desc"},success:function(e){if(html='<div class="clearfix fileslist">',e&&e.success&&e.files)for(var t=0,i=e.files.length;i>t;++t)e.files[t]&&e.files[t].alias&&(html+='<div class="single-file single-file-'+e.files[t].alias,t%5===0&&(html+=" first-on-row"),html+='" data-file="'+e.files[t].alias+'" data-size="'+e.files[t].size+'">',e.files[t].url_thumb?html+='<img src="'+e.files[t].url_thumb+'">':e.files[t].fa_icon&&(html+='<div class="thumb-icon"><div class="file-name"><i class="fa fa-'+e.files[t].fa_icon+'"></i><div class="sandbox">'+e.files[t].name+"</div></div></div>"),html+='<div class="filesize">'+p.humanReadableFileSize(e.files[t].size)+'</div><div class="selected"><i class="fa fa-check"></i></div></div>');html+="</div>",g.html(html),f.init(g),f.update(g),setTimeout(function(){f.update(g)},50)}})}break;case"sitemaps":case"contributors":var h=e("#modal-archive"+("contributors"===s?"-contributors":""));h.length&&(o?h.addClass("disable-close"):h.removeClass("disable-close"),e(".modal").dialog("close"),h.find("form").each(function(){this.reset()}),h.data("limit",r).dialog("open"),h.find("h1 span").text(r),m.rowShadow())}})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){e("#modal-open").on("submit","form",function(i){i.preventDefault();var a=e(this),o=a.attr("action"),n=a.find('select[name="version"]').val();n&&(o=o.split("/"),o[o.length-1]=n,o=o.join("/")),t.require("http").redirect(o)})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){var i=t.require("form"),a=t.require("websocket");e("#modal-save-as").on("submit","form",function(o){o.preventDefault(),a.clearAll(),i.clearErrors();var n=e(this);n.find(".input.error").removeClass("error");var s=n.find('input[name="clone[name]"]'),r=n.find('input[name="clone[version]"]');if(s.val().length){var l=n.closest(".modal");a.request({data:{clone:{name:s.val(),version:r.val(),structure:t.require("sitemap").getSerialized()}},$loading:n.find(".loading").css({visibility:"visible"}),success:function(e){e.success&&e.redirect?t.require("http").redirect(e.redirect):e.error&&t.require("notification").error(e.error),l.dialog("close")},error:function(){l.dialog("close")}})}else i.error(s.parent(),t.__("Sitemap name must not be empty"),{bottom:6})})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){var a=t.require("form"),o=t.require("websocket"),n=t.require("config"),s=t.require("notification");e("#modal-change-name, #modal-save-version").on("submit","form",function(r){r.preventDefault(),o.clearAll();var l=e(this),c=l.find('input[name="change[name]"]'),d=l.find('input[name="change[version]"]');a.clearErrors(l);var u=a.validate([{value:c.val(),tiperror:c.parent(),rules:{empty:t.__("Name must not be empty")},css:{bottom:5}},{value:d.val(),tiperror:d.parent(),rules:{empty:t.__("Version must not be empty"),regexp:[/^[0-9]+(\.[0-9]+)?$/,t.__("Invalid version number")]},css:{bottom:5}}]);if(u){var p=l.closest(".modal"),m=a.serializeObject(l);l.parent("#modal-save-version").length&&(m.change.structure=t.require("sitemap").getSerialized()),o.request({data:m,$loading:l.find(".loading").css({visibility:"visible"}),success:function(a){if(a.success){if(a.redirect)return void t.require("http").redirect(a.redirect);var o=n.get("sitemap",null),r="";a.title!==i&&(e("#sitemap-name h1 > span, #sitemap-comments-top h1").text(a.title),document.getElementById("form-change-name").defaultValue=a.title,e("#form-saveversion-name").val(a.title),r="name",o.title=a.title),a.version!==i&&(e("#sitemap-name h2, #sitemap-comments-top h2").text("Version "+a.version),document.getElementById("form-change-version").defaultValue=a.version,r="version",o.title=a.version),a.title!==i&&a.version!==i&&(r="name and version"),n.set("sitemap",o),r&&s.success(t.__("New sitemap "+r+" saved"))}else a.error&&s.error(a.error);p.dialog("close")},error:function(){p.dialog("close")}})}})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap route/plainsitemap",function(i){var a=t.require("string"),o=0,n={},s=function(i,n){var s=0;i.find(".tab:not(.add)").each(function(){s+=e(this).outerWidth()-3}),s&&(s+=3);var r=!1,l=i.width()-115;s>l?(r=!0,i.addClass("scrollable"),i.find(".overflow").width(l)):(i.removeClass("scrollable"),i.find(".overflow").width(s));var c=0;if(n){if(r&&(c=l-s),n instanceof e)d=n;else{var d=i.find(".tab").not(".add").filter(":last");d.length||(d=i.find(".overflow .wrapper").append('<div class="tab current">'+a.charsEncode(t.__("Untitled"))+"</div>"))}d.trigger("click",[!0])}else if(r){var u=i.find(".tab.current");u.prevAll(".tab").each(function(){c+=e(this).outerWidth()-3}),c&&(c+=3),c=Math.max(l-s,-c)}return o=c,i.find(".overflow .wrapper").css({marginLeft:c}),r},r=function(i,a){var n="#diagrams-tabs-next, #diagrams-tabs-prev, #sections-tabs-next, #sections-tabs-prev";i.on("mouseenter click",".tab:not(.main):not(.add)",function(t,a){if("click"!==t.type||a!==!0){var o=i.find(".overflow"),n=e(this),s=n.prev(".tab").length,r=0;if(n.hasClass("current"))r+=4,s&&(r-=3);else if(s){var l=n.next(".tab").length;l&&(r=-3)}i.children(".edit").show().css({left:Math.min(o.offset().left+o.width(),n.offset().left+n.outerWidth()+r)-16}).data("tab",this)}}).on("mouseleave",function(){i.children(".edit").hide()}).on("mouseenter",n,function(){i.children(".edit").hide()}).on("click",n,function(t){t.preventDefault();var i="diagrams-tabs-next"===this.id||"sections-tabs-next"===this.id,a=e(this).closest(".tabs"),n=0;a.find(".tab:not(.add)").each(function(){n+=e(this).outerWidth()-3}),n&&(n+=3);var s=a.width()-115;if(n>s)if(i){var r=3;a.find(".tab:not(.add)").each(function(){return r+=e(this).outerWidth()-3,r>-o?!1:void 0}),r=Math.min(n-s,r),o=-r}else a.find(".tab:not(.add)").reverse().each(function(){return n-=e(this).outerWidth()-3,3>=n&&(n=0),-n>o?!1:void 0}),o=Math.min(0,-n);else o=0;a.find(".overflow .wrapper").css({marginLeft:o})}).on("dblclick",".tab:not(.main):not(.add)",function(){t.publish("sitemap/"+a+"/tab_edit",[e(this)])}).on("click",".edit",function(){var i=e(e(this).data("tab"));t.publish("sitemap/"+a+"/tab_edit",[i])})};t.subscribe("sitemap/lightbox/tabs_scrollable",function(e,t,i){var a=t.closest(".lightbox-dark").attr("id");n[a]||(r(t,a),n[a]=!0),s(t,i)})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){function a(){t.$body.removeClass(function(e,t){return(t.match(/(^|\s)expanded-\S+/g)||[]).join(" ")})}function o(i){var a=n.getBatchData();s.forEach(a.selected_cells,function(e,t){n.toggleCellMaskHighlight(t,"disable",!0)}),n.resetBatchData(),e("#batch-cell-names").val(""),e("#action-batch-cell-color-reset").trigger("click"),e("#action-batch-text-color-reset").trigger("click"),c.find(".ui-selectmenu.batchediting.archetype > .ui-selectmenu-status").html(t.__("Add Page Type")),c.find(".icon.border").html(""),c.find(".ui-selectmenu.batchediting.desc").data("batchdata","").children(".ui-selectmenu-status").html(t.__("Add Note")),c.find(".ui-selectmenu.batchediting.url").data("batchdata","").children(".ui-selectmenu-status").html(t.__("Add Link"))}var n=t.require("sitemap"),s=t.require("svg"),r=t.require("notification"),l=t.require("helper"),c=e("#sitemap-batch-edit"),d=!(t.currentUserCan("batch_editing")&&c.length),u="";e("#action-batch").on("click",function(e){return e.preventDefault(),d?t.noPermissions():n.isEditBlocked(i,"sitemap")?!1:(o(),a(),t.$body.addClass("expanded-batch"),void n.batchEditStart())}),e("#sitemap-comments-top").on("click","button.submit",function(e){return e.preventDefault(),d?t.noPermissions():n.isEditBlocked(i,"sitemap")?!1:(a(),void n.batchEditStop(!0))}).on("click","button.reset",function(i,o){if(i.preventDefault(),e(this).hasClass("isbatch")||t.$body.hasClass("expanded-batch")){var r=n.getBatchData(),c=!1;!o&&r&&r.changes&&s.forEach(r.changes,function(){return c=!0,!1}),c?l.confirmDialog({id:"batch_button_reset",checkbox:!0,title:t.__("You have changes pending! Are you sure you want to cancel?"),text:t.__("Your changes will be lost."),on_yes:function(){a(),n.batchEditStop()}}):(a(),n.batchEditStop())}}),c.on("focus","#batch-cell-names",function(t){u=e.trim(this.value)}).on("blur","#batch-cell-names",function(t){var i=e.trim(this.value);i!==u&&""!==i&&n.batchTextEdit(i)}).on("keydown.return","#batch-cell-names",function(t){var i=e.trim(this.value);""!==i&&n.batchTextEdit(i)}).on("click","#batch-delete-all",function(e){var i=n.getBatchData();i.selected_cells_count>0?l.confirmDialog({id:"batch_delete_cells",checkbox:!0,title:t.__("Would you like to delete selected pages?"),on_yes:function(){n.batchRemoveCell()}}):r.error("Select pages to delete",{persistent:!1})}).on("click","#action-batch-cell-color-reset",function(e){c.find(".colors.batch-cell .color-box").css({backgroundColor:"transparent",borderWidth:"1px"}),n.batchRemoveCellColor()}).on("click","#action-batch-text-color-reset",function(e){c.find(".colors.batch-text .color-box").css({backgroundColor:"transparent",borderWidth:"1px"}),n.batchRemoveCellTextColor()})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap route/plainsitemap",function(a){var o,n,s,r="route/sitemap"===a.type?t.require("websocket"):t.require("ajax"),l=t.require("config"),c=t.require("form"),d=t.require("svg"),u=t.require("string"),p=t.require("sitemap"),m=t.require("helper"),f=t.require("notification"),h=e("#lightbox-cell-content"),g=null,v=e("#content-gathering-table").find("tbody"),b=e("#content-gathering-progress"),_=e("#lightbox-submenu-content"),y=e("#content-gathering-progress-wrapper").find(".statuses"),w=e("#content-gathering-wrapper"),C="",k="",x=l.get("allow_edit",!1),S=!0,D={},q=!(t.currentUserCan("content_gathering")&&h.length),E=e("#slickplan-sitemap").data("id")||0,A={},T={},z=!1,$=!1,L=!1,O=e("html").hasClass("browserWebkit"),I=[],j=l.get("workflow",{}),P=j&&j.statuses?j.statuses:[],N={},U=!1,R=!1,M=!1,F=!1,B=t.$body.hasClass("account-contributor"),W=l.get("me"),H={},K=!1,G=function(i){m.wysiwygInit(i,!0,{plugins:"autoresize",autoresize_min_height:150,autoresize_max_height:Math.max(400,t.$window.height()-200),height:150,content_css:"/static/tinymce/content.plain.css",setup:function(t){t.on("blur",function(){var i=""+e(t.targetElm).val();t.save();var a=""+e(t.targetElm).val();i!==a&&ae()})}})},Y=function(t){window.autosize&&t&&t.length&&t.find("textarea.table-text:not(.autosize)").each(function(){e(this).addClass("autosize").on("autosize:resized",function(){o&&o.length&&o.is(":visible")&&n&&n.length&&o.height(n.innerHeight()+(O?2:0))}),window.autosize(this)})},V=function(e){window.autosize&&e&&e.length&&e.find("textarea.autosize").each(function(){autosize.update(this)})},J=function(i,a,n,s){if(i){var r={element:i,id:u.random(16),id_random:u.random(20),options:{},template_view:K};a&&e.extend(r,a);var l=null;if((s||"undefined"===e.type(s))&&(l=m.template("content-gathering-element",r),s=!0),s||l||(l=m.template("content-gathering-element-preview",r),s=!1),l){var c=e(l);if(c.data("type",i).data("options",r.options),n?n.replaceWith(c):g&&g.length&&c.appendTo(g),s){switch(c.find(".content-gathering-reorder").disableSelection(),i){case"text":c.find("textarea:not(.autosize)").each(function(){e(this).css({"min-height":103,"max-height":600}).addClass("autosize"),window.autosize(this)});break;case"wysiwyg":G(r.id_random);break;case"table":Y(c),c.find(".table").on("scroll",function(){o&&o.length&&o.hide()});break;case"image":case"video":case"file":var d=c.find(".uploadbutton");if(d.length){var p=d.attr("id");t.publish("upload/dynamic_uploader/init",[d.get(0),"contentgathering",p,i])}r.content&&r.content.type&&(c.data("subtype",r.content.type),"library"===r.content.type&&r.content.file_id&&c.data("file_id",r.content.file_id)),c.find(".form-url").trigger("change")}ae()}return c}}return!1},Z=function(e,t){return x&&C&&e?(D||(D={}),D[C]||(D[C]={}),D[C][e]||(D[C][e]={}),D[C][e].value&&D[C][e].value===t?!1:(D[C][e]={multiple:0,autoload:0,value:t},!0)):!1},X=function(){var e=!1;return d.forEach(D,function(){return e=!0,!1}),e},Q=function(i,a){R=!0,z||(S&&clearTimeout(F),Z(i,a),t.has_unsaved_changes.content=!0,S&&(F=setTimeout(function(){e("#content-gathering-save").trigger("click",[!0])},100)))},ee=function(t,i){t=(""+t).replace(/^[\/]+/,"");var a=e("#content-gathering-view-url").hide(),o=l.get("site_settings",{}),n=o.url?o.url+t:"/"+t,s=n.indexOf(":")>-1||n.indexOf("//")>-1;if(i){var r=e("#content-gathering-page-url").hide();s&&a.attr("href",n).show(),r.show().text(n).data("slug",t),Q("content_url_slug",t),h.find(".meta-field").filter(":first").trigger("keyup")}else a.length&&a.text(n).attr("href",n).show().parent().show();return[n,s]},te=function(e,t,i){var a='<div class="reset"></div>';if("image"===t)e.css("background-image",""),""===i?e.html(a):(e.html('<i class="fa fa-refresh fa-spin"></i>'+a),i&&/^(https?:)?\/\/.+/i.test(i)?window.checkImage(i,function(){e.html(a).css("background-image","url('"+i+"')"),ae()},function(){e.html('<i class="fa fa-exclamation-triangle"></i>'+a)}):e.html('<i class="fa fa-exclamation-triangle"></i>'+a));else if("video"===t)i.match(/(http:|https:|)\/\/(player.|www.)?(vimeo\.com|youtu(be\.com|\.be|be\.googleapis\.com))/),RegExp.$3.indexOf("youtu")>-1?parsed="youtube":RegExp.$3.indexOf("vimeo")>-1?parsed="vimeo":parsed="video-camera",e.addClass("favicon").html('<i class="fa fa-'+parsed+'"></i>'+a);else{var o="";if(/^http/.test(i)){var n=document.createElement("a");n.href=i.split("#")[0],o=n.pathname.replace(/^\/|\/$/g,"").split("/").pop(),/\.[a-z0-9]{1,5}$/i.test(o)||(o="")}e.removeClass("favicon no-thumb"),o?(e.addClass("no-thumb").html('<div class="file-name-wrapper"><span class="file-name"><div class="fa-wrapper"><i class="fa fa-file"></i></div><div class="sandbox"></div></span></div>'+a),e.find(".sandbox").text(o)):e.addClass("favicon").html('<i class="fa fa-file"></i>'+a)}},ie=function(t){var i=[];return g&&g.length&&g.find(".content-gathering-element").each(function(){var a=t?"":!1,o=e(this),n=o.data("type");switch(n){case"wysiwyg":if(!t){var s=o.find("textarea"),r=m.wysiwyg(s.attr("id"));r?(r.save(),a=r.getContent()):a=s.val()}break;case"text":t||(a=o.find("textarea").val());break;case"image":case"video":case"file":if(a={},!t){var l=o.data("subtype");switch(l){case"url":a={type:l,url:o.find("input.form-url").val()};break;case"library":a={type:l,file_id:o.data("file_id")}}a&&a.type&&("image"===n?(a.alt=o.find("input.form-alt").val()||"",a.title=o.find("input.form-title").val()||""):a.description=o.find("textarea.form-about").val()||"")}break;case"table":var c=o.find("table").children("tbody");a={rows:c.children("tr").length,cols:c.children("tr").filter(":first").children("td").length,data:[]},t||c.children("tr").each(function(t,i){var o=[];e(i).children("td").each(function(t,i){o.push(e(i).find("textarea").val())}),a.data.push(o)})}if(a!==!1){var d={},u=o.data("options")||{};if(u&&u.tag)switch(d.tag=u.tag,u.tag){case"html":d.tag_html_before=u.tag_html_before,d.tag_html_after=u.tag_html_after;break;default:d.tag_class=u.tag_class,d.tag_id=u.tag_id}i.push({id:o.data("id"),type:n,content:a,options:d})}}),i},ae=function(){if(R=!0,!M){var e=ie();T[C]=!!e.length,Q("content_body",e)}},oe=function(t,i,a){e.each(t,function(t,o){if(o&&o.text){var n=o.level&&"number"===e.type(o.level)&&o.level>1?parseInt(o.level,10)-1:0,s=!!o.childs;a?se(o,n):ne(o,n,s,i),s&&oe(o.childs,o.id,a)}})},ne=function(t,i,a,o){if(!t||!t.contents)return!1;var n="_unknown",s=!1;t.contents.status&&(s=de(t.contents.status,!0),s!==!1&&(n=t.contents.status));var r=!1;if(t.contents.assignee){var c=l.get("users_list",{});c[t.contents.assignee]&&c[t.contents.assignee].name&&(r=c[t.contents.assignee].name)}"number"!==e.type(A[n])&&(A[n]=0),++A[n];var d=t.contents.template&&N[t.contents.template]?t.contents.template:!1,u=m.template("content-gathering-dashboard-row",{cell_id:t.id,cell_name:t.text,assignee:t.contents.assignee,assignee_name:r,indent:i>0?i:0,status:n,workflow_status:s===!1?!1:P[s],date:t.contents.last_modified,has_childs:a,parent:o,template_id:d,template:d?N[t.contents.template]:!1});u&&v.append(u)},se=function(e,t){if(!e||!e.contents)return!1;var i="";e.contents.assignee&&(i=' class="assignee-'+e.contents.assignee+'"'),t=t>0?t:0,_.find(".menu-list").append("<li"+i+'><a href="#" data-cellid="'+e.id+'" class="data-cellid-'+e.id+'" style="padding-left: '+(10*t+10)+'px;">'+u.charsEncode(e.text)+"</a></li>")},re=function(){var t={},i=0;e("#form-cell-content-my-pages").is(":checked")?v.find("tr").filter(":visible").each(function(){var a=e(this).find("div.status").data("status");t[a]||(t[a]=0),++t[a],++i}):(t=A,e.each(t,function(e,t){i+=t}));var a=100;fe(t);var o="";e.each(P,function(e,n){if(t[n.alias]){var s=Math.max(.6,Math.round(100*(t[n.alias]/i)));0>=a-s&&(s=a),a-=s,o+='<div class="progress status-'+n.alias+'" style="width: '+s+"%;background-color: "+n.color+'"></div>'}}),a>0&&(o+='<div class="progress status-_unknown" style="width: '+a+'%;"></div>'),b.html(o)},le=function(t,i){"dashboard"!==t&&"loads"!==t&&"content"!==t&&"templates"!==t||(M=!1,C=null,K=!1,h.data("template",""),h.removeClass("dashboard loads content templates content-templates content-templates-new").addClass(t),i&&(h.addClass(i),i=i.split(" "),e.inArray("content-templates",i)>=0&&(K=!0)))},ce=function(t){var i=m.template("content-gathering-wrapper-"+(t?"edit":"view"));w.html(i).toggleClass("preview",!t),g=w.find("#content-gathering-workarea");var a=l.get("site_settings",{});if(!a.url||"http://"===a.url||"https://"===a.url)if(t){var o=l.get("account");o&&o.is_contributor&&e("#content-gathering-element-title").find(".content-url-wrapper").remove()}else w.find("#content-gathering-view-url").parent().remove()},de=function(t,i){var a=!1;return e.each(P,function(e,o){return t===o.alias?(a=i?e:!0,!1):void 0}),a},ue=function(i,a){z=!0,le("content"),h.addClass("is-viewer"),C=i;var o=e("#sitemap-comments-top");w.html('<div class="elements-loading hide-content-templates" style="display:block"><i class="fa fa-refresh fa-spin"></i></div>');var n=""+p.getCellData(C,p.getOption("data_text"));e("#lightbox-cell-content-name").text(n);var s=l.get("sitemap",null);e("#lightbox-sitemap-subtitle").text((s&&s.title?s.title:o.find("h1").text())+" | "+(s&&s.version?"Version "+s.version:o.find("h2").text()));var c=["content_body","content_template","content_assignee","content_status","content_page_title","content_url_slug","content_meta_focus_keyword","content_meta_title","content_meta_description"];r.request("get_cell_datas",{data:{sitemap_id:E,cell_id:C,datas:c,load_templates:!0},success:function(i){var o=p.getUser(H[C]),n=x&&!B&&!o,s={title:"",description:"",url:""};if(i&&i.success){i.templates&&(N=i.templates),B&&!o&&(n=x&&("undefined"===e.type(i.content_assignee)||"object"===e.type(i.content_assignee)&&"undefined"!==e.type(i.content_assignee.value)&&(""===i.content_assignee.value||null===i.content_assignee.value||parseInt(i.content_assignee.value,10)===parseInt(W.id,10)))),
    n&&t.publish("sitemap/content_planner/edit_start",[C]),h.toggleClass("is-viewer",!n),ce(n),n&&we(),ge(!n);for(var r=0,l=c.length;l>r;++r){var d,g,v=c[r].replace("content_","");switch(v){case"template":n&&i[c[r]]&&i[c[r]].value&&N[i[c[r]].value]&&(h.data("template",i[c[r]].value),ge(!0));break;case"assignee":case"status":if(n){var b=e("#content-gathering-editor-"+v);if(b.length){b.selectmenuslickplan("destroy");var _="";i[c[r]]&&"undefined"!==e.type(i[c[r]].value)&&""!==i[c[r]].value&&null!==i[c[r]].value&&("status"===v?de(i[c[r]].value)&&(_=i[c[r]].value):_=i[c[r]].value),b.val(_),b.selectmenuslickplan({style:"popup",maxHeight:t.$window.height()/2})}}else{var y=w.children("h1").children(".status");if(i[c[r]]&&"undefined"!==e.type(i[c[r]].value)&&de(i[c[r]].value)){var k="",S="",D=de(i[c[r]].value,!0);D!==!1&&P[D]&&P[D].name&&(k=P[D].name,S=P[D].color),y.show().attr("class","status status-"+i[c[r]].value).attr("title",k).css("background-color",S)}else y.hide()}break;case"page_title":d=i[c[r]]&&"undefined"!==e.type(i[c[r]].value)?i[c[r]].value:p.getCellData(C,p.getOption("data_text")),n?e("#form-content-gathering-page-title").val(d):(w.children("h1").children(".page-title").text(d),""===s.title&&(s.title=d));break;case"body":if(i[c[r]]&&"undefined"!==e.type(i[c[r]].value)&&e.isArray(i[c[r]].value))for(var q=0,E=i[c[r]].value.length;E>q;++q)i[c[r]].value[q]&&i[c[r]].value[q].type&&J(i[c[r]].value[q].type,i[c[r]].value[q],!1,n);break;case"url_slug":g=i[c[r]]&&"undefined"!==e.type(i[c[r]].value)?i[c[r]].value:u.sanitize(d,"-");var A=ee(g,n);""===s.url&&A&&A.length&&(s.url=A[0]);break;default:i[c[r]]&&"undefined"!==e.type(i[c[r]].value)&&(n?h.find('input[name="'+c[r]+'"], textarea[name="'+c[r]+'"]').val(i[c[r]].value):"meta_title"===v?s.title=i[c[r]].value:"meta_description"===v&&(s.description=i[c[r]].value))}}}else ce(n),n&&(t.publish("sitemap/content_planner/edit_start",[C]),we());if(o&&o.full_name&&f.info(o.full_name+" is currently editing this page"),"function"===e.type(a)&&a(i),z=!1,w.find(".elements-loading").remove(),n)h.find(".meta-field").filter(":first").trigger("keyup");else{""===s.title&&(s.title=p.getCellData(C,p.getOption("data_text"))),s.description&&(s.description=s.description.substring(0,156));var T=m.template("content-gathering-seo-serp",s);T?h.find(".meta-google-serp").html(T).closest("#content-gathering-metadata").show():h.find("#content-gathering-metadata").hide()}}})},pe=function(t,i){$&&!i?"function"===e.type(t)&&t():r.request("get_content_dashboard",{data:{sitemap_id:E,section_id:p.getCurrentSection(),load_templates:!0},success:function(i){i&&i.success&&i.pages&&($=i.pages),i&&i.success&&i.templates&&(N=i.templates),"function"===e.type(t)&&t(i),z=!1}})},me=function(t){if(x){le("dashboard");var i=e("#sitemap-comments-top");e("#lightbox-cell-content-name").html(i.find("h1").html()),e("#lightbox-sitemap-subtitle").text(i.find("h2").text());var a=v.closest("table").find("thead th").length;v.empty().html('<tr><td colspan="'+a+'" class="loading"><i class="fa fa-refresh fa-spin"></i></td></tr>'),pe(function(i){i&&i.templates&&(N=i.templates),v.empty(),A={},$.home&&ne($.home),$.util&&oe($.util),$[1]&&oe($[1]),$.foot&&oe($.foot),re(),be(),"function"===e.type(t)&&t(i)},!0)}},fe=function(t){var i=e("#content-gathering-editor-status");if(P&&i.length){var a="";"undefined"===e.type(t)&&(t=A),he(i,P,function(e,o){var n='<div class="status status-'+o.alias+'" style="background-color: '+o.color+'"></div>';i.append('<option value="'+o.alias+'" data-html="'+u.charsEncode(n)+'">'+u.charsEncode(o.name)+"</option>");var s=t[o.alias]?" <small>("+t[o.alias]+")</small>":"";a+='<li class="label" data-index="'+e+'"><span>'+n+" "+u.charsEncode(o.name)+s+"</span>",B||(a+='<span class="act delete"></span><span class="act edit"></span>'),a+="</li>"}),y.html(a),P.length>1?y.find(".delete").removeClass("disabled"):y.find(".delete").addClass("disabled")}},he=function(i,a,o){i.children('option:not([value=""])').remove(),e.each(a,o),i.selectmenuslickplan("destroy"),i.selectmenuslickplan({style:"popup",maxHeight:t.$window.height()/2})},ge=function(t){if(g&&g.length)if(t){g.parent().addClass("elements-locked");var i=h.data("template");i&&N[i]&&e("#content-template-info").show().find(".template-name").text(N[i].name)}else g.parent().removeClass("elements-locked"),e("#content-template-info").hide()},ve=function(t,i){r.request({data:{new_workflow_statuses:P},success:function(a){a&&a.statuses&&(j.statuses=P=a.statuses,l.set("workflow",j),i||(re(),fe())),"function"===e.type(t)&&t(a)}})},be=function(){v.children("tr").removeClass("odd").filter(":visible").filter(":odd").addClass("odd")},_e=e("#colorpicker-workflow");e.farbtastic&&_e.length&&(s=_e.farbtastic(function(t){e("#form-workflow-status-color").val(t).trigger("change")}),_e.closest(".modal").on("change keyup","#form-workflow-status-name, #form-workflow-status-color",function(){var t=e("#form-workflow-status-name").val(),i=e("#form-workflow-status-color").val();if(t&&/^#([a-f0-9]{3}|[a-f0-9]{6})$/i.test(i)){var a='<div class="status" style="background-color: '+i+'"></div>';t&&(a+=" "+u.charsEncode(t)),e("#workflow-status-preview").html(a).parent().show()}}).on("submit","form",function(t){t.preventDefault();var i=e(this),a=e("#form-workflow-status-name"),o=e("#form-workflow-status-color"),n=e.trim(a.val()),s=o.val();c.clearErrors(i),""!==n&&/^#([a-f0-9]{3}|[a-f0-9]{6})$/i.test(s)?(U!==!1&&P[U]?(P[U].name=n,P[U].color=s,P[U].alias&&v.find(".status-"+P[U].alias).css("background-color",s)):P.push({name:n,color:s}),ve(function(){i.closest(".modal").dialog("close")})):""==n?c.error(a.parent(),"Please enter a new status name",{bottom:4}):c.error(o.parent(),"Please enter a valid color value",{bottom:4})}));var ye=function(t,i){t.selectmenuslickplan("destroy"),t.find("option").not(":first").remove();var a="";e.each(N,function(e,t){t&&t.name&&t.elements&&(a+='<option value="'+e+'">'+u.charsEncode(t.name)+"</option>")}),t.append(a),i&&t.val(i),t.selectmenuslickplan({style:"popup",maxHeight:300})},we=function(){g&&g.length&&g.sortable({handle:".content-gathering-reorder",update:function(){setTimeout(function(){ae()},100)},start:function(e,t){if(t.item&&t.item.hasClass("content-gathering-element-wysiwyg")){var i=t.item.find("textarea");if(i.length){var a=i.attr("id"),o=m.wysiwyg(a);o&&o.save(),m.wysiwygDestroy(a)}}},stop:function(e,t){if(t.item&&t.item.hasClass("content-gathering-element-wysiwyg")){var i=t.item.find("textarea");if(i.length){var a=u.random(16);i.attr("id",a),G(a)}}}})},Ce=function(t,i){var a=t.closest("li.content-gathering-element");if(a.find(".element-wrapper").show(),i.alias&&a.data("file_id",i.alias).data("subtype","library").find(".wrapper-url").remove(),t.attr("class","preview"),i.url_thumb)t.html('<div class="reset"></div>').css("background-image","url('"+i.url_thumb+"')");else if(i.fa_icon&&i.name){var o='<div class="file-name-wrapper"><span class="file-name"><div class="fa-wrapper"><i class="fa fa-'+i.fa_icon+'"></i></div><div class="sandbox"></div></span></div><div class="reset"></div>';t.css("background-image","").addClass("no-thumb").html(o).find(".sandbox").text(i.name)}i.url_download&&e('<div class="download"><i class="fa fa-download"></i></div>').attr("title","Download: "+i.name).data("url",i.url_download).insertAfter(t.find(".reset"))};t.subscribe("websocket/content_planner/edit_start",function(e,t){t&&t.page_id&&t.user_id&&(H[t.page_id]=parseInt(t.user_id,10))}),t.subscribe("websocket/content_planner/edit_end",function(t,a){a&&("number"===e.type(a)||"string"===e.type(a)?(a=parseInt(a,10),e.each(H,function(e,t){t===a&&(H[e]=i,delete H[e],C===e&&ue(C))})):a.page_id&&a.user_id&&H[a.page_id]&&H[a.page_id]==a.user_id&&(H[a.page_id]=i,delete H[a.page_id],C===a.page_id&&ue(C)))}),t.subscribe("sitemap/content_planner/edit_start",function(e,t){k=t}),t.addFilter("websocket_pub_user_connected websocket_pub_user_connected_callback",function(t){return C&&k&&t&&"object"===e.type(t)&&(t.content_planner_page_edit=k),t}),B||y.sortable({forcePlaceholderSize:!0,update:function(){var t=[];y.find(".label").each(function(){var i=e(this).data("index");P[i]&&t.push(P[i])}),P=t,ve()}}),e("#content-gathering-table-wrapper").on("click","button[data-openmodal]",function(i){i.preventDefault();var a=v.find('td input[type="checkbox"]:checked').closest("tr").filter(":visible");if(a.length){f.clearAll();var o=e(this).data("openmodal"),n=e("#modal-"+o);e(this).hasClass("assign-templates")?n.addClass("template-mode"):n.removeClass("template-mode"),t.publish("modal/before_open/modal-"+o,[n]),n.dialog("open")}else f.error("Select at least one page",{persistent:!1})}),h.on("click","#content-save-template-changes",function(t,i){t.preventDefault();var a=ie();if(!a.length)return f.error("Please add at least one content block",{persistent:!1}),!1;var o=e(this),n=function(t){var n=o.find(".fa");n.attr("class","fa fa-fw fa-refresh fa-spin"),r.request({data:{save_template_id:t||"",save_template_data:{name:t&&N[t]?N[t].name:e("#lightbox-template-content-name").text()||"Untitled",lock:!0,elements:a,metadata:{title:e("#form-content-gathering-seo-title").val(),description:e("#form-content-gathering-meta-desc").val(),keywords:e("#form-content-gathering-meta-keywords").val()}}},success:function(a){R=!1,h.removeClass("content-templates-new"),a&&(a.success?(a.templates&&(N=a.templates),a.template_id&&h.data("template",a.template_id),f.success("Template saved")):a.error&&f.success(a.error)),"function"===e.type(i)&&i(t),n.attr("class","fa fa-fw fa-check")},error:function(){n.attr("class","fa fa-fw fa-check")}})},s=h.data("template");s&&N[s]&&N[s].pages_count?m.confirmDialog({title:"Confirm changes",text:"Any changes you make will apply to all pages using this template. For example, if you removed an element it will be removed from all pages using this template.",on_yes:function(){n(s)},yes_label:"Save changes",no_label:"Cancel"}):n(s)}),y.on("click",".edit",function(){var t=e(this).closest(".label").data("index");P[t]&&(U=t,e("#modal-new-workflow-status").dialog("open"))}).on("click",".delete",function(){var t=e(this).closest(".label").data("index");if(P[t]){var i=P[t].alias;m.confirmDialog({title:"Confirm deletion",text:'Are you sure you would like to delete "'+u.charsEncode(P[t].name)+'" status?',on_yes:function(){delete P[t],ve(function(e){i&&e&&e.statuses&&me()},!0)}})}}),v.on("click",".expcoll",function(){var t=e(this),i=t.closest("tr").data("cellid"),a=e(this).hasClass("expanded");a?(t.removeClass("expanded").addClass("collapsed"),v.find("tr.parent-"+i).hide().find(".expcoll.expanded").trigger("click")):(t.removeClass("collapsed").addClass("expanded"),v.find("tr.parent-"+i).show()),be()}).on("click",".cell-name",function(t){t.preventDefault(),ue(e(this).closest("tr").data("cellid"))}),h.on("click","#content-gathering-toolbar button",function(t){t.preventDefault();var i=this.id.replace("content-gathering-action-","");if("table-dropdown"===i){var a=e("#content-gathering-table-drop"),o=e(this).position();a.css("left",o.left-a.width()/2-5).show().find("input.columns, input.rows").val(2),e("#content-gathering-table-drop-overlay").show()}else{var n={};"image"!==i&&"file"!==i&&"video"!==i||(n.is_upload=!0),J(i,n)}}).on("click","#content-gathering-toolbar button.submit",function(){var t=e("#content-gathering-table-drop");t.hide();var i=parseInt(t.find("input.columns").val(),10),a=parseInt(t.find("input.rows").val(),10);(!i||0>i||isNaN(i))&&(i=2),(!a||0>a||isNaN(a))&&(a=2),J("table",{columns:i,rows:a})}).on("click","#content-gathering-toolbar button.plus, #content-gathering-toolbar button.minus",function(){var t=e(this).siblings("input"),i=parseInt(t.val(),10);(!i||0>i||isNaN(i))&&(i=0);var a=t.hasClass("columns")?30:100;i+=e(this).hasClass("plus")?1:-1,i=Math.min(a,Math.max(1,i)),t.get(0).value=i}).on("keyup","#content-gathering-toolbar input.columns, #content-gathering-toolbar input.rows",function(){var t=parseInt(this.value.replace(/[^0-9]+/g,""),10);(!t||0>t||isNaN(t))&&(t=0);var i=e(this).hasClass("columns")?30:100;t=Math.min(i,Math.max(1,t)),this.value=t}).on("click","#content-template-modal-open",function(t){t.preventDefault();var i=e("#modal-content-templates-dialog");i.dialog("open"),i.dialog("option","height",335),i.find("#form-content-templates-new").prop("checked",!0).trigger("change").end().find('input[type="submit"]').val("Continue")}).on("click",".circle.reset",function(e){e.preventDefault(),t.publish("sitemap/lightbox_cell_content/close")}).on("click",".content-gathering-options-menu",function(){I=e(this).closest("li.content-gathering-element");var i=e("#map-dropdown").attr("class","content-gathering");t.publish("sitemap/dropdown_before_open",[i,null,"content-gathering"]);var a=e(this).offset();i.show().css({top:a.top+35,left:a.left-64}).before('<div id="map-dropdown-overlay" style="display: block" />')}).on("click",".button-show-hide",function(t){t.preventDefault();var i=e(this);i.is("label")&&(i=i.siblings("a.show-hide")),i.hasClass("expanded")?i.removeClass("expanded").addClass("collapsed").next("div").hide():i.removeClass("collapsed").addClass("expanded").next("div").show()}).on("change",".save-on-change",function(){Q(this.name,this.value)}).on("change",".wrapper-url input, .wrapper-url textarea, .wrapper-inputs input",function(){ae()}).on("change","#form-cell-content-my-pages",function(){this.checked?W&&W.id&&(v.find("tr").hide().filter(".assignee-"+W.id).show(),v.find(".expcoll").hide(),_.find(".menu-list").children("li").hide().filter(".assignee-"+W.id).show()):(v.find("tr").hide().not(".is-child").show(),v.find(".expcoll").css("display","inline-block").filter(".expanded").removeClass("expanded").addClass("collapsed").trigger("click"),_.find(".menu-list").children("li").show()),re(),be()}).on("click","#content-gathering-edit-url, #content-gathering-page-url",function(t){t.preventDefault();var i=l.get("site_settings",{});i.url?m.confirmDialog({close:!0,input:!0,input_text:e("#content-gathering-page-url").data("slug")||"",input_prepend:i.url,title:"Edit URL",yes_label:"Save Changes",no_label:!1,width:650,on_yes:function(e,t,i){ee(i.val(),x)}}):f.error('Please enter the site address in <a href="#" data-modal="site-settings">Site Settings</a> first')}).on("keyup","#form-content-gathering-meta-desc",function(){e("#content-gathering-meta-desc-chars").text(156-this.value.length)}).on("click",".menu-button",function(){_.toggleClass("open").hasClass("open")&&pe(function(){var t=_.find(".menu-list").empty();$.home&&se($.home),$.util&&oe($.util,i,!0),$[1]&&oe($[1],i,!0),$.foot&&oe($.foot,i,!0),e("#form-cell-content-my-pages").is(":checked")&&W&&W.id&&t.children("li").hide().filter(".assignee-"+W.id).show(),be()})}).on("click","#content-gathering-save",function(i,a){if(i.preventDefault(),f.clearAll(!0),X()){clearTimeout(F);var o=e(this).find(".fa");o.attr("class","fa fa-fw fa-refresh fa-spin"),r.request({data:{cell_datas:D},success:function(){D={},t.has_unsaved_changes.content=!1,a||f.success("Content saved."),o.attr("class","fa fa-fw fa-check")},error:function(){o.attr("class","fa fa-fw fa-check")}})}else a||f.success("Content saved.")}).on("keyup",".meta-field, #form-content-gathering-page-title",function(){var t=e("#content-gathering-page-url").text().replace(/https?:\/\//i,""),i=m.template("content-gathering-seo-serp",{title:e("#form-content-gathering-seo-title").val()||e("#form-content-gathering-page-title").val(),url:t,description:e("#form-content-gathering-meta-desc").val().substring(0,156)});i&&e(".meta-google-serp").html(i)}).on("click","#content-gathering-table-drop-overlay",function(){e("#content-gathering-table-drop").hide(),e(this).hide()}).on("change","#content-gathering-workarea textarea",function(){ae()}).on("mouseleave","#content-gathering-workarea .content-gathering-element-table",function(){return L||!x?!1:(o&&o.length&&o.hide(),void e(this).find("td").removeClass("active"))}).on("click","#content-gathering-workarea .content-gathering-element-table td",function(){if(x){var t=e(this).find("textarea");t.is(":focus")||t.putCursorAtEnd()}}).on("mouseenter","#content-gathering-workarea .content-gathering-element-table td",function(t,i){if(x){i||(L=!1),o&&o.length||(o=e('<div id="table-dropdown-button"><i class="fa fa-caret-down"></i></div>').appendTo(h)),n=e(this);var a=n.closest(".content-gathering-element-table");a.find("td").removeClass("active"),n.addClass("active");var s=e.extend({},n.offset());s.top-=1,s.left+=n.innerWidth()-17,o.appendTo(a).show().height(n.innerHeight()+(O?2:0)).offset(s)}}).on("click","#content-gathering-workarea #table-dropdown-button",function(){L=!0,n.trigger("mouseenter",[!0]);var t=e("#map-dropdown").attr("class","content-gathering"),i=e(this).offset();t.find("li").hide().find(".item-row, .item-column").parent().css("display","inline-block"),t.show().css({top:i.top+o.height()/2+15,left:i.left-76}).before('<div id="map-dropdown-overlay" style="display: block" />')}).on("change","#content-gathering-workarea .element-wrapper .form-url",function(){var t=e(this);te(t.closest(".element-wrapper").find(".preview"),t.closest("li").data("type"),this.value)}).on("click","#content-gathering-workarea .add-url",function(i,a){i.preventDefault();var o=e(this).closest(".content-gathering-element"),n=(o.data("type"),e(this).closest(".uploader"));if(!a){var s=n.find(".uploadbutton");s.length&&t.publish("upload/dynamic_uploader/destroy",[s.attr("id")])}n.siblings(".element-wrapper").show().closest(".element-wrapper").find(".wrapper-url").show(),o.data("subtype","url"),a?n.hide():n.remove(),ae()}).on("click","#content-gathering-workarea .element-wrapper .preview .reset",function(){var t=e(this).closest(".content-gathering-element");t.find(".preview").hasClass("loads"),J(t.data("type"),{id:t.data("id"),options:t.data("options")||{},is_upload:!0},t)}).on("click","#content-gathering-workarea .element-wrapper .preview .download",function(){var t=e(this).data("url");t&&window.open(t)}).on("click","#content-gathering-workarea .add-library",function(i){i.preventDefault();var a=e(this).closest(".content-gathering-element"),o=a.data("type");t.publish("sitemap/lightbox_cell_files/open",[!1,!1,o+"s",{library:{button_upload:!1,button_remove:!1,button_select:!0,button_cancel:!0,sitemap_filter:!0},on_select:function(e){var i=e&&e.length?e[0]:null;if(i&&i.alias){var o=a.find(".uploader"),n=o.find(".uploadbutton");n.length&&t.publish("upload/dynamic_uploader/destroy",[n.attr("id")]),o.remove(),Ce(a.find(".preview"),i),ae()}}}])}),_.on("click",".menu-list a",function(i){i.preventDefault(),C&&t.publish("sitemap/content_planner/edit_end",[C]),ue(e(this).data("cellid"))}).on("click",".show-dashboard",function(e){e.preventDefault(),C&&t.publish("sitemap/content_planner/edit_end",[C]),me()}),t.subscribe("modal/open/modal-new-workflow-status",function(t,i){i.find(".input.preview").hide(),U!==!1&&P[U]&&(e.farbtastic("#colorpicker-workflow").setColor(P[U].color),e("#form-workflow-status-name").val(P[U].name).trigger("change"))}),t.subscribe("modal/close/modal-new-workflow-status",function(){U=!1}),t.subscribe("modal/open/modal-load-content-template",function(e,t){ye(t.find("select.templates-list"))}),t.subscribe("sitemap/map_dropdown/init",function(i,a){var o=function(){var e=I.find(".wysiwyg textarea").attr("id");e&&m.wysiwygDestroy(e,!0);var i=I.find(".uploadbutton");i.length&&t.publish("upload/dynamic_uploader/destroy",[i.attr("id")]),I.remove(),I=h.find("li.content-gathering-element").filter(":first"),ae()};a.on("click",".add-row-above, .add-row-below",function(t){if(t.preventDefault(),n&&n.length){var i=e(this).hasClass("add-row-above")?"insertBefore":"insertAfter",a=n.closest("tr");a.clone()[i](a).find("textarea.table-text").val("").removeClass("autosize").attr("style","");var o=n.closest("table");o.find("td").removeClass("active show-dropdown"),Y(o),V(o),ae()}}).on("click",".add-column-left, .add-column-right",function(t){if(t.preventDefault(),n&&n.length){var i=e(this).hasClass("add-column-left")?"before":"after",a=n.prevAll("td").length+1,o=n.closest("table");o.find("tr").children("td:nth-child("+a+")")[i]('<td><textarea rows="1" class="table-text"></textarea></td>');var s=100/n.closest("tr").children("td").length;o.find("td").removeClass("active show-dropdown").css("width",s+"%"),Y(o),V(o),ae()}}).on("click",".remove-row",function(e){if(e.preventDefault(),n&&n.length){var t=n.closest("table");n.closest("tr").remove(),t.find("td").removeClass("active show-dropdown"),V(t),ae()}}).on("click",".remove-column",function(e){if(e.preventDefault(),n&&n.length){var t=n.prevAll("td").length+1,i=n.closest("table");i.find("tr").children("td:nth-child("+t+")").remove(),i.find("td").removeClass("active show-dropdown"),V(i),ae()}}).on("click",".cg-options",function(t){t.preventDefault(),e("#modal-content-gathering-element-options").dialog("open")}).on("click",".cg-remove-block",function(t){t.preventDefault();var i=h.data("template"),a=I.data("id");i&&N[i]&&N[i].pages_custom_content&&N[i].pages_custom_content[a]&&e.isArray(N[i].pages_custom_content[a])&&N[i].pages_custom_content[a].length?m.confirmDialog({title:"Are you sure you want to delete?",text:"This block contains content on one or more pages. Removing it will delete content permanently. Are you sure you want to delete?",yes_label:"Yes, Delete",no_label:"Cancel",on_yes:function(){o()}}):o()})}),t.subscribe("sitemap/dropdown_close",function(){L=!1,n&&n.length&&n.closest(".content-gathering-element-table").trigger("mouseleave")}),e("#action-content-dashboard").on("click",function(e){e.preventDefault(),t.publish("sitemap/lightbox_cell_content/open")}),e("#modal-site-settings").on("submit","form",function(t){t.preventDefault(),c.clearErrors(e(this));var i=e(this).closest(".modal"),a=!0,o=c.serializeObject(e(this));o.url&&(/^https?:/i.test(o.url)?o.url=o.url.replace(/[\/]+$/,"")+"/":(c.error(e("#form-site-settings-url").parent(),"Please enter a valid URL",{bottom:4}),a=!1)),a&&r.request({data:{sitemap_datas:{site_settings:[{value:o}]}},$loading:i.find(".loading").css({visibility:"visible"}),success:function(){l.set("site_settings",o),i.dialog("close")},error:function(){i.dialog("close")}})}),e("#modal-content-assign-contributor").on("click",".submit input",function(t){t.preventDefault();var i=e("#modal-content-assign-contributor"),a=i.hasClass("template-mode"),o=function(){var t=i.find('input[type="radio"]:checked').val(),o='<span class="unassigned">unassigned</span>';if(a)N[t]&&(o=u.charsEncode(N[t].name));else{var n=l.get("users_list",{});n&&n[t]&&(o=u.charsEncode(n[t].name))}var s=C,c=v.find("td").find('input[type="checkbox"]').filter(":checked").closest("tr").filter(":visible"),d=!1;c.each(function(i){C=e(this).data("cellid"),C&&(a?(t=t||"",e(this).data("template",t).find("td.template").html(o).data("template",t)):e(this).data("assignee",t).removeClass(function(e,t){return(t.match(/(^|\s)assignee-\S+/g)||[]).join(" ")}).addClass("assignee-"+t).find("td.assignee").html(o),d||(d={}),d[C]||(d[C]={}),d[C][a?"content_template":"content_assignee"]={multiple:0,autoload:0,value:t})}),d&&r.request({data:{cell_datas:d}}),i.dialog("close"),C=s};a?m.confirmDialog({title:"Confirm dialog",text:"All custom content will be removed when you assign a template.",on_yes:o,yes_label:"OK",no_label:"Cancel"}):o()}),e("#modal-content-templates-dialog").on("change",'input[name="template_type"]',function(){var t=e(this).closest(".modal");"new"===this.value?t.find(".fieldset-new").show().end().find(".fieldset-edit").hide():(t.find(".fieldset-new").hide().end().find(".fieldset-edit").show(),ye(t.find("select.templates-list")))}).on("change","#form-content-template-select",function(){c.clearAll(e(this).closest(".modal"))}).on("submit","form",function(t){t.preventDefault();var a,o=e(this).closest(".modal"),n=o.hasClass("clone-mode"),s=o.hasClass("edit-mode"),l=e("#lightbox-template-content-name"),d=!1,p=n?"clone":s?"name-edit":o.find('input[name="template_type"]:checked').val();if("new"===p||"clone"===p||"name-edit"===p){var m=e("#form-content-template-new-name"),f=e.trim(m.val());if(!f)return c.error(m.parent(),"Please enter template name",{bottom:5}),!1;"name-edit"===p?(a=h.data("template"),a&&N[a]?(N[a].name=f,l.text(f),r.request({data:{save_template_id:a,save_template_data:{name:f},silent:1}})):l.text(f)):"clone"===p&&(d=h.data("template"))}else{var v=e("#form-content-template-select");if(a=v.val(),!a||!N[a])return c.error(v.parent(),"Please enter template name",{bottom:5}),!1;f=N[a].name,d=a}if(("new"===p||"clone"===p||"existing"===p)&&(le("content","content-templates"+("new"===p||"clone"===p?" content-templates-new":"")),ce(!0),ge(!1),M=!0,g&&g.length&&g.empty(),d&&N[d])){if(N[d].elements)for(var b=0,_=N[d].elements.length;_>b;++b)if(N[d].elements[b].type){var y=e.extend({},N[d].elements[b]);"clone"===p&&(y.id=u.random(8)),J(y.type,y,i,!0)}e("#form-content-gathering-seo-title").val(N[d].metadata&&"undefined"!==e.type(N[d].metadata.title)?N[d].metadata.title:""),e("#form-content-gathering-meta-desc").val(N[d].metadata&&"undefined"!==e.type(N[d].metadata.description)?N[d].metadata.description:""),e("#form-content-gathering-meta-keywords").val(N[d].metadata&&"undefined"!==e.type(N[d].metadata.keywords)?N[d].metadata.keywords:"")}l.text(f),a&&h.data("template",a),R=!1,we(),o.dialog("close")}),h.children(".title").on("click",".lightbox-header .edit, #content-clone-template",function(t){t.preventDefault();var i=e(this).hasClass("edit"),a=h.data("template"),o=function(){var t=e("#lightbox-template-content-name"),o=e("#modal-content-templates-dialog");if(o.dialog("open"),o.dialog("option","height",280),i){var n=a&&N[a]?N[a].name:t.text();o.addClass("edit-mode").find("#form-content-template-new-name").val(n).end().find('input[type="submit"]').val("Save Changes")}else{var s=a&&N[a]?N[a].name:"";s&&(s+=" (Clone)"),o.addClass("clone-mode").find('input[type="submit"]').val("Clone Template").end().find("#form-content-template-new-name").val(s).putCursorAtEnd()}};!i&&R?m.confirmDialog({title:"You have unsaved changes",text:"Would you like to save your changes first?",on_yes:function(){return e("#content-save-template-changes").trigger("click",[o]),a&&N[a]&&N[a].pages_count?!1:void 0},on_no:function(e){o()}}):o()}).on("click","#content-template-delete",function(e){e.preventDefault();var t=h.data("template"),i=t&&N[t]&&N[t].name?'"'+u.charsEncode(N[t].name)+'"':"";m.confirmDialog({title:"Confirm deletion",text:"Are you sure you would like to delete "+i+" template?",on_yes:function(){t&&N[t]&&delete N[t],r.request({data:{delete_template:t},success:function(e){_.find(".show-dashboard").trigger("click"),setTimeout(function(){f.success("Template deleted")},100),N=e.templates}})}})}),e("#modal-content-gathering-element-options").on("change","#form-content-element-option-tag",function(){var t=e(this).closest(".modal");t.find(".hide-if-no-wrapper, .show-if-html-wrapper").hide(),"html"===this.value?t.find(".show-if-html-wrapper").show():this.value&&t.find(".hide-if-no-wrapper").show()}).on("click",".submit input",function(t){t.preventDefault();var i=e(this).closest(".modal");c.clearErrors(i);var a=i.find("form").serializeObject(),o=!1;"html"!==a.tag&&(a.tag_class&&!/^[a-z0-9_\-\s]+$/i.test(a.tag_class)&&(c.error(e("#form-content-element-option-tag-class").parent(),"Please enter a valid class name/s",{bottom:4}),o=!0),a.tag_id&&!/^[a-z0-9_\-]+$/i.test(a.tag_id)&&(c.error(e("#form-content-element-option-tag-id").parent(),"Please enter a valid ID value",{bottom:4}),o=!0)),o||("html"===a.tag?(a.tag_id&&(a.tag_id=""),a.tag_class&&(a.tag_class="")):""===a.tag&&(a.tag_html_before&&(a.tag_html_before=""),a.tag_html_after&&(a.tag_html_after="")),I.data("options",a),ae(),i.dialog("close"))}),t.subscribe("modal/open/modal-content-templates-dialog",function(t,i){i.removeClass("edit-mode clone-mode").find(".fieldset-new").show().end().find(".fieldset-edit").hide(),e("#form-content-template-new-name").val("").putCursorAtEnd()}),t.subscribe("modal/before_open/modal-content-assign-contributor",function(t,i){var a,o=0,n=!1;if(i.hasClass("template-mode"))i.find("h1 .title").text("Assign Template to Selected Pages"),a=e.extend({},N),o=v.find('td input[type="checkbox"]:checked').filter(":first").closest("tr").data("template"),n=!0;else{i.find("h1 .title").text("Assign Contributors to Selected Pages");var s=[];e("#modal-contributors").find('.usersbox.editors input[name="form[editors][]"]').each(function(){s.push(this.value)}),a=l.get("users_list",{});var r=v.find('td input[type="checkbox"]:checked');r.length>0&&(o=parseInt(r.filter(":first").closest("tr").data("assignee"),10))}var c="";e.each(a,function(t,i){(n||0===parseInt(i.type,10)||e.inArray(t,s)>=0)&&(c+='<div class="radio"><input type="radio" id="assign-contributor-'+t+'" value="'+t+'" name="content_assign"><label for="assign-contributor-'+t+'">'+u.charsEncode(i.name)+"</label></div>")}),i.find(".radios .list").html(c),i.find("#assign-contributor-"+o+":not(disabled)").length||(o=0),i.find("#assign-contributor-"+o).siblings("label").trigger("click")}),t.subscribe("sitemap/lightbox_cell_content/open",function(i,a){if(q)return t.noPermissions();if(z=!0,M=!1,T={},C=a&&a.id?a.id:a,m.openLighboxModal(h,C,function(){_.show()}),x){var o=[];e("#modal-contributors").find('.usersbox.editors input[name="form[editors][]"]').each(function(){o.push(this.value)});var n=e("#content-gathering-editor-assignee");he(n,l.get("users_list",{}),function(t,i){(0===parseInt(i.type,10)||e.inArray(t,o)>=0)&&n.append('<option value="'+t+'">'+u.charsEncode(i.name)+"</option>")}),fe()}var s=function(e){e&&e.success&&e.templates&&(N=e.templates)};C?ue(C,s):x?me(s):t.publish("sitemap/lightbox_cell_content/close")}),t.subscribe("sitemap/lightbox_cell_content/close",function(){_.hide(),m.closeLighboxModal(h,C),$=!1;var i=p.getOption("data_content"),a=!1;e.each(T,function(e,t){t?p.addCellData(e,i,1,!0):p.removeCellData(e,i,!0),a=!0}),T={},a&&(p.fullRefresh(),t.publish("sitemap/sitemap_modified",["content_edited",p.getCurrentSection()]))}),t.subscribe("modal/open/modal-site-settings",function(){var t=l.get("site_settings",{});e("#form-site-settings-title").val(t&&t.title?t.title:e("#sitemap-comments-top").find("h1").text()),e("#form-site-settings-tagline").val(t&&t.tagline?t.tagline:""),e("#form-site-settings-url").val(t&&t.url?t.url:"");var i=e("#form-site-settings-language");i.selectmenuslickplan("destroy"),i.val(t&&t.language?t.language:"en_US").selectmenuslickplan({style:"popup",maxHeight:300})}),t.subscribe("modal/open/modal-content-gathering-element-options",function(){var t=I.length?I.data("options"):{};e("#form-content-element-option-tag-class").val(t.tag_class?t.tag_class:""),e("#form-content-element-option-tag-id").val(t.tag_id?t.tag_id:""),e("#form-content-element-option-html-before").val(t.tag_html_before?t.tag_html_before:""),e("#form-content-element-option-html-after").val(t.tag_html_after?t.tag_html_after:"");var i=e("#form-content-element-option-tag");i.selectmenuslickplan("destroy");var a=t.tag||"div";i.val(a).selectmenuslickplan({style:"popup",maxHeight:300,format:function(e){return u.charsEncode(e)}}),i.trigger("change")}),t.addFilter("sitemap_save_data",function(t){return X()&&t&&"object"===e.type(t)&&(t.cell_datas||(t.cell_datas={}),d.forEach(D,function(i,a){d.forEach(a,function(a,o){a&&"string"===e.type(a)&&(t.cell_datas[i]||(t.cell_datas[i]={}),t.cell_datas[i][a]=o)})})),t}),t.subscribe("sitemap/saved",function(){D={},t.has_unsaved_changes.content=!1}),t.subscribe("hashchange",function(e,t,i){t||"content"!==i||h.is(":visible")&&h.find(".title button.circle.reset").trigger("click")}),t.subscribe("upload/files_added_contentgathering",function(i,a,o,n){r.request("get_cell_files_storage_left",{success:function(i){var s=0;i&&"number"===e.type(i.free_space)&&(s=i.free_space);for(var r=0,l=o.length;l>r;++r)s-=o[r].size;if(s>0){var c=e(n).closest("li.content-gathering-element");c.data("file_id","").data("subtype","library").find(".uploader").hide().end().find(".element-wrapper").show().find(".preview").css("background-image","").html('<div class="progress"></div><i class="fa fa-refresh fa-spin"></i><span class="detailed">Uploading&hellip;</span>').addClass("loads").end().find(".wrapper-url").remove(),
    setTimeout(function(){a.start()},100)}else t.publish("upload/limit_exceed")}})}),t.subscribe("upload/file_uploaded_contentgathering",function(i,a,o,n,s){n&&(a.stop(),setTimeout(function(){r.request({data:{cell_file_details:{name:o.name,size:o.size,type:o.type},cell_file_s3:n,cell_id:0},success:function(i){"object"===e.type(i)&&(i.success&&i.file&&i.file.alias?(Ce(e(s).closest(".content-gathering-element").find(".preview"),i.file),ae(),t.publish("upload/dynamic_uploader/destroy",[s.id]),e(s).closest(".uploader").remove(),i.usage_text&&e(".usage-text").text(i.usage_text)):i.error&&i.free_space<=0&&(t.publish("upload/limit_exceed",[-1*i.free_space]),e(s).closest(".content-gathering-element").find(".content-gathering-remove").trigger("click")))},error:function(){f.error("Error creating a thumbnail of "+o.name),r.request({data:{remove_cell_file:o.id,remove_permanently:1,remove_comments:0,cell_file_s3:n},success:function(i){t.publish("upload/dynamic_uploader/destroy",[s.id]),e(s).closest(".content-gathering-element").find(".content-gathering-remove").trigger("click"),i&&i.usage_text&&e(".usage-text").text(i.usage_text)}})}})},10)),a.refresh()}),t.subscribe("upload/error_contentgathering",function(i,a,o,n){var s=e(n).closest(".content-gathering-element").data("type");switch(o.message){case"File extension error.":"image"===s?o.message=t.__("Can't upload {1}. Only image files (JPG, PNG, GIF) are allowed",o.file.name):"video"===s?o.message=t.__("Can't upload {1}. Only video files are allowed",o.file.name):o.message=t.__("Can't upload {1}. File extension error - file not allowed",o.file.name);break;case"File size error.":var r=u.humanReadableFileSize(e(n).data("maxsize"));o.message=t.__("Can't upload {1}. Maximum file size: {2}",o.file.name,r);break;default:o.message=o.file.name+": "+o.message}f.error(o.message)}),t.subscribe("upload/uploads_progress_contentgathering",function(t,i,a,o){if(a&&a.percent){var n=e(o).closest(".content-gathering-element").find(".preview .progress").css("width",Math.ceil(a.percent)+"%"),s=n.parent().find(".detailed");if(s.length){var r="";a.percent>=100?r="Crunching&hellip;":(r+=u.humanReadableFileSize(a.loaded,2,1,"&nbsp;"),r+=" of ",r+=u.humanReadableFileSize(a.size,2,1,"&nbsp;")),s.html(r)}}})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap route/plainsitemap",function(a){var o="route/sitemap"===a.type?t.require("websocket"):t.require("ajax"),n=t.require("config"),s=t.require("form"),r=t.require("diagrams"),l=t.require("svg"),c=t.require("sitemap"),d=t.require("helper"),u=t.require("string"),p=t.require("session"),m=e("#lightbox-cell-diagrams"),f=m.find(".tabs"),h=e("#drawing-tools"),g=m.find("#diagram-text-field"),v=m.find("#diagram-dropdown"),b=h.find("fieldset.selection > div:not(.legend)"),_=e("#diagram-paper"),y=e("#diagram-ghost-select"),w=e("#lightbox-submenu-diagrams"),C=e("#diagram-paper-wrapper"),k="history_"+t.require("config").get("route").join("_")+"_diagram",x={},S={},D={},q=null,E=n.get("allow_edit",!1),A=!1,T=!1,z=!1,$=!1,L=!0,O=null,I=e("#slickplan-sitemap").data("id")||0,j=null,P=null,N=!1,U=!1,R={},M={},F=74,B=null,W=function(){b.hide().filter(".no-selection").show()},H=function(a){setTimeout(function(){if(a=a&&a.elements?e.extend({},a):r.serialize(),x[k]!==i&&x[k]>=0)for(;p.countItems(k)-1>x[k];)p.removeItem(k);p.addItem(k,a),x[k]=p.countItems(k)-1,t.log("History: added (diagram)","debug",k,a,x[k])},1)},K=function(a,s,l,c){if(!E||N)return!1;a=a?a:O;var d=!1;if(s?(S[a]&&delete S[a],M[a]=1,R[a]={ref_id:a,value:null,"delete":!0,cell_id:q},d=!0):a&&(c||(c=r.serialize(a)),c?(S[a]=c,R[a]={ref_id:a,value:c,cell_id:q},d=!0):(S[a]=i,delete S[a])),d&&(t.has_unsaved_changes.diagrams=!0,!l&&n.get("auto_save",!1))){var u=[];e.each(R,function(e,t){u.push(t)}),u.length&&o.request({data:{sitemap_datas:{diagrams:u}},success:function(){e.each(R,function(e){M[e]=i}),R={},t.has_unsaved_changes.diagrams=!1}})}S[a]&&H(S[a])},G=function(t,i){var a=e("<div/>").addClass("tab "+t).text(i).data("diagram_id",t);return f.find(".wrapper").append(a),a},Y=function(i,a,o,n){"string"!==e.type(a)&&"number"!==e.type(a)&&(a=t.__("Untitled")),i||(i=l.generateUniqueId("svgdiagram"));var s=G(i,a);return S[i]||(n&&S[n]?S[i]=r.serialize(n):S[i]=r.serialize(i),S[i]&&(S[i].name=a)),t.publish("sitemap/lightbox/tabs_scrollable",[f,o?s:null]),i};t.subscribe("sitemap/lightbox-cell-diagrams/tab_edit",function(e,i){d.confirmDialog({close:!0,input:!0,input_text:i.text(),input_max_length:150,title:"Change Workarea Name",yes_label:"Confirm",no_label:"Cancel",on_yes:function(e,a,o){var n=o.val();if(""!==n){var s=i.data("diagram_id");i.text(n),i.hasClass("current")&&r.renameWorkarea(n,s),S[s].name=n,K(s),t.publish("sitemap/lightbox/tabs_scrollable",[f])}}})});var V=function(i,a){switch(a){case"page":r.deselectAllLines(),b.hide().filter(".dropdown").show();var o=r.getAssignedCell(i);o||(o=""),v.selectmenuslickplan("destroy"),v.val(o).selectmenuslickplan({style:"popup",maxHeight:t.$window.height()-200});break;case"file":case"block":case"triangle":case"circle":case"halfcircle":case"trapez":case"romb":case"group":case"user":case"text":r.deselectAllLines();var n=l.getData(i,"label")||"";n!==!1&&null!==n&&"undefined"!==e.type(n)||(n=""),b.hide().filter(".text").show(),g.val(n);break;case"arrowto":case"arrowfrom":case"arrowboth":case"arrowtoblock":case"arrowfromblock":case"arrownone":r.deselectAllBlocks(),b.hide().filter(".arrows").show().find("#action-diagram-"+a).trigger("click");break;case"multiple":r.deselectAllLines(),b.hide().filter(".multiple").show();break;default:W()}},J=function(e){q&&o.request({data:{save_diagrams_order:e,cell_id:q}})};g.on("keydown.return",function(){this.blur(),r.deselectAllElements()}).on("keyup",function(){r.addElementLabel(!0,this.value),clearTimeout(j);var e=O;j=setTimeout(function(){K(e)},250)}),v.change(function(t,i){i||(this.value?(r.assignCell(!0,this.value),r.addElementLabel(!0,e(this).find("option:selected").data("label"))):(r.deassignCell(!0),r.removeElementLabel(!0,!1)),K(O))}),m.on("click",".menu-button",function(){if(w.toggleClass("open").hasClass("open")){var e=w.find(".menu-list").empty(),t=[];l.forEach(S,function(e,i){t.push({id:e,name:i.name})}),t.sort(function(e,t){return e&&e.name&&t&&t.name?(""+e.name).localeCompare(""+t.name):void 0});for(var i=0,a=t.length;a>i;++i)e.append('<li><a href="#" data-diagram="'+u.charsEncode(t[i].id)+'">'+u.charsEncode(t[i].name)+"</a></li>")}}).on("click",".circle.reset",function(e){e.preventDefault(),t.publish("sitemap/lightbox_cell_diagrams/close",[m])}),f.on("click",".tab:not(.add)",function(){var t=e(this).data("diagram_id");O!==t&&(O=t,f.find(".tab.current").removeClass("current"),e(this).addClass("current"),r.reset(t),S[t]&&(r.load(S[t],t),p.setData(k,[]),x[k]=0,H(S[t])),W())}).on("mouseenter",".tab:not(.add)",function(){P=e(this).data("diagram_id")}).on("click",".tab.add",function(){d.confirmDialog({close:!0,input:!0,input_text:"",title:t.__("New Workarea"),yes_label:t.__("Confirm"),no_label:t.__("Cancel"),on_yes:function(e,a,o){var n=o.val();if(""===n)return s.error(e.find("div.textinput"),t.__("Please enter a name"),{left:"100.5%",bottom:"24px"}),!1;var r=Y(i,n,!0);r&&(c.addCellDiagram(q,r,!0),setTimeout(function(){K(r)},33))}})}).find(".overflow .wrapper").sortable({axis:"x",items:"> .tab:not(.ui-sortable-placeholder):not(.ui-sortable-helper)",placeholder:"tab ui-sortable-placeholder",distance:3,zIndex:1999,forcePlaceholderSize:!0,update:function(){var t=[];f.find(".tab:not(.add)").each(function(){var i=e(this).data("diagram_id");i&&t.push(i)}),J(t),f.find(".tab").removeAttr("style")},start:function(t,i){e(i.placeholder).width(e(i.item).width()),f.addClass("is-sorting")},stop:function(){f.removeClass("is-sorting")}}),h.on("click","#action-diagram-workarea-clone",function(e){e.preventDefault();var a=f.find(".tab.current").text();d.confirmDialog({close:!0,input:!0,input_text:a+" (Clone)",input_max_length:150,title:"Clone Workarea",input_label:"Workarea Name",yes_label:"Clone",no_label:"Cancel",on_yes:function(e,a,o){var n=o.val();if(""===n)return s.error(e.find("div.textinput"),t.__("Please enter a name"),{left:"100.5%",bottom:"24px"}),!1;var r=Y(i,n,!0,O);r&&(c.addCellDiagram(i,r,!0),K(r,!1,!1,S[r]))}})}).on("click","#action-diagram-workarea-delete",function(e){e.preventDefault();var a=f.find(".tab.current").text();d.confirmDialog({close:!0,title:"Confirm deletion",text:'Are you sure you want to delete "'+u.charsEncode(a)+'" workarea?',yes_label:"Delete Workarea",no_label:"Cancel",on_yes:function(){var e=O,a=f.find(".tab.current"),o=a.prev(".tab:not(.add)");o.length||(o=a.next(".tab:not(.add)")),o.length||(o=f.find(".tab").not(".current, .add").filter(":first")),p.setData(k,[]),a.removeData(),c.removeCellDiagram(i,e),K(e,!0),o.length?(a.remove(),t.publish("sitemap/lightbox/tabs_scrollable",[f,o])):t.publish("sitemap/lightbox_cell_diagrams/close",[m])}})}).on("click","#action-diagram-workarea-share",function(t){t.preventDefault();O.replace("svgdiagram","");e("#modal-share").dialog("open")}).on("click","button.delete",function(e){e.preventDefault(),r.removeItems(!0),W(),K()}).on("click","#action-diagram-page",function(e){e.preventDefault()}).on("mouseenter","#action-diagram-page",function(){clearTimeout(B);var a=e(this),o=e("#map-dropdown").attr("class","diagram-page");t.publish("sitemap/dropdown_before_open",[o,i,"diagram-page"]);var n=a.offset();o.show().css({position:"fixed",top:n.top+42,left:n.left-66}),e("#map-dropdown-overlay").remove()}).on("mouseleave","#action-diagram-page",function(){B=setTimeout(function(){e("#map-dropdown").hide()},150)}).on("mouseup",".drawing > button:not(#action-diagram-page)",function(e){e.preventDefault(),$&&$!==!0&&(r.moveElementToCenter($),r.selectElement($),K()),$=!1}).on("mousedown",".drawing > button:not(#action-diagram-page)",function(){var e=this.id.replace("action-diagram-","");$=r.addElement(e,[1,0,0,1,0,-200],"matrix"),r.deselectAllElements()}).on("click",".arrows > button.selectable",function(t,i){t.preventDefault(),e(this).addClass("selected").siblings("button").removeClass("selected");var a=this.id.replace("action-diagram-","");r.changeLineType(a),i||K()}),e(document).on("keypress",function(e){if(L||!E)return!0;if((0==e.keyCode||32==e.keyCode)&&"connect"===A){var t=h.find(".arrows");if(t.length&&t.is(":visible")){e.preventDefault();var i=t.children("button.selected"),a=i.next("button.selectable");a.length||(a=t.children("button.selectable").filter(":first")),a.trigger("click",[!0])}}}).on("keydown",function(e){return L||!E?!0:void(16!==e.keyCode&&17!==e.keyCode&&91!==e.keyCode&&18!==e.keyCode&&224!==e.keyCode||(U=!0))}).on("keyup",function(){return L||!E?!0:void(U=!1)}).on("mouseup",function(){return L||!E?!0:void setTimeout(function(){$&&$!==!0&&r.removeItems([$]),$=!1},10)}).on("keydown.ctrl_z keydown.meta_z",function(e){if(L||!E)return!0;if(e.preventDefault(),x[k]>0){--x[k];var t=p.getItem(k,x[k]);t&&t.elements&&r.load({elements:t.elements,connections:t.connections},O)}}).on("keydown.ctrl_y keydown.meta_y",function(e){if(L||!E)return!0;if(e.preventDefault(),x[k]>=0){var t=p.getItem(k,x[k]+1);t&&t.elements&&(++x[k],r.load({elements:t.elements,connections:t.connections},O))}}).on("mouseenter","#map-dropdown.diagram-page",function(){clearTimeout(B)}).on("mouseleave","#map-dropdown.diagram-page",function(){B=setTimeout(function(){e("#map-dropdown").hide()},150)}),_.on("mousemove",function(e){if(L||!E)return!0;if($&&$!==!0){r.setPosition($,0,0);var t=r.getElementType($,!0),i=r.getElementGroup($);t&&t.width&&t.height||(t=i.getBBox());var a={clientX:t.width/2,clientY:t.height/2+100+F};$=!0,r.dndStart(a,i),A="move"}if(A)switch(e=e||window.event,T=!0,A){case"move":_.addClass("dragging");var o={top:$===!0?C.scrollTop():0,left:$===!0?C.scrollLeft():0};r.dndMove({clientX:e.clientX+o.left,clientY:e.clientY+o.top});break;case"connect":case"resize":_.addClass("dragging-"+A),r[A+"DndMove"](e);break;case"select":if(z){var n=40,s=20,l=0,c=0,d=e.pageY-(100+F),u=e.pageX;if(n>=d?l=-s:z.paperHeight-d<=n&&(l=s),n>=u?c=-s:z.paperWidth-u<=n&&(c=s),0!==l){var p=C.scrollTop();C.scrollTop(p+l),p=C.scrollTop()-p,0!==p&&(z.top-=p)}if(0!==c){var m=C.scrollLeft();C.scrollLeft(m+c),m=C.scrollLeft()-m,0!==m&&(z.left-=m)}var f={display:"block",left:z.left,top:z.top,width:e.pageX-z.left,height:e.pageY-F-z.top};f.width<0&&(f.left+=f.width,f.width*=-1),f.height<0&&(f.top+=f.height,f.height*=-1),y.css(f),f.top-=100,r.selectElementsInRange(f,z.elements,{top:C.scrollTop(),left:C.scrollLeft()})}}}).on("mousedown",function(i){if(L||!E)return!0;i=i||window.event,"object"===e.type(i)&&"function"===e.type(i.preventDefault)&&i.preventDefault();var a=l.getRealTarget(i);l.checkTag(a,"use","connect")?(r.connectDndStart(i,r.getElementGroup(a),a),A="connect"):l.checkTag(a,"rect","resize")?(r.resizeDndStart(i,r.getElementGroup(a),a),A="resize"):r.getElementType(a)?(r.dndStart(i,r.getElementGroup(a)),A="move"):(A="select",z={left:i.pageX,top:i.pageY-F,elements:r.getElementsWithDatas(),paperWidth:t.getWindowWidth(C),paperHeight:C.height()})}).on("mouseup",function(e){if(L||!E)return!0;var t=!1;e=e||window.event;var a=l.getRealTarget(e);if(_.removeClass("dragging dragging-connect dragging-resize"),T)switch(A){case"move":r.dndStop(e),$===!0&&(r.deselectAllElements(),r.selectElement(a)),t=!0;break;case"connect":l.checkTag(a,"use",A)||(a=i),r.connectDndStop(e,r.getElementGroup(a),a),t=!0;break;case"resize":l.checkTag(a,"rect",A)||(a=i),r.resizeDndStop(e,r.getElementGroup(a),a),t=!0}else if(r.connectDndStop(),l.checkTag(a,"polyline","connection"))r.deselectAllElements(),r.selectLine(a);else{U||r.deselectAllElements();var o=r.getElementType(a);a&&o&&(r.selectElement(a,o)||r.deselectElement(a,o))}"select"===A&&y.hide(),A=!1,T=!1,z=!1,$=!1,t&&K()}),w.on("click","a[data-diagram]",function(i){i.preventDefault();var a=e(this).data("diagram");if(a&&S[a]&&S[a].cell_id){var o=f.find(".tab."+a);o.length?o.trigger("click",[!0]):t.publish("sitemap/lightbox_cell_diagrams/open",[S[a].cell_id])}}),t.subscribe("sitemap/lightbox_cell_diagrams/open",function(a,n){q=n&&n.id?n.id:n,S={},q&&(t.$window.scrollTop(0),d.openLighboxModal(m,q,function(){w.show()}),l.disableCache(),L=!1,N=!0,r.init(_.empty().get(0)),f.hide().find(".wrapper").empty(),F=m.children(".title").outerHeight(),o.request("get_cell_diagrams",{data:{sitemap_id:I},success:function(a){if(f.show(),a&&a.success&&a.diagrams){e.isArray(a.diagrams)||e.each(a.diagrams,function(e,t){M[e]||(S[e]=t)}),a.diagrams_order&&(D=a.diagrams_order),e.each(R,function(t,i){i&&i.value&&!i["delete"]&&(S[t]=e.extend({},i.value))});var o=[];if(q)if(o=c.getCellData(q,c.getOption("data_diagrams")),"string"===e.type(o)?o=o.replace(/\s+/g,"").split(","):"undefined"===e.type(o)&&(o=[]),D&&D[q]&&e.isArray(D[q])&&D[q].length>1){for(var n=[],s=0,r=D[q].length;r>s;++s)e.inArray(D[q][s],o)>=0&&n.push(D[q][s]);for(var s=0,r=o.length;r>s;++s)e.inArray(o[s],n)<0&&n.push(o[s]);o=n}else o=o.reverse();if(o&&o.length)for(var s=0,r=o.length;r>s;++s)S[o[s]]&&Y(o[s],S[o[s]].name);else{var l=Y(i,i,!0);l&&c.addCellDiagram(i,l,!0)}if(O=null,f.find(".tab").not(".add").filter(":first").trigger("click",[!0]),N=!1,v.length){v.html('<option value="">'+t.__("Select Page")+"</option>");for(var d=c.serializeCells(i,!0),s=0,r=d.length;r>s;++s){var u=c.getCellLevel(d[s]),p="number"===e.type(u)?u:0;e('<option value="'+d[s].id+'">'+d[s].text+"</option>").data("indent",p).data("label",d[s].text).appendTo(v)}e("#"+v.attr("id")+"-button").length&&v.selectmenuslickplan("destroy"),v.val("").selectmenuslickplan({style:"popup",maxHeight:t.$window.height()-200})}}},error:function(){N=!1,t.publish("sitemap/lightbox_cell_diagrams/close")}}))}),t.subscribe("sitemap/map_dropdown/init",function(t,i){i.on("click",".ia-internal-page, .ia-custom-page",function(t){t.preventDefault(),r.deselectAllElements();var i=r.addElement(e(this).hasClass("ia-custom-page")?"block":"page");r.selectElement(i),K()})}),t.subscribe("sitemap/lightbox_cell_diagrams/close",function(i,a,o){if(w.hide(),!o){var n=!0,s=a.find(".tab:not(.add)"),r=s.length-1;s.each(function(t){var i=e(this).data("diagram_id");i&&(S[i]?n=!1:K(i,!0,r>t))}),n&&q&&c.removeCellDiagram(q)}L=!0,l.enableCache(),k&&p.setData(k,[]),d.closeLighboxModal(m,q,function(){!o&&E&&(c.fullRefresh(),t.publish("sitemap/sitemap_modified",["diagrams_edited",c.getCurrentSection()]))})}),t.subscribe("sitemap/diagrams/selected_element",function(e,t,i,a){return E?(a&&a.length>1&&(i="multiple"),void V(t,i)):!1}),t.subscribe("sitemap/diagrams/deselected_element",function(e,t,i,a){g.is(":focus")&&g.blur(),a&&a.length>1?V(t,"multiple"):a&&1===a.length&&a[0]?V(a[0],r.getElementType(a[0])):W()}),t.$window.on("debouncedresize",function(){L||(r.refreshContainerSize(),t.publish("sitemap/lightbox/tabs_scrollable",[f]))}),t.addFilter("sitemap_save_data",function(t){if(t&&"object"===e.type(t)){var i=[];e.each(R,function(e,t){i.push(t)}),i.length&&(t.sitemap_datas||(t.sitemap_datas={}),t.sitemap_datas.diagrams=i)}return t}),t.subscribe("sitemap/saved",function(){R={},t.has_unsaved_changes.diagrams=!1}),t.subscribe("hashchange",function(e,t,i){t||"diagrams"!==i||m.is(":visible")&&m.find(".title button.circle.reset").trigger("click")})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap route/plainsitemap",function(a){var o,n,s,r="route/sitemap"===a.type?t.require("websocket"):t.require("ajax"),l=t.require("config"),c=t.require("helper"),d=(t.require("http"),t.require("notification")),u=t.require("scrollbar"),p=t.require("sitemap"),m=t.require("string"),f=e("#lightbox-cell-files"),h=f.children(".row"),g="route/sitemap"===a.type&&l.get("allow_edit",!1),v={},b=e("#slickplan-sitemap").data("id")||0,_={},y={},w="all",C={},k={},x={extension:[],size:[],other:[]},S=!1,D=!1,q=function(i,a,o){if(i===n)return!1;var s="all",r="";"images"===w||"videos"===w?(s=w.replace("s",""),r=s):"files"===w&&(s="file",r="");var l={type:"all"===s?"file":s,type_plural:"all"===s?"files":s+"s",type_or_empty:r,type_or_empty_plural:r?r+"s":"",mime:w,user_can_edit:g};a&&"object"===e.type(a)&&e.extend(l,a);var d=c.template("lightbox-cell-files-"+i,l);if(d){"library"!==i&&"files"!==i||!g||("undefined"===e.type(l.drop_only)&&(l.drop_only=!0),h.find(".empty").remove(),d+=c.template("lightbox-cell-files-empty",l)),n=i,o?(h.children("div").hide().filter("."+i).remove(),h.append(d)):(A(i),E(i),h.html(d)),"files"===i?(f.find(".commentsarea").hide(),f.find(".nocomments").css("display","table"),h.find(".empty").hide()):"library"===i&&(f.find(".library").removeClass("preview").siblings(".library-preview").removeData("file"),h.find(".empty").hide());var u=h.children("div").filter(":visible").filter(":last");u.find(".uploadbutton.dynamic").each(function(){var a=e(this).data("name")||this.id;k[i]||(k[i]=[]),k[i].push(a),e(this).data("mime",w),t.publish("upload/dynamic_uploader/init",[this,"plupload_library",a])}),u.find("#form-lightbox-comment").length&&(c.wysiwygInit("form-lightbox-comment",!1,{height:110}),C[i]||(C[i]=[]),C[i].push("form-lightbox-comment")),u.find("select").each(function(){e(this).selectmenuslickplan({style:"popup",maxHeight:t.$window.height()/2})}),"files"===i&&f.find(".thumbs .container").sortable({axis:"x",items:"> .thumb:not(.ui-sortable-placeholder):not(.ui-sortable-helper)",placeholder:"thumb ui-sortable-placeholder",distance:3,update:function(t,i){var a=[];f.find(".thumbs .container .thumb").each(function(){var t=e(this).data("file");t&&a.push(t)}),M(a)}})}},E=function(t){e.each(C,function(e,i){if(!t||e===t){for(var a=0,o=i.length;o>a;++a)c.wysiwygDestroy(i[a]);C[e]=[]}})},A=function(i){e.each(k,function(e,a){if(!i||e===i){for(var o=0,n=a.length;n>o;++o)t.publish("upload/dynamic_uploader/destroy",[a[o]]);k[e]=[]}})},T=function(t,i){if(i){var a=c.objectToArray(_);if(a&&a.length)return void t(a.length,a)}_={},r.request("get_cell_files_library",{data:{sitemap_id:b,file_types:w},success:function(i){var a=0;if(i&&i.success&&i.files){var o=i.files.length;if(o>0)for(var n=0;o>n;++n)i.files[n]&&i.files[n].alias&&(_[i.files[n].alias]=i.files[n],++a)}"function"===e.type(t)&&t(a)}})},z=function(t){y={},r.request("get_cell_files",{data:{sitemap_id:b,cell_id:o},success:function(i){var a=0;if(i&&i.files){var o=i.files.length;if(o>0)for(var n=0;o>n;++n)i.files[n]&&i.files[n].alias&&(y[i.files[n].alias]=i.files[n],++a)}"function"===e.type(t)&&t(a)}})},$=function(e){if("files"===n||"library"===n){var a=Math.max(f.height(),t.$window.height()),o=f.children(".row").children("div").filter(":visible");if("files"===n){var s=f.find(".title").outerHeight(!0)+o.find(".toolbar").outerHeight(!0)+o.find(".files-thumbs").outerHeight(!0)+21;c.addCssRule("#lightbox-cell-files .file-preview img","max-height: "+Math.floor(a-s)+"px !important",!0)}else if(o.hasClass("library")){var r=o.find(".single-file").filter(":first").width();r&&(c.addCssRule("#lightbox-scroll-files .single-file .file-name-wrapper","height: "+r+"px !important",!0),c.addCssRule("#lightbox-scroll-files .single-file .sandbox","width: "+(r-32)+"px !important",!0))}else{var s=f.find(".title").outerHeight(!0)+o.find(".toolbar").outerHeight(!0)+2;c.addCssRule("#lightbox-cell-files .library-preview .file-preview","height: "+Math.floor(a-s)+"px !important",!0),s+=19,c.addCssRule("#lightbox-cell-files .library-preview img","max-height: "+Math.floor(a-s)+"px !important",!0)}for(var l=["wrapper","viewport"],d=0,u=l.length;u>d;++d)"files"===n?c.addCssRule("#lightbox-cell-files .commentsarea ."+l[d],"height: "+Math.floor(a-345)+"px !important",!0):"library"===n&&o.hasClass("library")&&c.addCssRule("#lightbox-cell-files .library ."+l[d],"height: "+Math.floor(a-196)+"px !important",!0);"files"===n?O():L(i,e)}},L=function(e,t){e&&e.length||(e=f.find("#lightbox-scroll-files")),t=t||"top",e.removeData("plugin_tinyscrollbar").removeClass("tinyscrollbar-enabled"),u.init(e),u.update(e,t),setTimeout(function(){u.update(e,t)},50)},O=function(e){if("files"===n){var t=f.find(".files-thumbs > .thumbs"),i=t.parent(),a=69*t.find(".thumb").filter(":visible").length;if(a>i.width()-(g?69:0)){switch(i.addClass("withnav"),$thumb=null,e){case"first":case"last":$thumb=t.find(".thumb").filter(":visible").filter(":"+e);break;default:e&&($thumb=t.find("#thumb-"+e).filter(":visible"))}if(_last_margin=0,$thumb&&$thumb.length){var o=$thumb.prevAll(".thumb").filter(":visible").length+1;o=69*o-t.find(".container-wrapper").width(),_last_margin=o}}else i.removeClass("withnav"),_last_margin=0;t.find(".container").css("margin-left",_last_margin>0?-1*_last_margin:0)}},I=function(){var i=[],a="",o=0;if(x.extension.length){for(a="",o=0,j=x.extension.length;o<j;++o)a+=0===o?m.charsEncode(x.extension[o]):o+1===j?" or "+m.charsEncode(x.extension[o]):", "+m.charsEncode(x.extension[o]);if("images"===w)i.push(t.__("Can't upload {1}. Image (JPG, PNG, GIF) files only",a));else{var n=w.split(",");n.length>1||e.inArray("all",n)>=0||e.inArray("files",n)>=0?i.push(t.__("Can't upload {1}, incorrect file type",a)):i.push(t.__("Can't upload {1}, {2} files only",a,n[0]))}}if(x.size.length){for(a="",o=0,j=x.size.length;o<j;++o)a+=0===o?m.charsEncode(x.size[o]):o+1===j?" or "+m.charsEncode(x.size[o]):", "+m.charsEncode(x.size[o]);m.humanReadableFileSize(l.get("library_file_maxsize",5242880));i.push(t.__("Can't upload {1}. Maximum file size: {2}",a,max_upload_size))}if(x.other.length)for(o=0,j=x.other.length;o<j;++o)i.push(m.charsEncode(x.other[o]));x={extension:[],size:[],other:[]},i.length&&d.error(i.join("<br>"))},P=function(t,i){if(t&&o){var a=e("#sitemap-comments").find(".item.hasfile.hasfile-"+t+".hasfile-cell-"+o);if(a.length){var n=a.data("id");n&&(a=a.siblings(".group-"+n))}}else var a=[];if(a&&a.length){var s="";a.each(function(){s+=e(this).html()}),f.find(".nocomments").hide(),f.find(".commentsarea").css("display","table");var r=e("#lightbox-scroll-area");r.html(s),L(r,i)}else f.find(".nocomments").css("display","table"),f.find(".commentsarea").hide();e("#form-lightbox-comment-cell-id").val(o),e("#form-lightbox-comment-file-id").val(t),$()},N=function(t,i,a,o){var n=f.find("#lightbox-scroll-files").find(".clearfix"),s=function(t,i,a){var o="";if(t&&t.length)for(var s=0,r=t.length;r>s;++s)if(t[s]){type=t[s].alias?"known":"unknown";var l=e.extend({},t[s]);l.user_can_edit=g,o+=c.template("lightbox-cell-files-library-thumb-"+type,l)}a?n.append(o):n.html(o),$(i)};i&&i.length?s(i,a,o):(n.html('<i class="fa fa-refresh fa-spin library-loading"></i>'),T(function(o,n){var r=[];n||(n=c.objectToArray(_));for(var l=0,d=n.length;d>l;++l)n[l]&&n[l].alias&&e.inArray(n[l].alias,t)<0&&r.push(n[l]);if(i&&i.length)for(var l=0,d=i.length;d>l;++l)r.push(i[l]);delete n,s(r,a)},o))},U=function(t,i){var a=function(t,a){var o="";if(t&&t.length)for(var n=0,s=t.length;s>n;++n){type=t[n].alias?"known":"unknown";var r=e.extend({},t[n]);r.user_can_edit=g,o+=c.template("lightbox-cell-files-files-thumb-"+type,r)}var l=f.find(".files .thumbs .container");a&&l.empty(),l.append(o),i&&l.find(i).filter(":first").trigger("click",[!0])};t&&t.length?a(t):z(function(){t=c.objectToArray(y),a(t,!0)})},R=function(t,i){var a=[];f.find(".files-thumbs > .thumbs .thumb").each(function(){var t=e(this).data("file")||e(this).attr("id").replace("thumb-","");t&&a.push(t)}),"function"===e.type(t)&&(v.on_select=t,v.on_select_once=!0),f.find(".files").hide();var o={button_select:!0,button_cancel:!0,sitemap_filter:!0,multiple:v.allow_multiple_select};i&&"object"===e.type(i)&&e.extend(o,i),q("library",o,!0),N(a)},M=function(e){r.request({data:{save_files_order:e,cell_id:o}})},F=function(e,t){r.request({data:{assign_cell_files:e,cell_id:o},success:function(e){if(f.find(".files").length?(A("library"),f.find(".library").remove(),f.find(".files").css("display","table"),n="files"):q("files",{file_html:"",user_can_edit:g,cell_id:o,file_id:""}),e&&e.files&&e.files.length>0){for(var i=null,a=0,s=e.files.length;s>a;++a)y[e.files[a].alias]=e.files[a],i=e.files[a].alias;t?(U(e.files),O()):(U(e.files,i?"#thumb-"+i:".thumb:first"),i&&O(i)),v.files_changed=!0}}})},B=function(t){"function"===e.type(t)&&(D&&"object"===e.type(D)?c.confirmDialog({id:"file-library",close:!0,title:"Files Uploading",text:"Some files are still uploading, would you like to cancel?",yes_label:"Yes",no_label:"No",on_yes:function(){return D.stop(),D=!1,"files"===n?(f.find(".files-thumbs .thumb.loads").remove(),O()):(f.find(".library .single-file.loads").remove(),L()),setTimeout(function(){t()},10),!1}}):t())};e("#action-filelibrary").on("click",function(e){e.preventDefault(),t.publish("sitemap/lightbox_cell_files/open",[!1,!1,"all",{library:{button_upload:!0,button_remove:!0,sitemap_filter:!0,file_type_filter:!0,icon_preview:!0},allow_multiple_select:!0}])}),e("#sitemap-comments").on("click",".item.hasfile .comment img",function(){var i=e(this).closest(".item");t.publish("sitemap/lightbox_cell_files/open",[i.data("cell-id"),i.data("file-id"),"images"])}),f.on("click",".single-file:not(.loads) .file-name-wrapper",function(t){t.preventDefault();var i=e(this).closest(".single-file").toggleClass("selected");v.allow_multiple_select||i.siblings(".single-file.selected").removeClass("selected")}),f.on("click",".single-file .preview-btn",function(t){var i=e(this).closest(".single-file"),a=i.data("file");if(a&&"object"===e.type(_[a])&&"string"===e.type(_[a].date)){var o=c.template("lightbox-cell-files-single-file",{date:_[a].date,time:_[a].time,user_name:_[a].user,file_name:_[a].name,file_size:m.humanReadableFileSize(_[a].size),image_src:_[a].url_preview,fa_icon:_[a].fa_icon,button_cancel:!0,user_can_edit:g,file_type:_[a].file_type,mime:_[a].mime});f.find(".library").addClass("preview").siblings(".library-preview").data("file",a).find(".files-preview").html(o),$()}}),f.on("click",".library-preview button.cancel",function(e){f.find(".library").removeClass("preview").siblings(".library-preview").removeData("file").find(".files-preview").empty(),$()}),f.on("change","#lightbox-file-types-dropdown, #form-cell-files-this-sitemap",function(t){var i=f.find(".single-file").show(),a=e("#form-cell-files-this-sitemap").is(":checked"),o=e("#lightbox-file-types-dropdown").val();o&&(i=i.hide().filter(".file-type-"+o).show()),a&&i.not(".assignedtositemap").hide(),L()}),f.on("click",".library button.remove",function(t){t.preventDefault();var i=f.find(".library .single-file.selected");i.length>0&&c.confirmDialog({id:"file-library",close:!0,title:"Delete files permanently?",yes_label:"Yes, Delete",no_label:"Cancel",on_yes:function(){var t=[];i.each(function(){var i=e(this).data("file");i&&(t.push(i),e("#thumb-"+i).remove(),y[i]&&delete y[i],_[i]&&delete _[i]),e(this).remove()}),f.find(".library .single-file").length?L():q("empty"),t.length&&r.request({data:{delete_files_permanently:t},success:function(t){if(t&&"object"===e.type(t)){if(t.clear_cells&&t.clear_cells.length)for(var i=p.getOption("data_file"),a=0,o=t.clear_cells.length;o>a;++a)p.removeCellData(t.clear_cells[a],i,!0);t.usage_text&&e(".usage-text").text(t.usage_text)}}}),v.files_changed=!0}})}),f.on("click","button.circle.reset",function(e){e.preventDefault(),t.publish("sitemap/lightbox_cell_files/close")}),f.on("click",".files-thumbs .thumb:not(.current)",function(t){t.preventDefault();var i=e(this),a=i.data("file");if(a&&"object"===e.type(y[a])&&"string"===e.type(y[a].date)){var o=c.template("lightbox-cell-files-single-file",{date:y[a].date,time:y[a].time,user_name:y[a].user,file_name:y[a].name,file_size:m.humanReadableFileSize(y[a].size),image_src:y[a].url_preview,user_can_edit:g,file_type:y[a].file_type,mime:y[a].mime}),n=e("#lightbox-drop-area-preview");n.children(".toolbar, .file-preview").remove(),n.prepend(o),i.addClass("current").siblings(".thumb.current").removeClass("current"),g&&P(a)}}),f.on("click","button.download, button.viewfull",function(t){t.preventDefault();var i=null,a=e(this).closest(".library-preview");if(a.length?(i=a.data("file"),i=i&&"object"===e.type(_[i])&&_[i]?_[i]:null):(i=f.find(".files-thumbs .thumb.current").data("file"),i=i&&"object"===e.type(y[i])&&y[i]?y[i]:null),i){var o=null;o=e(this).hasClass("download")?i.url_download:i.url_full,o&&window.open(o)}}),f.on("click",".files-thumbs .thumb .delete",function(t){t.preventDefault();var i=e(this).closest(".thumb"),a=i.data("file")||i.attr("id").replace("thumb-","");a&&"object"===e.type(y[a])&&"number"===e.type(y[a].data_id)&&c.confirmDialog({id:"file-library",close:!0,title:"Are you sure you want to delete?",yes_label:"Yes, delete",checkboxes:[{id:"save_image",label:"Save files for later use?",checked:!0},{id:"save_comments",label:"Save comments?"}],on_yes:function(t,n){i.hide(),O();var s=i.prevAll(".thumb:not(.loads):not(.current)").filter(":first");s.length||(s=i.parent().find(".thumb:not(.loads):not(.current)").filter(":first")),s.length&&s.trigger("click"),r.request({data:{remove_cell_file:y[a].data_id,remove_permanently:n.save_image?0:1,remove_comments:n.save_comments?0:1},success:function(t){if(y[a]&&delete y[a],_[a]&&delete _[a],i.remove(),s.length||q("empty",{use_library:!!o},!0),n.save_comments||e("#sitemap-comments").find(".item.hasfile-"+a+".hasfile-cell-"+o+" .foot a[data-delete]").trigger("click"),t.clear_cells&&t.clear_cells.length)for(var r=0,l=t.clear_cells.length;l>r;++r)p.removeCellData(t.clear_cells[r],p.getOption("data_file"),!0);v.files_changed=!0},error:function(){i.show().trigger("click"),O()}})}})}),f.on("click",".thumbs .prev, .thumbs .next",function(t){var i=f.find(".files-thumbs > .thumbs"),a=69*i.find(".thumb").filter(":visible").length-i.find(".container-wrapper").width();a=69*Math.ceil(a/69);var o=e(this).hasClass("next")?69:-69;o*=4;var n=Math.max(0,Math.min(a,_last_margin+o));_last_margin=n,i.find(".container").css("margin-left",-n)}),f.on("submit","#lightbox-post-comment",function(t){t.preventDefault();var i=e("#form-lightbox-comment-file-id").val();if(i){var a=c.wysiwyg("form-lightbox-comment"),n=e("#post-comment");a&&a.save();var s=n.find('input[name="cell_data_id"]');s.length||(s=e('<input type="hidden" name="cell_data_id">').appendTo(n)),
    s.val(y[i].data_id);var r=e("#lightbox-post-comment").find(".submit .loading").css("visibility","visible");n.trigger("submit",[e("#form-lightbox-comment").val(),function(){s.remove(),a&&a.setContent(""),r.css("visibility","hidden"),P(i,o,"bottom")}])}}),f.on("click",".commentsarea .foot a",function(t){t.preventDefault();var i=e("#form-lightbox-comment-file-id").val();if(i){var a=e(this).data("delete");e("#comment-item-"+a).find(".foot a[data-delete]").trigger("click",[function(){P(i,o,"relative")}])}}),f.on("click",".openlibrary",function(e){e.preventDefault(),R(i,{drop_only:!1,use_library:!0})}),f.on("click",".library button.cancel",function(e){e.preventDefault();var i=[];o&&(A("library"),E("library"),f.find(".library").remove(),i=f.find(".files"),i.length||(i=f.find(".empty"))),i.length?(i.show(),n=i.hasClass("files")?"files":"empty",$()):t.publish("sitemap/lightbox_cell_files/close")}),f.on("click",".library .buttons-right button.select",function(t){t.preventDefault();var a=[],n=[];if(f.find(".library .single-file.selected").each(function(){var t=e(this).data("file");t&&(a.push(t),_[t]&&n.push(_[t]))}),v.on_select&&"function"===e.type(v.on_select)){var s=v.on_select(n,a);s!==!1&&f.find(".title button.reset").trigger("click"),v.on_select_once&&(v.on_select=i),t.stopPropagation()}else v.allow_multiple_select&&o&&(a.length?F(a):f.find(".library button.cancel").trigger("click"))}),f.on("click",".upload-button",function(e){e.preventDefault(),B(function(){var e=l.get("account");e.storage_limit<=e.storage_used?t.publish("upload/limit_exceed"):(S=!0,c.confirmDialog({id:"upload-button",close:!0,title:"Add new file/s",custom_label:"Upload New",no_label:"From Library",yes_label:!1,on_no:function(){R(function(e,t){return f.find(".library button.cancel").trigger("click"),F(t,!0),!1})}}))})}),t.subscribe("sitemap/lightbox_cell_files/open",function(i,a,n,s,r){o=a&&a.id?a.id:a,w=s?s:"all",v={allow_multiple_select:!1,files_changed:!1},r&&"object"===e.type(r)&&e.extend(v,r),c.openLighboxModal(f,o),f.children(".row-container").empty(),q("loads"),e("#form-lightbox-comment-file-id").val(""),o?z(function(e){if(e>0){q("files",{file_html:"",user_can_edit:g,cell_id:o,file_id:""});var i=c.objectToArray(y);U(i,n?"#thumb-"+n:".thumb:first"),O("first"),$()}else g?q("empty",{use_library:!0}):t.publish("sitemap/lightbox_cell_files/close")}):T(function(t){if(t>0){var i={};v.library&&e.extend(i,v.library),q("library",i);var a=c.objectToArray(_);N([],a)}else q("empty")})}),t.subscribe("sitemap/lightbox_cell_files/close",function(e){if(c.closeLighboxModal(f,o,function(){A(),E(),n=null}),o&&g&&v.files_changed){var i=c.objectToArray(y);i&&i.length?p.addCellData(o,p.getOption("data_file"),1,!0):p.removeCellData(o,p.getOption("data_file"),!0),p.fullRefresh(),t.publish("sitemap/sitemap_modified",["files_edited",p.getCurrentSection()])}y={},v={}}),t.subscribe("hashchange",function(e,t,i,a){t||"files"!==i&&"library"!==i||f.is(":visible")&&f.find(".title button.circle.reset").trigger("click")}),t.subscribe("upload/limit_exceed",function(){var e=l.get("account");if(e.is_owner)if(e.is_free)d.error("To proceed you will need to upgrade your account");else{var i=t.__('Your {1} account has exceeded it\'s file storage limit. To proceed you will need to <a href="{2}">upgrade</a>',e.name,l.get("payment_url","#"));e.is_highest_plan&&(i=t.__("Your {1} account has exceeded it's file storage limit. Please contact Slickplan support",e.name)),d.error(i)}else d.error("File storage limit exceeded. Contact the account owner")}),t.subscribe("modal/open/modal-confirm",function(i,a){var o=a.data("id");if("upload-button"===o&&S){var n=a.find("#modal-confirm-custom").removeData(),s=f.find(".upload-button").data();e.each(s,function(e,t){n.data(e,t)}),n.data("mime",w),t.publish("upload/dynamic_uploader/init",[n.get(0),"plupload_library","library_upload_modal"])}}),t.subscribe("modal/close/modal-confirm",function(e,t){S=!1}),t.subscribe("upload/files_added_plupload_library",function(i,a,s,l){r.request("get_cell_files_storage_left",{success:function(i){var r=0;i&&"number"===e.type(i.free_space)&&(r=i.free_space);for(var l=0,c=s.length;c>l;++l)r-=s[l].size;if(r>0){if(o){var d=f.find(".files .thumb.current").attr("id");"files"!==n&&q("files"),U(s,d?"#"+d:".thumb:first"),O("last")}else"library"!==n&&(q("library"),N()),N([],s,"bottom",!0);D=a,a.start()}else t.publish("upload/limit_exceed",[-1*r])}})}),t.subscribe("upload/file_uploaded_plupload_library",function(i,a,n,l,d){if(l&&"object"===e.type(l)){if(l.error)return x.size.push(n.name),a.start(),!1;a.stop(),setTimeout(function(){r.request({data:{cell_file_details:{name:n.name,size:n.size,type:n.type},cell_file_s3:l,cell_id:o?o:0},success:function(i){if(i&&"object"===e.type(i)){if(i.success&&i.file&&i.file.alias){var s=e.extend({},i.file);if(s.user_can_edit=g,o){y[i.file.alias]=i.file;var r=c.template("lightbox-cell-files-files-thumb-known",s);f.find("#thumb-"+n.id).replaceWith(r),f.find(".files-thumbs .thumb.current").length||f.find("#thumb-"+i.file.alias).trigger("click"),O()}else{_[i.file.alias]=i.file;var r=c.template("lightbox-cell-files-library-thumb-known",s);f.find("#single-file-"+n.id).replaceWith(r)}v.files_changed=!0,a.start()}else i.error&&i.free_space<=0&&(t.publish("upload/limit_exceed",[-1*i.free_space]),o?(f.find("#thumb-"+n.id).remove(),O()):(f.find("#single-file-"+n.id).remove(),L()));i.usage_text&&e(".usage-text").text(i.usage_text)}},error:function(){x.other.push("Error creating thumbnail of "+n.name),r.request({data:{remove_cell_file:n.id,remove_permanently:1,remove_comments:0,cell_file_s3:l},success:function(t){t&&t.usage_text&&e(".usage-text").text(t.usage_text),a.start()},error:function(){a.start()}}),o?(f.find("#thumb-"+n.id).remove(),O()):(f.find("#single-file-"+n.id).remove(),L()),clearTimeout(s),s=setTimeout(function(){I()},100)}})},10)}a.refresh()}),t.subscribe("upload/error_plupload_library",function(e,t,i,a){switch(i.message){case"File extension error.":x.extension.push(i.file.name);break;case"File size error.":x.size.push(i.file.name);break;default:x.other.push(i.file.name+": "+i.message)}if("library"===n){var o=f.find("#single-file-"+t.id);o.length&&(o.remove(),L())}else"files"===n&&(o=f.find("#thumb-"+t.id),o.length&&(o.remove(),O()));clearTimeout(s),s=setTimeout(function(){I()},100)}),t.subscribe("upload/uploads_progress_plupload_library",function(e,t,i,a){if(i&&i.percent){var n;if(o)n=f.find("#thumb-"+i.id+" .progress").css("width",Math.round(i.percent)+"%");else{n=f.find("#single-file-"+i.id+" .progress");var s=Math.round((n.closest(".single-file").width()-12)*(i.percent/100));n.attr("style","width: "+s+"px;")}var r=n.parent().find(".detailed");if(r.length){var l="";i.percent>=100?l="Crunching&hellip;":(l+=m.humanReadableFileSize(i.loaded,2,1,"&nbsp;"),l+=" of ",l+=m.humanReadableFileSize(i.size,2,1,"&nbsp;")),r.html(l)}}}),t.subscribe("upload/uploads_complete_plupload_library",function(i,a,o,n){D=!1;var s=e(n);s&&s.length&&s.closest("#modal-confirm").length&&t.publish("upload/dynamic_uploader/destroy",["library_upload_modal"])}),t.subscribe("sitemap/container_refreshed",function(){f.is(":visible")&&$()}),t.$window.on("resize",function(){f.is(":visible")&&$()})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){var i=t.require("sitemap"),a=t.require("form"),o=t.require("string"),n=t.require("websocket"),s=e("#slickplan-sitemap"),r=s.data("id")||0;e("#modal-cells-clone").on("click",".submit > input",function(o){o.preventDefault();var s=e(this).closest("form").parent("div");if(a.clearErrors(s.find("form")),!e(this).hasClass("cancel")){var l=e("#clone-section-id"),c=l[0].value;if(!c)return a.error(l.parent(),t.__("Please select destination section"),{bottom:5}),!1;var d=e("#clone-parent-page"),u=d[0].value;if(!u)return a.error(d.parent(),t.__("Please select parent page"),{bottom:5}),!1;var p=e("#clone-assection").is(":checked"),m=i.getCurrentCell(),f=null,h=parseInt(s.find('input[name="clone[childcells]"]:checked').val(),10),g={},v=i.getOptions();if(g[v.data_url]=s.find("#clone-includelinks").is(":checked"),g[v.data_desc]=s.find("#clone-includenotes").is(":checked"),g[v.data_archetype]=s.find("#clone-includearchetypes").is(":checked"),g[v.data_color]=!0,g[v.data_text_color]=!0,g[v.data_section]=s.find("#clone-includesections").is(":checked"),g[v.data_content]=s.find("#clone-includecontents").is(":checked"),g[v.data_file]=s.find("#clone-includefiles").is(":checked"),i.cloneReset(),p){var b=i.cloneCellAsSection(m,g,h,u,!1,c);f=b.section_id,b=b.cells}else var b=i.cloneCell(m,g,h,u,!0,c);if("object"===e.type(b)&&"string"===e.type(b.id)||e.isArray(b)&&b.length&&"string"===e.type(b[0].id)){var _=i.cloneGetResults();_.length?n.request("clone_cell_datas",{data:{sitemap_id:r,datas:_},success:function(){i.fullRefresh(),t.publish("sitemap/sitemap_modified",["cells_clone",c,p,f])}}):(i.fullRefresh(),t.publish("sitemap/sitemap_modified",["cells_clone",c,p,f]))}}s.dialog("close")}).on("change","#clone-section-id",function(n){var s=e("#clone-parent-page"),r=s.closest(".select");if(a.clearErrors(e(this).closest("form")),this.value){var l='<option value="">'+t.__("Select Parent Page")+"</option>";r.show(),s.html(l);for(var c=i.serializeCells(this.value,!0,["util","1","foot"]),d=0;d<c.length;++d){var u=i.getCellLevel(c[d]);if("home"!==u){var p="number"===e.type(u)?u:0;e('<option value="'+c[d].id+'">'+o.charsEncode(c[d].text)+"</option>").data("indent",p).appendTo(s)}}s.selectmenuslickplan("destroy"),s.selectmenuslickplan({style:"popup",maxHeight:300,format:function(e){return t.require("string").charsEncode(e)}})}else r.hide()}),t.subscribe("modal/open/modal-cells-clone",function(){var a=i.getListOfSections(),n="",s=0,r=e("#clone-section-id"),l=e("#clone-parent-page"),c=r.closest(".select"),d=l.closest(".select"),u='<option value="">'+t.__("Select Section")+"</option>";e.each(a,function(e,t){n+='<option value="'+e+'">'+o.charsEncode(t)+"</option>",++s}),s>1?(r.html(u+n),r.selectmenuslickplan("destroy"),r.selectmenuslickplan({style:"popup",maxHeight:300,format:function(e){return t.require("string").charsEncode(e)}}),c.show(),d.hide()):(r.html(u+n).val(i.getOption("id_main_section")).trigger("change"),c.hide(),d.show())})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){var i=t.require("sitemap"),a=e("#sitemap-themes"),o=!(t.currentUserCan("sitemap_color_themes")&&a.length);if(e("#action-color-themes").on("click",function(n){return n.preventDefault(),o?t.noPermissions():(t.publish("sitemap/color_edit_open",[i.getCurrentSection(),"themes"]),a.siblings("form.show").find("button.reset").trigger("click",[!0]),i.backupColors(),document.getElementById("themes-wrapper").style.marginLeft="0px",i.isMainSection()&&t.$window.scrollTop()>84?e("html, body").stop().animate({scrollTop:84},200,"easeOutCubic",function(){a[0].classList.add("show")}):a[0].classList.add("show"),i.modified=!1,void e("#sitemap-top").addClass("visible"))}),!o){var n=1;a.on("click","a.prev, a.next",function(t){t.preventDefault();var i=777,a=Math.ceil(e("#themes .theme").length/3);e(this).hasClass("next")?a>n&&++n:n>1&&--n,document.getElementById("themes-wrapper").style.marginLeft=(n-1)*i*-1+"px"}).on("click","ul[data-theme]",function(){var t={};e(this).children("li").each(function(i){var a=e(this).data("color");0===i?t.home=a:5===i?(t.util=a,t.foot=a):t["level"+i]=a}),i.setTempScheme(t),i.modified=!0}).on("click","button.reset",function(o,n){o.preventDefault(),i.revertColors(),a[0].classList.remove("show"),i.modified=!1,e("#sitemap-top").removeClass("visible"),n!==!0&&t.publish("sitemap/color_edit_close",[i.getCurrentSection(),"themes"])}).on("click","button.submit",function(o){o.preventDefault(),i.backupColors(),a[0].classList.remove("show"),i.modified&&(t.publish("sitemap/sitemap_modified",["color_scheme",i.getCurrentSection(),i.getCurrentColorScheme(),{style:i.getStyle(),textShadow:i.getTextShadow()}]),i.modified=!1),e("#sitemap-top").removeClass("visible"),t.publish("sitemap/color_edit_close",[i.getCurrentSection(),"themes"])})}})}),Slickplan.module(function(e,t,i){var a=!(t.currentUserCan("sitemap_custom_color")&&e("#sitemap-custom").length);t.subscribe("route/sitemap",function(){var i,o=t.require("sitemap"),n=t.require("form"),s=t.require("websocket"),r=t.require("notification"),l=t.require("helper"),c=!1,d=e("#sitemap-custom"),u=e("#modal-color-save"),p=e("#modal-color-load");t.$main.on("click","#action-custom-color",function(n){return n.preventDefault(),a?t.noPermissions():(d.siblings("form.show").find("button.reset").trigger("click",[!0]),t.publish("sitemap/color_edit_open",[o.getCurrentSection(),"custom_color"]),o.backupColors(),i=o.getCurrentColorScheme(),o.isMainSection()&&t.$window.scrollTop()>84?e("html, body").stop().animate({scrollTop:84},200,"easeOutCubic",function(){d[0].classList.add("show")}):d[0].classList.add("show"),o.modified=!1,void e("#sitemap-top").addClass("visible"))}),a||(d.on("mouseenter","li.color",function(){e(this).data("color")||e(this).addClass("hover")}).on("mouseleave","li.color",function(){e(this).removeClass("hover")}).on("click","li.color",function(){var a=e(this),n=a.data("color");if(n){var s=document.getElementById("level-custom").value;"all"===s?i={default_color:n,text_color:i.text_color,lines_color:i.lines_color}:i[s]=n,o.setTempScheme(i),o.modified=!0}else e(".top-modal").dialog("close"),e("#topmodal-farbtastic.top-modal").parent().addClass("topFive").data("li",a).end().find("form").each(function(){this.reset()}).end().find(".breset").val(t.__("Cancel")).end().dialog("open").parent().find("input").filter(":first").blur()}).on("click","#palette-save",function(i){i.preventDefault();var a=!0;d.find("li.color").each(function(){return e(this).data("color")?(a=!1,!1):void 0}),a?r.error(t.__("Select at least one swatch")):(e(".modal").dialog("close"),u.find("form").each(function(){this.reset()}).end().dialog("open").find("input").filter(":first").focus())}).on("click","#palette-load",function(i){i.preventDefault(),p.find("label[data-palette]").length?(e(".modal").dialog("close"),p.find("form").each(function(){this.reset()}).end().dialog("open").find("input").filter(":first").focus()):r.error(t.__("No saved palettes exist"))}).on("click","#palette-new",function(i){i.preventDefault(),c?l.confirmDialog({close:!1,title:t.__("Save palette."),text:t.__("Would you like to save the current palette before creating new one?"),on_yes:function(){e("#palette-save").trigger("click"),c=!1,e("#palette-new").trigger("click")},on_no:function(){c=!1,e("#palette-new").trigger("click")}}):d.find("li.color").data("color","").children("p").css({backgroundColor:"#fff"})}).on("click","button.reset",function(i,a){i.preventDefault(),o.revertColors(),d[0].classList.remove("show"),o.modified=!1,e("#sitemap-top").removeClass("visible"),a!==!0&&t.publish("sitemap/color_edit_close",[o.getCurrentSection(),"custom_color"])}).on("click","button.submit",function(a){a.preventDefault(),o.backupColors(),d[0].classList.remove("show"),o.modified&&(t.publish("sitemap/sitemap_modified",["color_scheme",o.getCurrentSection(),i,{style:o.getStyle(),textShadow:o.getTextShadow()}]),o.modified=!1),e("#sitemap-top").removeClass("visible"),t.publish("sitemap/color_edit_close",[o.getCurrentSection(),"custom_color"])}),u.on("submit","form",function(i){i.preventDefault(),s.clearAll(),r.clearAll();var a=e(this),o=a.find('input[name="palette[name]"]');n.clearErrors(a);var l=n.validate([{value:o.val(),tiperror:o.parent(),rules:{empty:t.__("Name must not be empty")},css:{bottom:5}}]);if(l){var d=a.closest(".modal"),p=n.serializeObject(a);s.request({data:p,$loading:a.find(".loading").css({visibility:"visible"}),success:function(i){i.error?n.error(u.find("div.input"),i.error,{bottom:5}):i.success&&(d.dialog("close"),r.success(t.__("New palette saved")),"string"===e.type(i.table)&&(e("#custom-palette-table").replaceWith(e(i.table).find("#custom-palette-table")),e("#custom-palette-table .table-scroll tr").length>4&&t.require("scrollbar").init(e("#custom-palette-table .table-scroll"),{thumbSize:64})),c=!1)},error:function(){d.dialog("close")}})}}),p.on("submit","form",function(i){i.preventDefault();var a=e(this);n.clearErrors(a);var o=a.find('input[type="checkbox"]:checked'),s=null;if(o.length>1)s=t.__("You can only load one palette at once");else if(1===o.length){var r=o.siblings("label").data("palette");l.isObject(r,!0)&&(d.find("ul.palette li.color").each(function(t){"string"===e.type(r[t])&&r[t]?e(this).data("color",r[t]).children("p").css({backgroundColor:r[t]}):e(this).data("color","").children("p").css({backgroundColor:"#fff"})}),c=!1),a.closest(".modal").dialog("close")}else s=t.__("Select palette to load");s&&n.error(a.find(".submit"),s,{bottom:33,left:"95%"})}).on("click","#delete-palettes",function(i){i.preventDefault(),r.clearAll();var a=e(this).closest("form");n.clearErrors(a);var o=a.find('input[type="checkbox"]:checked'),l=a.closest(".modal");if(o.length>0){var c=n.serializeObject(a);s.request({data:c,$loading:a.find(".loading").css({visibility:"visible"}),success:function(i){i.error?n.error(a.find(".submit"),i.error,{bottom:33},"",!0):i.success&&(l.dialog("close"),r.success(t.__("Palettes deleted")),"string"===e.type(i.table)&&(e("#custom-palette-table").replaceWith(e(i.table).find("#custom-palette-table")),e("#custom-palette-table .table-scroll tr").length>4&&t.require("scrollbar").init(e("#custom-palette-table .table-scroll"),{thumbSize:64})))},error:function(){l.dialog("close")}})}else n.error(a.find(".submit"),t.__("Select palettes to delete"),{bottom:33},!1,-15)}),t.subscribe("modal/farbtastic_swatch_saved",function(e,t,i){c=!0}),t.$body.on("mouseenter","#level-custom-menu li",function(t){var i=e("#level-custom option:eq("+e(this).data("index")+")").val();o.highlightLevel(i)}).on("mouseleave","#level-custom-menu li",function(e){o.highlightLevel(!1)}))}),a||t.subscribe("modal/open/modal-color-save",function(t,i){var a=i.find("ul.palette").empty(),o=0;e("#sitemap-custom li.color").each(function(){var t=e(this).data("color");t&&a.append('<li class="color"><p style="background: '+t+'"></p><input type="hidden" name="new_palette[colors]['+o++ +']" value="'+t+'"></li>')})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){function a(e,i,a,o){p+='<li><a href="#" class="'+i+'"',o&&(p+=" "+o),p+=">",a&&(a=a.split(","),a.length>1?(1===a[0].length?a[0]='<span class="letter">'+a[0]+"</span>":a[0]='<i class="fa fa-'+a[0]+'"></i>',1===a[1].length?a[1]='<span class="letter">'+a[1]+"</span>":a[1]='<i class="fa fa-'+a[1]+'"></i>',a='<span class="icon">'+a[0]+a[1]+"</span>"):a='<i class="icon fa fa-'+a[0]+'"></i>',p+=a+" "),p+='<span class="name">'+t.__(e)+"</span></a></li>"}var o,n=t.require("websocket"),s=t.require("sitemap"),r=t.require("svg"),l=t.require("helper"),c=t.require("notification"),d=e("#slickplan-sitemap"),u=e("#topmodal-farbtastic"),p="",m="",f=d.data("id")||0;a("Delete","delete","times"),a("Edit Name","dblclick","T,pencil"),t.currentUserCan("cell_color")&&u.length?a("Edit Page Color","cellmodal color ecolor","square-o,eyedropper",'data-modalid="farbtastic"'):a("Edit Page Color","disabled ecolor","square-o,eyedropper"),t.currentUserCan("cell_text_color")&&u.length?a("Edit Text Color","cellmodal textcolor tcolor","T,eyedropper",'data-modalid="farbtastic"'):a("Edit Text Color","disabled tcolor","T,eyedropper"),t.currentUserCan("cell_cloning")&&e("#modal-cells-clone").length?a("Clone","cellmodal cellclone","files-o"):a("Clone","disabled","files-o"),t.currentUserCan("sitemap_sections")?(a("Add Section","cellmodal cellsection","slickplansection"),a("Remove Section","cellmodal cellsectionremove","slickplansection")):a("Add Section","disabled","slickplansection"),t.currentUserCan("cell_note")?a("Add Note","cellmodal desc","file-o",'data-modalid="cell-note"'):a("Add Note","disabled","file-o"),t.currentUserCan("cell_url")?a("Add Link","cellmodal url","link",'data-modalid="cell-url"'):a("Add Link","disabled","link"),t.currentUserCan("cell_archetype")&&e("#topmodal-cell-archetype").length?a("Page Type","cellmodal archetype","flag",'data-modalid="cell-archetype"'):a("Page Type","disabled","flag"),t.isFunctionEnabled("cells_images_gallery")&&a("Design Mockups",t.currentUserCan("cell_files")?"xcellfile":"disabled","picture-o"),t.isFunctionEnabled("cell_diagrams")&&a("Diagrams",t.currentUserCan("cell_diagrams")?"xcelldiagrams":"disabled","sitemap"),t.isFunctionEnabled("content_gathering")&&(t.currentUserCan("content_gathering")?a("Add Content","xcellcontent","book"):a("Add Content","disabled","book")),a("Hide Children","expandcollapse collapse","eye-slash"),a("Show Children","expandcollapse expand","eye"),t.currentUserCan("content_gathering")&&(a("Add Row Above","cg-action item-row add-row-above","arrow-circle-o-up"),a("Add Row Below","cg-action item-row add-row-below","arrow-circle-o-down"),a("Delete Row","cg-action item-row remove-row","trash"),a("Add Column Left","cg-action item-column add-column-left","arrow-circle-o-left"),a("Add Column Right","cg-action item-column add-column-right","arrow-circle-o-right"),a("Delete Column","cg-action item-column remove-column","trash"),a("Remove Block","cg-action cg-remove-block","trash"),a("Options","cg-action cg-options","cog")),a("Add Pages Above","fs-action fs-add-above","arrow-circle-o-up"),a("Add Pages Below","fs-action fs-add-below","arrow-circle-o-down"),a("Add Subpages","fs-action fs-add-subpages","arrow-circle-o-right"),t.currentUserCan("cell_diagrams")&&(a("Sitemap Page","ia-page-options ia-internal-page","square-o"),a("Custom Page","ia-page-options ia-custom-page","square-o"));var h=e('<div id="map-dropdown" class="two-columns"><ul>'+p+"</ul></div>").appendTo(t.$body);e("html").on("mouseup.dropdown",function(i){s.last_mouse_event=i,h.is(":visible")&&(h.hide(),e("#map-dropdown-overlay").remove(),"content-gathering"!==m&&(d.find("svg.force-hover").each(function(){r.removeClass(this,"force-hover")}),t.publish("sitemap/dropdown_close",[i,h])))}),t.$body.on("click",".action.menu",function(i){i.preventDefault(),s.hideAddHelperPlaceholder(!1);var a=e(this).closest("svg.cell");d=a.closest(".sitemap-wrapper-area");var o=a[0];d.find("svg.cell.force-hover").each(function(){r.removeClass(this,"force-hover")}),r.addClass(o,"force-hover"),h.find("li > a").removeClass("disabled-ws"),t.publish("sitemap/dropdown_before_open",[h,o]);var n=s.getOffsets(o),l=t.getWindowWidth()+t.$window.scrollLeft()-362,u=Math.max(5,Math.min(n.left+n.width-182,l)),p=d.offset().top+n.top+n.height-5,m=e("#section-svg-wrapper");m.is(":visible")&&(p-=m.scrollTop()),h.css({position:"absolute",top:p,left:u}),h.show().attr("class","two-columns").before('<div id="map-dropdown-overlay" style="display: block" />'),t.publish("sitemap/dropdown_open",[h]);var f=h.data("info");h.data("info","").removeData("info"),f&&c.info(f,{persistent:!1,time:3e3,scroll:!1})});var g=function(e){e||(e=s.getCurrentCell());var t=s.getBlockedCell(r.getAttr(e,"id"));if(t){var i=[];if(t["lightbox-cell-content"]&&i.push(t["lightbox-cell-content"]+" is editing content"),t["lightbox-cell-diagrams"]&&i.push(t["lightbox-cell-diagrams"]+" is editing diagrams"),t["lightbox-cell-files"]&&i.push(t["lightbox-cell-files"]+" is editing files"),i.length)return c.info(i.join(", "),{permanent:!1}),!0}return!1};h.on("click",".disabled",function(e){return e.preventDefault(),e.stopPropagation(),t.noPermissions()}).on("click",".delete",function(a){a.preventDefault();var o=s.getCurrentCell(i,!0);if(o){if(g(o))return!1;var c=r.hasClass(o,"has-file"),d=r.hasClass(o,"has-content"),u=r.hasClass(o,"has-diagrams"),p=!1;if(c||d||u){var h=r.getAttr(o,"id"),v="This page has",b=[];c&&(v+=" file/s",b.push({id:"save_image",label:"Save files for later use?"}),p=e("#sitemap-comments").find(".hasfile-cell-"+h),p.length&&(v+=" with comments",b.push({id:"save_comments",label:"Save comments?"}))),u&&(c&&!d?v+=" and":c&&(v+=","),v+=" diagram/s"),d&&((c||u)&&(v+=" and"),v+=" content"),l.confirmDialog({close:!0,title:v,text:"Are you sure you want to delete this page?",yes_label:"Delete",no_label:"Cancel",checkboxes:b,on_yes:function(i,a){n.request({data:{remove_cell_data:{sitemap_id:f,cell_id:h,datas:{files:c?a&&a.save_image?"keep":1:0,comments:!c||!p.length||a&&a.save_comments?0:1,diagrams:u?1:0,content:d?1:0}}},success:function(){!c||!p.length||a&&a.save_comments||p.find(".foot a[data-delete]").each(function(){e(this).trigger("click",[!1,!0])})}}),"fast-sidebar"===m&&t.publish("sitemap/fast_sidebar_change",["delete",o]),s.removeCell(o),s.fullRefresh()}})}else"fast-sidebar"===m&&t.publish("sitemap/fast_sidebar_change",["delete",o]),s.removeCell(o),s.fullRefresh()}}).on("click",".dblclick",function(e){if(e.preventDefault(),s.isEditBlocked())return!1;var t=s.getCurrentCell();l.cellGroupWarningDialog(t,{on_after:function(e){s.showTextEdit(e)}})}).on("click",".cellsection",function(t){t.preventDefault();var a=s.getCurrentCell(),o=r.getData(a,s.getOption("data_section"));if(!o){var n=e("#modal-section-menu").removeClass("remove-section").addClass("add-section"),l=e(this).text();return n.find(".title").text(l),n.find('input[type="submit"]').val(l),n.find("form").children(".radio:not(.visible), .input, .checkbox").hide(),n.find("form").children(".options, .radio.visible").show(),r.getData(a,s.getOption("data_childs"))&&n.find("#section-menu-move").parent().show(),s.hasSections()&&n.find("#section-menu-link, #section-menu-clone").parent().show(),n.dialog("open"),!1}s.openSection(i,a)}).on("click",".cellsectionremove",function(t){t.preventDefault();var i=s.getCurrentCell(),a=r.getData(i,s.getOption("data_section")),o=a.split(":");if(o.length>1&&"link"===o[0])s.removeCellSection(i,!0),s.fullRefresh();else if(a){var n=e("#modal-section-menu").removeClass("add-section").addClass("remove-section");n.find("form").children(".radio, .input, .checkbox, .options").hide();var l=e(this).text();n.find(".title").text(l),n.find('input[type="submit"]').val(l),n.find("#section-menu-move-back").parent().show(),n.dialog("open")}}).on("click",".cellclone",function(t){return t.preventDefault(),g()?!1:void e("#modal-cells-clone").dialog("open")}).on("click",".expandcollapse",function(e,i){return e.preventDefault(),t.$body.hasClass("expanded-batch")?!1:(i||(i=s.getCurrentCell()),void(i&&s.toggleChildren(i)))}).on("click","[data-modalid]",function(t,i){if(t.preventDefault(),g())return!1;if(!i){var a=s.getCurrentCell(),o=e(this),n=o.data("modalid");l.cellGroupWarningDialog(a,{on_single:function(){o.attr("data-topmodal",n).data("topmodal",n),o.trigger("click",[!0]),o.removeAttr("data-topmodal").removeData("topmodal")},on_group:function(){setTimeout(function(){o.attr("data-topmodal",n).data("topmodal",n),o.trigger("click",[!0]),o.removeAttr("data-topmodal").removeData("topmodal")},310)}})}}).on("click",".xcellfile",function(e){return e.preventDefault(),g()?!1:void t.publish("sitemap/lightbox_cell_files/open",[s.getCurrentCell(),i,"images",{allow_multiple_select:!0}])}).on("click",".xcelldiagrams",function(e){return e.preventDefault(),g()?!1:void t.publish("sitemap/lightbox_cell_diagrams/open",[s.getCurrentCell()])}).on("click",".xcellcontent",function(e){return e.preventDefault(),g()?!1:void t.publish("sitemap/lightbox_cell_content/open",[s.getCurrentCell()])}),t.subscribe("sitemap/dropdown_before_open",function(e,a,n,l,c){if(clearTimeout(o),m=l,"content-gathering"===m)a.find("li").hide().find(".cg-remove-block, .cg-options").parent().css("display","inline-block");else if("diagram-page"===m)a.find("li").hide().find(".ia-page-options").parent().css("display","inline-block");else if("fast-sidebar"===m){s.setCurrentCell(n);var d="";"home"!==c&&(d+=".fs-action","util"!==c&&"foot"!==c||(d+=":not(.fs-add-subpages)")),a.find("li").hide().find(d).parent("li").css("display","inline-block")}else{s.setCurrentCell(n);var u=s.getOptions();s.getCellLevel(n);a.find("li").css("display","inline-block"),"home"===r.getData(n,u.data_level)?a.find(".cellsection, .cellsectionremove").closest("li").hide():r.getData(n,u.data_section)?a.find(".cellsection .name").text(t.__("View Section")):(a.find(".cellsection .name").text(t.__("Add Section")),a.find(".cellsectionremove").closest("li").hide()),r.getData(n,u.data_desc)!==i&&""!==r.getData(n,u.data_desc)?a.find(".desc .name").text(t.__("Edit Note")):a.find(".desc .name").text(t.__("Add Note")),r.getData(n,u.data_url)!==i&&""!==r.getData(n,u.data_url)?a.find(".url .name").text(t.__("Edit Link")):a.find(".url .name").text(t.__("Add Link")),a.find(".expandcollapse").closest("li").hide(),a.find(".cg-action, .fs-action, .ia-page-options").closest("li").hide()}}),t.subscribe("sitemap/dropdown_close",function(e){h.length&&(o=setTimeout(function(){m=null,h.removeAttr("class")},200))}),t.$window.on("load",function(){t.publish("sitemap/map_dropdown/init",[h])})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){var a,o=t.require("string"),n=t.require("sitemap"),s=t.require("helper"),r=t.require("svg"),l=e("#sitemap-fast-edit-sidebar").disableSelection(),c=e("#btn-sitemap-fast-edit-sidebar"),d=e("#sitemap-fast-edit-overlay"),u=l.find(".menu-list"),p=l.find("#btn-submenu-sitemap-fast-edit-sidebar"),m=!1,f=function(t,i,a,n){var s="";return e.each(t,function(e,t){t&&t.text&&(n||s||(s+="<ul"+(a||"")+">"),s+='<li data-cellid="'+t.id+'" data-parentid="'+(t.parent||"")+'"'+(i?' class="mjs-nestedSortable-no-nesting"':"")+'><span class="label">'+o.charsEncode(t.text)+"</span>",!i&&t.childs&&(s+=f(t.childs,i)),s+="</li>")}),!n&&s&&(s+="</ul>"),s},h=function(){u.children("ul").each(function(){e(this).find("li").removeClass("odd").filter(":even").addClass("odd")})},g=function(){var e=n.getCurrentSection(),t=n.getJSON();if(t&&t[e]&&t[e].cells){var i=n.getMultidimensionalCells(t[e].cells);if(i){var a="";i.util&&i.util.length&&(a+=f(i.util,!0,' class="items-root items-util"')),i.home&&(a+=f([i.home],!0,' class="items-root items-home"')),i[1]&&i[1].length&&(a+=f(i[1],!1,' class="items-root items-default"')),i.foot&&i.foot.length&&(a+=f(i.foot,!0,' class="items-root items-foot"')),v(a)}}},v=function(t){u.html(t),h(),u.children("ul").nestedSortable({update:function(t,i){var a=e(i.item),o=a.data("cellid"),s=a.data("parentid")||null,r=a.parent().closest("li").data("cellid")||null;if(r===s){var l=a.prev("li").data("cellid");if(l)n.moveCellAction("after",l,o);else{var c=a.next("li").data("cellid");c&&n.moveCellAction("before",c,o)}}else if(r)a.data("parentid",r),n.moveCellAction("parent",r,o,a.prev("li").data("cellid"));else{a.removeData("parentid");var d=a.closest("ul.items-root");if(d.hasClass("items-home")||d.hasClass("items-util")||d.hasClass("items-foot"))a.find("li").removeData("parentid");else{var l=a.prev("li").data("cellid");if(l)n.moveCellAction("after",l,o,!1);else{var c=a.next("li").data("cellid");c&&n.moveCellAction("before",c,o,!1)}}}h()},listType:"ul",doNotClear:!0,handle:".label",items:"li",toleranceElement:"> .label"})};u.on("mouseenter",".label",function(){if(!m)return!1;a=e(this).closest("li");var i=a.closest("ul.items-root");if(!i.hasClass("items-home")){var o=Math.max(0,u.outerWidth()-u.children("ul").filter(":first").outerWidth()),s=e(this).offset().top-t.$window.scrollTop();p.show().css({right:15+o,top:s+5})}var r=a.data("cellid"),l=e("#"+r).closest("#section-svg-wrapper");n.scrollToView(l,r),n.highlightCell(r)}).on("dblclick",".label",function(){if(!m)return!1;a=e(this).closest("li");var i=a.data("cellid");s.cellGroupWarningDialog(i,{on_after:function(){s.confirmDialog({title:t.__("Edit Page Name"),on_yes:function(a,o,s){var r=e.trim(s.val().toString());if(""!==r){var l=n.showTextEdit(i,!0);l.value=r,r=n.finishTextEdit(i),t.publish("sitemap/fast_sidebar_change",["name",r])}},yes_label:"Submit",no_label:"Cancel",close:!0,input:!0,input_text:r.getData(i,"text")})}})}),l.on("click","#btn-submenu-sitemap-fast-edit-sidebar",function(i){if(i.preventDefault(),a.length){var o=a.data("cellid");p.addClass("force-show");var n=e("#map-dropdown").attr("class","fast-sidebar"),s=a.closest("ul.items-root"),r=s.hasClass("items-home")?"home":s.hasClass("items-util")?"util":s.hasClass("items-foot")?"foot":"";
    t.publish("sitemap/dropdown_before_open",[n,o,"fast-sidebar",r]),n.show().css({position:"fixed",top:a.position().top+30,left:203}).before('<div id="map-dropdown-overlay" style="display: block" />')}}).on("mouseleave",function(){p.hide(),n.removeHighlights()}),c.on("click",function(e){e.preventDefault(),m=!1,l.toggleClass("open"),l.hasClass("open")?(u.empty(),d.show(),g(),t.publish("sitemap/fast_edit_sidebar/open",[l])):(d.hide(),t.publish("sitemap/fast_edit_sidebar/close",[l]))}),t.subscribe("sitemap/fast_edit_sidebar/open",function(){c.addClass("active"),t.$body.addClass("has-sidebar").scrollTo(0,0),t.$window.trigger("scroll"),setTimeout(function(){m=!0},301)}),t.subscribe("sitemap/fast_edit_sidebar/close",function(){c.removeClass("active"),t.$body.removeClass("has-sidebar").scrollTo(0,0),t.$window.trigger("scroll")}),t.subscribe("sitemap/fast_sidebar_change",function(e,t,i){if(!l.hasClass("open"))return!1;switch(t){case"name":i!==!1&&""!==i&&a.children("span").text(i);break;case"delete":a.remove(),h()}}),t.subscribe("sitemap/map_dropdown/init",function(o,l){l.on("click",".fs-add-above, .fs-add-below, .fs-add-subpages",function(o){o.preventDefault();var l=e(this).hasClass("fs-add-subpages")?"subpages":e(this).hasClass("fs-add-below")?"below":"above",c=a.data("cellid"),d=a.data("parentid");s.confirmDialog({text:"Please enter page names, each in new line",title:t.__("Add Pages"),on_yes:function(t,o,s){var u=s.val().toString().split("\n"),p={text:"",order:1e3},m=n.getCellLevel(c);"subpages"===l&&"number"===e.type(m)?(++m,d=c,p.parent=c,a.children("ul").children("li").each(function(){var t=e(this).data("cellid");p.order=Math.max(p.order,parseInt(r.getData(t,"order"),10))}),++p.order):"above"===l?(p.before=c,p.order=parseInt(r.getData(c,"order"),10)-999,d&&(p.parent=d)):(p.after=c,p.order=parseInt(r.getData(c,"order"),10)+1,d&&(p.parent=d));for(var f=0,h=0,v=u.length;v>h;++h)if(p.text=e.trim(u[h]),""!==p.text){n.insertCell(p,m);if(++f>=1e3)break;++p.order}f>0&&(n.serialize(i,!0),n.fullRefresh(),g())},yes_label:"Add",no_label:"Cancel",close:!0,input:"textarea",input_text:""})})}),t.subscribe("sitemap/dropdown_close",function(){p.removeClass("force-show")})})}),Slickplan.module(function(e,t,i){var a={},o="history_"+t.require("config").get("route").join("_")+"_",n=!1,s=!0;t.subscribe("route/sitemap",function(){var i=t.require("sitemap"),s=t.require("session"),r=t.require("notification"),l=t.require("svg");t.$main.on("click","#action-undo, #action-redo",function(c){if(c.preventDefault(),i.isEditBlocked())return!1;r.clearAll(!0),n=!0;var d="action-undo"===this.id,u=i.getCurrentSection(),p=o+u,m=!1;if(d)var f=a[p]>0;else var h=s.countItems(p)-1,f=h>a[p];if(f){a[p]+=d?-1:1;var g=s.getItem(p,a[p]);if(g&&g.serialized&&g.serialized[u]){if(g.sections&&g.sections.length){var v=i.getSectionsIds();if(v.length)for(var b=0,_=v.length;_>b;++b)e.inArray(v[b],g.sections)<0&&i.removeSection(v[b]);for(var b=0,_=g.sections.length;_>b;++b)if(e.inArray(g.sections[b],v)<0&&g.serialized[g.sections[b]]){var y={};y[g.sections[b]]=g.serialized[g.sections[b]],i.setJSON(y)}}i.clearCache(u),l.clearCache(!0,u);var y={};y[u]=g.serialized[u],i.setJSON(y),i.loadSection(u),i.fullRefresh(),t.publish("sitemap/history_"+(d?"undo":"redo"),[d?"undo":"redo",u,g])}else m=!0}else m=!0;m&&(m=i.isMainSection(u)?t.__("No more history states for main sitemap"):t.__("No more history states for this section"),r.error(m,{persistent:!1})),n=!1})}),t.subscribe("sitemap/full_refresh sitemap/sitemap_modified sitemap/trigger_add_history",function(r,l,c,d){n||d&&"object"===e.type(d)&&d.disable_history||setTimeout(function(){var e=t.require("sitemap"),n=t.require("session"),r=t.require("string"),l=e.getSerialized(!0);c=c?c:e.getCurrentSection();var d=o+c;if(s)n.removeData(new RegExp("^"+o+".+$")),s=!1;else if(a[d]!==i&&a[d]>=0)for(;n.countItems(d)-1>a[d];)n.removeItem(d);var u={serialized:l},p=JSON.stringify(l[c]?l[c]:l);u.sections=e.getSectionsIds(),u.hash=r.hashCode(p);var m=n.getItem(d,a[d]);m&&m.hash===u.hash||(n.addItem(d,u),a[d]=n.countItems(d)-1,t.log("History: added","debug",d,u,a[d]))},1)})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){function i(e){return e.preventDefault(),e.stopPropagation(),p.dialog("close"),r.error(t.__('<a href="{1}">Upgrade</a> your account to use this feature',s.get("payment_url","#"))),!1}function a(e){t.subscribe("modal/open/modal-export",function(t,i){i.find('.ui-tabs-nav a[href="#import-tab"]').trigger("click"),i.find('#import-tab input[type="radio"][name="import[type]"][value="'+e+'"]').prop("checked",!0).trigger("change")}),p.dialog("open")}var o,n=t.require("websocket"),s=t.require("config"),r=t.require("notification"),l=t.require("form"),c=t.require("helper"),d=t.require("http"),u=t.require("string"),p=e("#modal-export"),m=function(){var e=p.children("form").filter(":visible").height()+(p.outerHeight(!0)-p.height());e=Math.max(e,410);var i=t.$window.height()-e;i=i>0?Math.max(i/2,0):0,p.parent("div").css({top:i,height:e})};p.on("change",'#export-tab input[name="export[type]"], #import-tab input[name="import[type]"]',function(){var t=e(this);l.clearErrors(t.closest("fieldset"));var i=/^export/.test(this.name),a=i?"#exportopts":"#importopts",o=this.value;t.parent().hasClass("disabled")&&(o+=" disabled"),e(a).removeAttr("class").addClass(o).insertAfter(t.closest(".radio")),e("#form-xnote").off("change").on("change",function(){var t=e(this).parent().next(".notestype");t.length&&(this.checked?t.show():t.hide())}).trigger("change"),i||e("#importopts").find("input.filename").val("").end().children(".hide-me").hide().siblings(".checkbox").filter(":visible").find('input[type="checkbox"]').trigger("change"),m()}).on("change","#form-landscape",function(){p.find(".paper").removeClass("landscape"),e(this).is(":checked")&&p.find(".paper").addClass("landscape"),m()}).on("submit","#export-tab",function(a){clearTimeout(o),t.ignoreUnload(!0);var n=e(this).find('input[type="radio"][name="export[type]"]:checked').val();if("ppd"!==n&&!t.currentUserCan("sitemap_export_"+n))return i(a);var s=e(this).find(".loading").css({visibility:"visible"});o=setTimeout(function(){s.css({visibility:"hidden"}),t.ignoreUnload(!1)},5e3)}).on("submit","#import-tab",function(a){l.clearErrors(e(this));var o=e(this).find('input[type="radio"][name="import[type]"]:checked').val();if("xml"===o&&!t.currentUserCan("sitemap_import_google")||"crawler"===o&&!t.currentUserCan("sitemap_import_crawler"))return i(a,!0);if("slickplan"===o&&!t.currentUserCan("sitemap_import_slickplan")||"wordpress"===o&&!t.currentUserCan("sitemap_import_wordpress")||"dash"===o&&!t.currentUserCan("sitemap_import_dash_hierarchy"))return i(a);if("crawler"===o&&e("#form-import-limit").is(":checked")){var n=e("#form-import-pages_limit"),s=parseInt(e.trim(n.val().replace(/[^0-9]/g,"")),10),r=parseInt(n.attr("min"),10),c=parseInt(n.attr("max"),10);if(r>s||s>c)return l.error(n.parent(),t.__("Limit must be a number between {1} and {2}",r,c),{bottom:10,left:178}),!1}var d=e(this).find(".loading").css({visibility:"visible"});setTimeout(function(){d.css({visibility:"hidden"})},5e3)}).on("click","#ontimepay-step2, #ontimepay-upgrade",function(i){if(i.preventDefault(),"ontimepay-step2"===this.id)var a=e('#import-tab input[type="radio"][name="import[type]"]:checked').val(),o=s.get("https_uri","")+s.get("route",[]).join("/")+"/onetime"+a;else var o=s.get("payment_url","#");t.has_unsaved_changes.test()?(p.dialog("close"),c.confirmDialog({close:!0,title:t.__("Save changes."),text:t.__("Would you like to save changes before redirecting?"),on_yes:function(){e("#action-save").trigger("click",[function(){d.redirect(o)}])},on_no:function(){d.redirect(o)}})):d.redirect(o)}).on("click","#ontimepay-step3",function(t){t.preventDefault(),e("#onetimepay").remove(),e("#importopts").find(".crawler-hidden").removeClass("crawler-hidden").addClass("crawler").end().find(".xml-hidden").removeClass("xml-hidden").addClass("xml"),m()}).on("click","#ccard-submit button",function(i){i.preventDefault();var a=e(this),o=a.closest("form"),n=t.require("ajax");n.clearAll(),l.clearErrors(o);var r=e("#form-ccnumber"),c=e("#form-cvv"),u=e("#form-zip");if(isValid=l.validate([{value:r.val(),tiperror:r.parent(),rules:{empty:"Credit Card number must not be empty",callback:[l.ccValidation,"Invalid credit card number"]},css:{bottom:5},left:12},{value:c.val(),tiperror:c.parent(),rules:{empty:"Security Code must not be empty",regexp:[/^[0-9]{3,4}$/,"Invalid Security Code"]},css:{bottom:5,left:70}},{value:u.val(),tiperror:u.parent(),rules:{empty:"Zip/Postal Code must not be empty"},css:{bottom:5,left:120}}]),0!=e("#form-expyear").val()&&0!=e("#form-expmonth").val()||(l.error(e("#form-expdate"),"You must select an expiration date",{bottom:3,left:205},!1,20),isValid=!1),isValid){a.hide();var p=s.get("payment_url","#"),m=l.serializeObject(o);m.ajax=1,n.request({url:d.url(p),data:m,$loading:a.parent().find(".loading").css({visibility:"visible"}),success:function(t){a.show(),t.redirect?d.redirect(t.redirect):t.errors?e.each(t.errors,function(e,t){l.error(o.find('input[name="form['+e+']"]').parent("div"),t)}):t.error&&l.error(e("#ccard-submit"),t.error,{bottom:7,left:0},!1,-340)}})}}).on("change","input[data-toggleshow]",function(){var t=e(this).parent().siblings(e(this).data("toggleshow"));t.length&&(this.checked?(t.show(),t.find("input").filter(":first").putCursorAtEnd()):t.hide(),m())}).on("click",".import-new-field",function(t){t.preventDefault(),e(this).before('<input type="text" name="import[exclusions][]" value="">'),e(this).prev("input").putCursorAtEnd(),m()}).on("click","#gathercontent-import",function(t){t.preventDefault(),l.clearAll(p);var i=e(this),a=p.find('input[name="import[gc_username]"]'),o=p.find('input[name="import[gc_api_key]"]'),s=e.trim(a.val()),r=e.trim(o.val()),c=l.validate([{value:s,tiperror:a.parent(),rules:{email:"Incorrect email address"},css:{bottom:5}},{value:r,tiperror:o.parent(),rules:{empty:"Please enter your API Key",callback:[function(e){return/^[a-z0-9\-]{32,64}$/i.test(e)},"Incorrect API Key"]},css:{bottom:5}}]);c&&(i.prop("disabled",!0),n.request("get_gathercontent_projects",{data:{username:s,api_key:r},success:function(t){if(i.prop("disabled",!1),t)if(t.success&&t.projects){e("#importopts").find(".gatherc").removeClass("step1").addClass("step2");var o=e("#form-import-gc-project"),n='<option value="">Select Project to Import</option>';e.each(t.projects,function(e,t){n+='<option value="'+e+'">'+u.charsEncode(t)+"</option>"}),o.html(n),o.selectmenuslickplan("destroy"),o.selectmenuslickplan({style:"popup",maxHeight:300,format:function(e){return u.charsEncode(e)}})}else t.error&&l.error(a.parent(),t.error,{bottom:5})},error:function(){i.prop("disabled",!1)}}))}),t.$body.on("click","#action-onetime-approve",function(e){e.preventDefault(),n.clearAll(),n.request({data:{one_time_crawler_approve:1},success:function(e){e.redirect&&d.redirect(e.redirect)}})}).on("click","#action-onetime-retry",function(e){e.preventDefault(),a("crawler")}),p.filter(".importenabled").parent("div").addClass("ui-modal-export").end().tabs({activate:function(){m()}});var f=s.get("route",[]);!f.length||"string"!==e.type(f[f.length-1])||"onetimecrawler"!==f[f.length-1]&&"onetimexml"!==f[f.length-1]||a(f[f.length-1].replace("onetime","")),t.subscribe("modal/open/modal-export",function(){e("#importopts").find(".gatherc").removeClass("step2").addClass("step1"),e("#form-import-gc-project").val(""),e("#import-tab").find("fieldset").children(".radio").not(".disabled").filter(":first").children("input").prop("checked",!0).trigger("change")})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){var i=t.require("sitemap"),a=e("#sitemap-lines-text-colors"),o=!(t.currentUserCan("sitemap_text_line_color")&&a.length);t.$main.on("click","#action-lines-text-color",function(a){if(a.preventDefault(),o)return t.noPermissions();e("#sitemap-lines-text-colors").siblings("form.show").find("button.reset").trigger("click",[!0]),t.publish("sitemap/color_edit_open",[i.getCurrentSection(),"lines_text"]),i.backupColors();var n=i.getColorSchemeItem("text_color"),s=i.getColorSchemeItem("lines_color");e("#custom-text-color").data("color",n).children("p").css({backgroundColor:n}),e("#custom-lines-color").data("color",s).children("p").css({backgroundColor:s}),i.isMainSection()&&t.$window.scrollTop()>84?e("html, body").stop().animate({scrollTop:84},200,"easeOutCubic",function(){e("#sitemap-lines-text-colors").addClass("show")}):e("#sitemap-lines-text-colors").addClass("show"),i.modified=!1,e("#sitemap-top").addClass("visible")}),o||a.on("click","button.reset",function(a,o){a.preventDefault(),i.revertColors(),e("#sitemap-lines-text-colors").removeClass("show"),i.modified=!1,e("#sitemap-top").removeClass("visible"),o!==!0&&t.publish("sitemap/color_edit_close",[i.getCurrentSection(),"lines_text"])}).on("click","button.submit",function(a){a.preventDefault(),i.backupColors(),e("#sitemap-lines-text-colors").removeClass("show"),i.modified&&(t.publish("sitemap/sitemap_modified",["color_scheme",i.getCurrentSection(),i.getCurrentColorScheme(),{style:i.getStyle(),textShadow:i.getTextShadow()}]),i.modified=!1),e("#sitemap-top").removeClass("visible"),t.publish("sitemap/color_edit_close",[i.getCurrentSection(),"lines_text"])}).on("click","#action-text-color-reset",function(t){t.preventDefault();var a=i.getColorSchemeItem("text_color",!0);e("#custom-text-color").data("color",a).children("p").css({backgroundColor:a}),i.updateTextColor(a),i.modified=!0}).on("click","#action-line-color-reset",function(t){t.preventDefault();var a=i.getColorSchemeItem("lines_color",!0);e("#custom-lines-color").data("color",a).children("p").css({backgroundColor:a}),i.updateLinesColor(a),i.modified=!0})})}),Slickplan.module(function(e,t,i){t.subscribe("route/plainsitemap",function(){function a(){e("#action-orientation").removeClass("vertical horizontal").addClass(d.getTemplate())}function o(i,a,o){d.setCurrentCell(i.get(0)),e(".top-modal").dialog("close");var n={my:"right top",at:"right bottom",of:i,top_offset:-17,left_offset:-4},s=t.$window.scrollTop(),r=e("#topmodal-cell-note").find("form").each(function(){this.reset()}).end();r.dialog("open"),c.position(r.parent(),n,{top:0,left:0}),t.$window.scrollTop(s),a=u.charsDecode(a);var l=e("#topmodal-cell-note");l.css({height:""}).find(".note-text").show().html(a).end().height(e("#topmodal-cell-note .note-text").outerHeight(!0)).parent(".ui-tooltip-modal").css({top:"+=13px",left:"+=10px"}).find(".note-text a").attr("target","_blank"),o&&i.find(".icon-note").length?r.parent().addClass("arrow-second"):r.parent().removeClass("arrow-second"),l.hasClass("tinyscrollbar-enabled")?m.update(l):m.init(l)}var n=t.require("helper");e("html").removeClass("no-js").addClass("js");var s=e("#slickplan-sitemap"),r=0,l=function(){var e=Math.max(0,t.$window.scrollLeft());r!==e&&(r=e,n.addCssRule("#preview-head-fixed","margin-left: "+e+"px"))};if(t.$window.on("load resize",function(){var t=e("#preview-heading").outerHeight()+e("#header-wrapper").outerHeight();e("#preview-head").height(t)}),s.length){var c=t.require("svg"),d=t.require("sitemap"),u=t.require("string"),p=t.require("config"),m=t.require("scrollbar"),f=e("#cell-info-tooltip"),h=window.document.body,g=!1;d.setOptions({container:s[0],edit:!1,preview:!0,allow_collapsing:!0}),_SLICKPLAN_JSON=_SLICKPLAN_JSON&&n.isObject(_SLICKPLAN_JSON)?_SLICKPLAN_JSON:{},s.empty(),d.initSitemap(),t.$window.on("load",function(){d.setJSON(_SLICKPLAN_JSON,!0),d.loadSection(d.getOption("id_main_section")),d.fullRefresh()}).on("debouncedresize",function(i,a){return"object"===e.type(a)&&a.element&&a.position?!1:(t.$window.scrollTo(0,0),void d.fullRefresh())}).on("load scroll resize",function(){l()}),e("div.top-modal").each(function(){var i=e(this),a=i.hasClass("tooltip-modal")?"ui-tooltip-modal"+(i.hasClass("tooltip-modal-left")?" tooltip-modal-left":""):"ui-top-modal";a+=i.hasClass("resizeable")?" sl-resizeable":"",a+=i.hasClass("resizeable-x")?" sl-resizeable-x":"",a+=i.hasClass("resizeable-y")?" sl-resizeable-y":"";var o=i.attr("id");i.dialog({appendTo:document.body,autoOpen:!1,modal:!0,stack:!0,dialogClass:a,show:{effect:"fade",duration:250},hide:{effect:"fade",duration:300},open:function(){i.parent(".ui-dialog").addClass(o),i.parent().css("z-index",3001),e(".ui-widget-overlay:not(.modal-hooked)").attr("class","ui-widget-overlay modal-hooked topmodal-overlay modalid-"+o).css({zIndex:3e3}),t.publish("top_modal/open/"+o,[i])},beforeClose:function(){i.is(":visible")&&(e(".ui-widget-overlay.modalid-"+o).remove(),t.publish("top_modal/before_close/"+o,[i]))},close:function(){t.publish("top_modal/close/"+o,[i])},resizable:i.hasClass("resizeable"),resize:function(){var e=i.children("div").height();i.height(e).parent().height(e)},draggable:!1,width:i.width(),height:i.height(),minWidth:i.width(),maxWidth:Math.max(i.width(),t.getWindowWidth()-100)})}),t.$body.on("click",".ui-widget-overlay",function(){e(".top-modal").dialog("close")}),h.addEventListener("mouseover",function(e){var a=c.getRealTarget(e),o=c.hasClass(a,"bar-section"),n=!o&&c.hasClass(a,"bar-archetype");if(o||n){var s=a.parentNode;if(c.hasClass(s,"cell")){if(o)f.addClass("section").children("span").html(t.__("View Section").replace(" ","&nbsp;"));else{var r=a.href.baseVal.toString().replace("#svg-bar-archetype-",""),l=p.get("archetypes");r="_"===r.charAt(0)&&l[r]!==i&&l[r].name!==i?l[r].name:l._custom!==i&&l._custom[r]!==i&&l._custom[r].name!==i?l._custom[r].name:t.__("Page Type"),r.replace(" ","&nbsp;"),f.removeClass("section").children("span").text(r)}var u=c.hasClass(s,"has-section"),m=c.hasClass(s,"has-archetype"),h=d.getOffsets(s),g=h.top,v=h.left;g+=u&&m||c.hasClass(s,"has-desc")&&c.hasClass(s,"has-url")?h.height-19:h.height/2,n&&u&&m&&(v+=27*h.scale),g-=51,v+=24,f.css({top:g,left:v})}}}),h.addEventListener("mouseout",function(){f.css({left:-99999,top:-99999})}),t.$window.on("click",function(){if(g){var e=d.getSectionElement(i,!0,!0);if(e&&e.group){for(var t=c.getElementsByClassName(e.group,"cellmask"),a=t.length-1;a>=0;--a)c.removeClass(t[a].parentNode,"highlighted"),c.removeElement(t[a]);g=!1}}}),h.addEventListener("click",function(n){n=n||window.event;var s=c.getRealTarget(n);if(s&&s.className&&s.className.baseVal){var r=s.className.baseVal;if(r.indexOf("icon-note")>=0){var l=e(s).closest(".cell");if("object"===e.type(l)&&l instanceof e&&l.length){var f=c.getData(l[0],d.getOption("data_desc"))||"";o(l,f)}}else if(r.indexOf("icon-file")>=0){var l=e(s).closest(".cell");t.publish("sitemap/lightbox_cell_files/open",[l.get(0),i,"images"])}else if(r.indexOf("icon-diagrams")>=0){var l=e(s).closest(".cell");t.publish("sitemap/lightbox_cell_diagrams/open",[l.get(0)])}else if(r.indexOf("icon-content")>=0){var l=e(s).closest(".cell");t.publish("sitemap/lightbox_cell_content/open",[l.get(0)])}else if(r.indexOf("icon-url")>=0){var h=c.getData(e(s).closest(".cell")[0],d.getOption("data_url"));if("string"===e.type(h))window.open(h);else if(h&&e.isArray(h))if(1===h.length&&"internal"===h[0].type&&h[0].page){var v=d.getCellSection(h[0].page),b=d.getCurrentSection();if(v&&b){var _=function(e){if(h[0].page){var t=d.getSectionElement(e);if(t&&t.group){var i=t.group.querySelectorAll(".cell");c.addClass(h[0].page,"highlighted");for(var a=0,o=i.length;o>a;++a)c.use("svg-cell-disabled-mask",{"class":"cellmask non-clickable "+(i[a].id===h[0].page?"enabled":"disabled")},i[a]);setTimeout(function(){g=h[0].page},50)}}};if(v!==b)if(d.isMainSection(v))t.publish("sitemap/lightbox_cell_sections/close",[function(){_(v)}]);else{var y=d.getSectionCell(v);y&&d.openSection(v,y,i,i,i,function(e){a(),_(e)})}else _(b)}}else if(1===h.length&&"external"===h[0].type&&""===h[0].label)h[0].url&&window.open(h[0].url);else{for(var w="",C=0,k=h.length;k>C;++C)if("object"===e.type(h[C])&&h[C].type&&h[C].url&&"external"===h[C].type){var x=h[C].label;x||(x=h[C].url),w+='<li class="cell-url-preview"><a href="'+h[C].url.replace(/"/g,'\\"')+'" target="_blank"><span>'+u.charsEncode(x),w+='</span> <i class="fa fa-external-link"></i>',w+="</a></li>"}if(w){w="<ul>"+w+"</ul>";var l=e(s).closest(".cell");o(l,w,!0)}}}else if(r.indexOf("bar-section")>=0){var l=e(s).closest(".cell");d.setCurrentCell(l[0]),d.openSection(i,l[0]),a()}else if(r.indexOf("bar-archetype")>=0){var l=e(s).closest(".cell"),S=c.getData(l[0],d.getOption("data_archetype"));if(S&&"string"===e.type(S)){var D=p.get("archetypes"),f=!1,q=!1,E=!1;if("_"===S.charAt(0)&&D[S]&&D[S].desc?(f=D[S].desc,f="<p>"+u.charsEncode(f)+"</p>",q=u.charsEncode(D[S].name)):D._custom[S]&&D._custom[S].desc&&(f=D._custom[S].desc,q=u.charsEncode(D._custom[S].name),"fa-"===D._custom[S].icon.substring(0,3)?q='<i class="fa '+D._custom[S].icon+'"></i>'+q:""!==D._custom[S].icon&&1===D._custom[S].icon.length&&(q='<span class="letter">'+u.charsEncode(D._custom[S].icon)+"</span>"+q),E=!0),f&&q){e(".top-modal").dialog("close");var A={my:"left top",at:"left center",of:l,top_offset:20,left_offset:-8},T=e("#topmodal-cell-archetype");if(T.dialog("open"),T.parent().addClass("black-arrow"),c.position(T.parent(),A,{top:0,left:0}),"object"===e.type(l)&&l instanceof e&&l.length){e("#archetype-desc .title > h4").html(q).attr("class","archetype-"+(E?"custom":S));var z=e("#archetype-desc").show().find(".text");z.hasClass("tinyscrollbar-enabled")?(m.updateContent(z,f),m.update(z)):(z.html(f),m.init(z)),z.find("a").attr("target","_blank")}}}}else if(r.indexOf("collapse")>=0){var y=e.trim(r.replace(/(connection|collapse)/g,""));y&&(d.toggleChildren(y,!0,!0,!0),setTimeout(function(){d.fullRefresh()},10))}}}),t.$body.on("click","#archetype-desc .title > a",function(t){t.preventDefault(),e("#topmodal-cell-archetype").dialog("close")}).on("click","#action-orientation",function(t){t.preventDefault();var i=e(this),a=e("#map-dropdown");if(a.is(":visible"))a.hide();else{var o=i.offset(),n=o.left,s=o.top+i.outerHeight()+2,r=i.outerWidth()-22;a.show().css({position:"absolute",width:r,top:s,left:n})}}).on("click","#action-orientation-horizontal, #action-orientation-vertical, #action-orientation-tree",function(i){i.preventDefault(),e("#map-dropdown").hide();var a=this.id.replace("action-orientation-","");c.clearCache(),d.clearCache(),d.changeTemplate(a),setTimeout(function(){t.$window.scrollLeft(0),d.fullRefresh()},10)}),t.subscribe("top_modal/open/topmodal-cell-note",function(e,a){var o=t.require("sitemap"),n=t.require("svg"),s=o.getCurrentCell(),r=n.getData(s,o.getOption("data_desc_width"));r!==i&&(r=parseInt(r,10))>283||(r=283),a.dialog("option","width",r),a.parent().removeClass("arrow-second arrow-first-offset"),s&&n.hasClass(s,"has-url")&&a.parent().addClass("arrow-first-offset")})}else{var v=e("#diagram-wrapper");if(v.length&&_SLICKPLAN_DIAGRAM&&n.isObject(_SLICKPLAN_DIAGRAM)){var b=t.require("diagrams");b.init(v.find("#diagram-paper").empty().get(0)),b.load(_SLICKPLAN_DIAGRAM,"svgdiagram"),t.$window.on("debouncedresize",function(){t.$window.scrollTo(0,0),b.refreshContainerSize()}).on("load scroll resize",function(){l()})}}})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap route/plainsitemap",function(a){function o(e,t){var i=s.getSectionElement(e,!0,!0);i&&i.cells?t({section:i}):t()}var n,s=t.require("sitemap"),r=t.require("string"),l=t.require("svg"),c=t.require("helper"),d=t.require("ajax"),u=t.require("form"),p=e("#lightbox-cell-sections"),m=p.find(".tabs"),f=e("#section-svg-wrapper"),h=e("#slickplan-sitemap"),g=e("#modal-section-menu"),v=h.data("id")||0,b=s.getOption("id_main_section"),_="route/plainsitemap"===a.type,y=!1,w=!1;p.on("click",".circle.reset",function(e){e.preventDefault(),t.publish("sitemap/lightbox_cell_sections/close",[p])}),m.on("click",".tab",function(){var t=e(this),i=t.data("section");s.isMainSection(i)?p.find(".circle.reset").trigger("click"):s.openSection(i,t.data("cell"))}),e("#toolbar-menu-sections").on("click","ul a",function(t){t.preventDefault();var i=e(this);s.openSection(i.data("section"),i.data("cell"))}),t.subscribe("sitemap/lightbox-cell-sections/tab_edit",function(e,i){var a=i.data("section");a&&c.confirmDialog({title:"Section Name",text:!1,on_yes:function(e,o,n){var r=n.val();r?(s.setSectionName(a,r),i.text(r),e.dialog("close"),t.publish("sitemap/lightbox/tabs_scrollable",[m])):u.error(n.parent(),"Enter section name",{bottom:26})},close:!0,no_label:"Cancel",yes_label:"Save Changes",keep_open:!0,input:!0,input_text:s.getSectionName(a)})}),g.length&&(g.on("submit","form",function(a){a.preventDefault();var o=g.hasClass("remove-section")?"remove":"add";g.dialog("close");var n=e(this);if("add"===o){var r,c=n.find('input[type="radio"][name="type"]:checked').val(),u=n.find("#section-menu-name").val(),p=s.getCurrentCell(i,!0);switch(c){case"empty":case"move":y=b;var m=n.find("#section-menu-copystyling").is(":checked"),f=m?s.getCurrentColorScheme():i;r=l.generateUniqueId(),s.addCellSection(p,r,!0,!1),s.openSection(r,p,"move"===c,u,f);break;case"link":if(r=n.find("#section-menu-dropdown").val()){var h="link:"+r;l.setData(p,s.getOption("data_section"),h),s.openSection(h),s.addCellSection(p,h,!0,!1)}break;case"clone":var _=n.find("#section-menu-dropdown").val();if(_){y=b,r=l.generateUniqueId();var w=s.getSerialized(!0,_);if(w&&w.cells){s.addCellSection(p,r,!0,!1),s.cloneReset();var C={options:e.extend({},w.options),cells:[],data:{section:r,name:u,parent:p}},k={};k[s.getOption("data_url")]=n.find("#section-menu-includelinks").is(":checked"),k[s.getOption("data_desc")]=n.find("#section-menu-includenotes").is(":checked"),k[s.getOption("data_archetype")]=n.find("#section-menu-includearchetypes").is(":checked"),k[s.getOption("data_color")]=1,k[s.getOption("data_text_color")]=1,k[s.getOption("data_section")]=n.find("#section-menu-includesections").is(":checked"),k[s.getOption("data_content")]=n.find("#section-menu-includecontents").is(":checked"),k[s.getOption("data_file")]=n.find("#section-menu-includefiles").is(":checked"),l.forEach(w.cells,function(e,t){if(t&&t.id&&t.level&&("util"===t.level||"foot"===t.level||"1"===t.level||1===t.level))for(var i=s.cloneCell(t.id,k,1),a=0,o=i.length;o>a;++a)C.cells.push(i[a])});var x=s.cloneGetResults();x.length?d.request("clone_cell_datas",{data:{sitemap_id:v,datas:x},success:function(){s.addToJSON(r,C),s.openSection(r,p,!1,u)}}):(s.addToJSON(r,C),s.openSection(r,p,!1,u))}}}}else{var S=n.find("#section-menu-move-back").is(":checked"),p=s.getCurrentCell();s.removeCellSection(p,!0,S),s.fullRefresh(),t.publish("sitemap/sitemap_modified",["section_removed",s.getCurrentSection()])}}).on("change",'input[type="radio"][name="type"]',function(){var t=g.find(".inputs-group").hide().filter(".show-"+this.value).show();t.length?(g.find(".options").insertAfter(e(this).closest(".radio")).show(),t.each(function(){var t=e(this).find("#section-menu-dropdown");t.length&&(t.selectmenuslickplan("destroy"),t.selectmenuslickplan({style:"popup",maxHeight:400,format:function(e){return r.charsEncode(e)}}))})):g.find(".options").hide()}),t.subscribe("modal/open/modal-section-menu",function(t,i){if(i.hasClass("add-section")){var a=s.getListOfSections(),o="";e.each(a,function(t,i){s.isMainSection(t)||"undefined"===e.type(i)||(o+='<option value="'+t+'">'+r.charsEncode(i)+"</option>")}),i.find("#section-menu-dropdown").html(o),i.find("#section-menu-empty").prop("checked",!0).trigger("change");var n=s.getCurrentCell(),c=l.getData(n,s.getOption("data_text"));i.find("#section-menu-name").val(c)}})),t.$window.on("resize",function(){p.is(":visible")&&t.publish("sitemap/lightbox/tabs_scrollable",[m])}),t.subscribe("sitemap/lightbox_cell_sections/open",function(i,a,d,u,h,g,v,C){if(n=a&&a.id?a.id:a){var k=s.getColorSchemeItem(n),x=p.hasClass("show"),S=f.find(".sitemap-section");S.length&&s.removeSectionDOM(S.get(0).id,!0),b=d,s.setCurrentSection(d),x||m.find(".wrapper .tab").remove(),t.$body.addClass("section-view-before"),c.openLighboxModal(p,n,function(){w=!s.isMainSection(b),o(d,function(i){var a={cells:[]},o=s.getOptions(),c=s.getCellData(n,!0),u=!1,f={id:l.generateUniqueId()};if(f[o.data_level]="home",c[o.data_text]&&(f[o.data_text]=c[o.data_text]),c[o.data_color]?f[o.data_color]=c[o.data_color]:k&&(f[o.data_color]=k),c[o.data_text_color]&&(f[o.data_text_color]=c[o.data_text_color]),c[o.data_desc]&&(f[o.data_desc]=c[o.data_desc]),c[o.data_desc_width]&&(f[o.data_desc_width]=c[o.data_desc_width]),c[o.data_url]&&(f[o.data_url]=c[o.data_url]),c[o.data_archetype]&&(f[o.data_archetype]=c[o.data_archetype]),i&&i.section&&i.section.cells){a=i.section;for(var w=0,S=a.cells.length;S>w;++w)if("home"===a.cells[w].level){a.cells[w]=f,u=!0;break}}var D={parent:n};if(v&&(D.color_scheme=v),u||a.cells.push(f),a=s.getSectionStructure(D,g,a.cells,d),s.setSectionOption(d,"parent",n),s.addToJSON(d,a),!_&&h&&s.moveSubpagesToSection(d,n),s.loadSectionJSON(d),y&&(t.publish("sitemap/sitemap_modified",["section_added",y,b]),y=!1),x){var q=m.find(".tab-"+d+"-"+n);if(q.length)q.addClass("current").siblings(".current").removeClass("current");else{var E='<div class="tab current tab-'+d+" tab-"+d+"-"+n+'" data-section="'+d+'" data-cell="'+n+'">'+r.charsEncode(s.getSectionName(d))+"</div>";m.find(".wrapper").find(".tab.current").removeClass("current").nextAll(".tab").remove(),m.find(".wrapper").append(E)}}else m.find(".wrapper").html(s.createBreadcrumbs(d,n));t.publish("sitemap/lightbox/tabs_scrollable",[m]);var A=s.getListOfSections(),T="";e.each(A,function(t,i){s.isMainSection(t)||"undefined"===e.type(i)||(T+='<li><a href="#" class="text" data-section="'+t+'" data-cell="'+s.getSectionCell(t)+'">'+r.charsEncode(i)+"</a></li>")}),T&&e("#toolbar-menu-sections").show().children("ul").html(T),t.$body.addClass("section-view"),"function"===e.type(C)&&C(d,p)})})}}),t.subscribe("sitemap/lightbox_cell_sections/close",function(i,a){t.$body.removeClass("section-view-before section-view"),t.publish("sitemap/section_before_close",[b]),c.closeLighboxModal(p,n,function(){s.setCurrentSection(),s.fullRefresh(),t.publish("sitemap/section_closed",[b]),e("#toolbar-menu-sections").hide(),"function"===e.type(a)&&a(b,p)})}),t.subscribe("sitemap/cell_data_removed/section",function(e,t,i){if(!s.isEditBlocked()&&!s.isMainSection(i)&&(s.removeSection(i),p.hasClass("show"))){var a=m.find(".tab-"+i);a.length&&(a.remove(),a=m.find(".tab").not(".main").filter(":first"),a.length||(a=m.find(".tab.main")),a.trigger("click"))}}),t.subscribe("sitemap/container_refreshed",function(){w&&(w=!1,e("#section-svg-wrapper").scrollTo(0,0))})})}),Slickplan.module(function(e,t,i){var a=!(t.currentUserCan("sitemap_shadows_gradients")&&e("#sitemap-shadows-gradients").length);t.subscribe("route/sitemap",function(){var i=t.require("sitemap"),o=e("#sitemap-shadows-gradients"),n=null,s=null;t.$main.on("click","#action-shadows-gradients",function(r){return r.preventDefault(),a?t.noPermissions():(t.publish("sitemap/color_edit_open",[i.getCurrentSection(),"shadows_gradients"]),o.siblings("form.show").find("button.reset").trigger("click",[!0]),i.isMainSection()&&t.$window.scrollTop()>84?e("html, body").stop().animate({scrollTop:84},200,"easeOutCubic",function(){o[0].classList.add("show")}):o[0].classList.add("show"),n=i.getStyle(),s=i.getTextShadow(),e("#form-cell-gradient").prop("checked","gradient"===n),e("#form-text-shadow").prop("checked",s),i.modified=!1,void e("#sitemap-top").addClass("visible"))}),o.on("click","button.reset",function(a,r){a.preventDefault(),n&&i.changeStyle(n),s&&i.setTextShadow(s),o[0].classList.remove("show"),i.modified=!1,e("#sitemap-top").removeClass("visible"),r!==!0&&t.publish("sitemap/color_edit_close",[i.getCurrentSection(),"shadows_gradients"])}).on("click","button.submit",function(a){a.preventDefault(),i.changeStyle(i.getStyle()),i.setTextShadow(i.getTextShadow()),o[0].classList.remove("show"),i.modified&&(t.publish("sitemap/sitemap_modified",["color_scheme",i.getCurrentSection(),i.getCurrentColorScheme(),{style:i.getStyle(),textShadow:i.getTextShadow()}]),i.modified=!1),e("#sitemap-top").removeClass("visible"),
    t.publish("sitemap/color_edit_close",[i.getCurrentSection(),"shadows_gradients"])}).on("change","#form-cell-gradient",function(e){this.checked?i.changeStyle("gradient"):i.changeStyle("flat"),i.modified=!0}).on("change","#form-text-shadow",function(e){this.checked?i.setTextShadow(!0):i.setTextShadow(!1),i.modified=!0})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){var a=t.require("sitemap"),o=t.require("svg"),n=!1;e(document).on("keydown.shift_return",function(e){if(n||a.isEditBlocked())return!0;e.preventDefault();var t=a.getCurrentCell(),s={},r=i;t&&(s.after=o.getAttr(t,"id"),r=o.getData(t,a.getOption("data_level")),"util"!==r&&"foot"!==r&&(r=i)),a.insertNewCell(s,r)}).on("keydown.ctrl_return keydown.meta_return",function(e){if(n||a.isEditBlocked())return!0;e.preventDefault();var t=a.getCurrentCell(),s={},r=i;t&&(r=o.getData(t,a.getOption("data_level")),"util"!==r&&"foot"!==r?(s.parent=o.getAttr(t,"id"),r=i):s.after=o.getAttr(t,"id")),a.insertNewCell(s,r)}).on("keydown.ctrl_e keydown.meta_e",function(e){return n||a.isEditBlocked()?!0:(e.preventDefault(),void a.insertNewCell({},1))}).on("keydown.ctrl_z keydown.meta_z",function(t){return n||a.isEditBlocked()?!0:(t.preventDefault(),void e("#action-undo").trigger("click"))}).on("keydown.ctrl_y keydown.meta_y",function(t){return n||a.isEditBlocked()?!0:(t.preventDefault(),void e("#action-redo").trigger("click"))}).on("keydown.ctrl_+ keydown.meta_+ keydown.ctrl_plus keydown.meta_plus",function(t){return n?!0:(t.preventDefault(),t.stopPropagation(),void e("#action-zoom-in").trigger("click"))}).on("keydown.ctrl_- keydown.meta_- keydown.ctrl_minus keydown.meta_minus",function(t){return n?!0:(t.preventDefault(),t.stopPropagation(),void e("#action-zoom-out").trigger("click"))}).on("keydown.ctrl_0 keydown.meta_0",function(e){return n?!0:(e.preventDefault(),e.stopPropagation(),void a.zoomReset())}).on("keydown.del keydown.backspace",function(t){return"lightbox-cell-diagrams"!==n||e("#diagram-text-field").is(":focus")?!0:(t.preventDefault(),t.stopPropagation(),e("#drawing-tools").find(".selection").children("div").filter(":visible").children("button.delete").trigger("click"),!1)}),t.subscribe("sitemap/lightbox_dark/open top_modal/open/topmodal-cell-url top_modal/open/topmodal-cell-note",function(e,t){n=t&&t.length?t.attr("id"):!0}),t.subscribe("sitemap/lightbox_dark/close top_modal/close/topmodal-cell-url top_modal/close/topmodal-cell-note",function(){n=!1})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){var i,a=t.require("sitemap"),o=e("#sitemap-color"),n=!(t.currentUserCan("sitemap_swatch_presets")&&o.length);t.$main.on("click","#action-swatch-presets",function(s){return s.preventDefault(),n?t.noPermissions():(o.siblings("form.show").find("button.reset").trigger("click",[!0]),t.publish("sitemap/color_edit_open",[a.getCurrentSection(),"swatch_presets"]),a.backupColors(),i=a.getCurrentColorScheme(),a.isMainSection()&&t.$window.scrollTop()>84?e("html, body").stop().animate({scrollTop:84},200,"easeOutCubic",function(){o[0].classList.add("show")}):o[0].classList.add("show"),a.modified=!1,void e("#sitemap-top").addClass("visible"))}),n||(o.on("click","li.color",function(){var t=document.getElementById("level").value;"all"===t?i={default_color:e(this).data("color"),text_color:i.text_color,lines_color:i.lines_color}:i[t]=e(this).data("color"),a.setTempScheme(i),a.modified=!0}).on("click","button.reset",function(i,n){i.preventDefault(),a.revertColors(),o[0].classList.remove("show"),a.modified=!1,e("#sitemap-top").removeClass("visible"),n!==!0&&t.publish("sitemap/color_edit_close",[a.getCurrentSection(),"swatch_presets"])}).on("click","button.submit",function(n){n.preventDefault(),a.backupColors(),o[0].classList.remove("show"),a.modified&&(t.publish("sitemap/sitemap_modified",["color_scheme",a.getCurrentSection(),i,{style:a.getStyle(),textShadow:a.getTextShadow()}]),a.modified=!1),e("#sitemap-top").removeClass("visible"),t.publish("sitemap/color_edit_close",[a.getCurrentSection(),"swatch_presets"])}),t.$body.on("mouseenter","#level-menu li",function(t){var i=e("#level option:eq("+e(this).data("index")+")").val();a.highlightLevel(i)}).on("mouseleave","#level-menu li",function(e){a.highlightLevel(!1)}))}),t.subscribe("sitemap/after_load",function(){function a(){if(!l){l=!0;var a='<option value="all" selected>'+t.__("Level")+'</option><option value="all">'+t.__("All")+"</option>",s=!1,u=!1,p=!1,m=0,f={},h=[],g=o.getSectionElement();if(g&&g.group)for(var v=g.group.querySelectorAll("svg.cell"),b=0;b<v.length;++b){var _=n.getElement(v[b]),y=n.getData(_,o.getOption("data_level"));"util"===y?s=!0:"foot"===y?u=!0:"home"===y?p=!0:y&&(y=parseInt(y,10),y&&!isNaN(y)&&(m=Math.max(m,y)));var w=n.getData(_,o.getOption("data_archetype"));w&&"string"===e.type(w)&&("_"===w.charAt(0)&&r.isObject(c[w])?f[w]===i&&(f[w]=1,h.push({key:w,val:c[w].name})):r.isObject(c._custom[w])&&f[w]===i&&(f[w]=1,h.push({key:w,val:c._custom[w].name})))}s&&(a+='<option value="util">'+t.__("Utilities")+"</option>"),u&&(a+='<option value="foot">'+t.__("Footer")+"</option>"),p&&(a+='<option value="home">'+t.__("Home")+"</option>");for(var b=1;m>=b;++b)a+='<option value="level'+b+'">'+(20>=b?d[b-1]:b)+" "+t.__("Level")+"</option>";h=h.sort(function(e,t){return e.val.localeCompare(t.val)});for(var b=0;b<h.length;++b)a+='<option value="archetype-'+h[b].key+'">'+h[b].val+"</option>";var C=e("#level, #level-custom").html(a);C.selectmenuslickplan("destroy"),C.selectmenuslickplan({style:"popup",format:function(e){return t.require("string").charsEncode(e)}}),setInterval(function(){l=!1},200)}}if(t.currentUserCan("sitemap_swatch_presets")&&e("#sitemap-color").length||t.currentUserCan("sitemap_custom_color")&&e("#sitemap-custom").length){var o=t.require("sitemap");if(o.crawler)return!1;var n=t.require("svg"),s=t.require("config"),r=t.require("helper"),l=!1,c=s.get("archetypes"),d=[t.__("First"),t.__("Second"),t.__("Third"),t.__("Fourth"),t.__("Fifth"),t.__("Sixth"),t.__("Seventh"),t.__("Eighth"),t.__("Ninth"),t.__("Tenth"),t.__("Eleventh"),t.__("Twelfth"),t.__("Thirteenth"),t.__("Fourteenth"),t.__("Fifteenth"),t.__("Sixteenth"),t.__("Seventeenth"),t.__("Eighteenth"),t.__("Nineteenth"),t.__("Twentieth")];a(),t.subscribe("sitemap/cell_data_added/archetype sitemap/cell_data_removed/archetype sitemap/custom_archetype_saved sitemap/section_opened sitemap/section_closed sitemap/sitemap_modified sitemap/sitemap_modified_via_websocket",a)}})}),Slickplan.module(function(e,t,i){t.subscribe("modal/open/modal-sitemap-logo",function(i,a){var o=t.require("config"),n=e("#sitemap-logo .sitemap-logo");a.find("#form-logo-client-name").val(e("#text-logo .text").text());var s=o.get("statics_path")+"img/default-logo.png",r=e("#image-form-newlogo").attr("src");r&&(s=r),a.find("#image-form-companylogo").attr("src",s),n.hasClass("visible")&&n.hasClass("textlogo")?a.find("#form-uselogo1").prop("checked",!0).trigger("change"):a.find("#form-uselogo2").prop("checked",!0).trigger("change")}),t.subscribe("route/sitemap",function(){var a=t.require("form"),o=t.require("websocket"),n=t.require("sitemap"),s=e("#sitemap-logo"),r=e("#modal-sitemap-logo");s.on("click",".delete",function(a){return a.preventDefault(),n.isEditBlocked(i,"sitemap")?!1:void o.request({data:{deletelogo:1},success:function(){t.publish("sitemap/logo_changed",[""]),s.find(".sitemap-logo").removeClass("visible textlogo"),s.find(".loading-logo").hide(),e("#text-logo .text").text("")}})}),r.on("change",'input[name="sitemap_logo[type]"]',function(){var i=e(this).val(),a=r.find(".uploadbutton.dynamic");if("text"===i)r.find(".logoplace, .upload").hide(),r.find(".logoplacetext").show(),a.length&&t.publish("upload/dynamic_uploader/destroy",[a.attr("id")]);else if(r.find(".logoplace, .upload").show(),r.find(".logoplacetext").hide(),a.length){var o=a.attr("id");t.publish("upload/dynamic_uploader/init",[a.get(0),o,o])}}).on("submit","form",function(n){n.preventDefault();var l=e(this);a.clearErrors(l);var c=l.find('input[name="sitemap_logo[type]"]:checked').val();if("text"===c){var d=l.find("#form-logo-client-name").val();if(""===d||d===i)a.error(l.find("#form-logo-client-name").parent(),t.__("Enter client name"),{bottom:3});else{d=d.replace(/(\w{25})(\w)/g,"$1 $2");var u=a.serializeObject(l);u.sitemap_logo.text=d,o.request({data:u,success:function(i){i.success&&(t.publish("sitemap/logo_changed",[""]),s.find(".sitemap-logo").addClass("visible textlogo"),s.find(".loading-logo").hide(),e("#text-logo .text").text(d),r.dialog("close"))}})}}else{var p=e("#image-form-companylogo").attr("src");/default-logo\.png$/.test(p)||(s.find(".loading-logo").hide().end().find(".add-logo").hide().end().find(".sitemap-logo").addClass("visible").removeClass("textlogo").show().find("img").attr("src",p),t.publish("sitemap/logo_changed",[p])),r.dialog("close")}}),t.subscribe("upload/files_added_pluploadbtndroplogo",function(e,t){a.clearErrors(r.find("form")),t.start()}),t.subscribe("upload/file_uploaded_pluploadbtndroplogo",function(t,i,a,o){o.success&&o.file_path&&e("#image-form-companylogo").attr("src",o.file_path),i.refresh()}),t.subscribe("upload/error_pluploadbtndroplogo",function(e,t,i){a.error(r.find(".upload"),i.message,{bottom:30}),t.refresh()})})}),Slickplan.module(function(e,t,i){t.subscribe("route/sitemap",function(){function a(){f.request({data:{crawler:1,url_index:F},success:function(t){if(t.status&&(/^[0-9]+%$/.test(t.status)||(t.status="<span>"+t.status+"</span>"),e("#crawlerpage").find("h2").html(t.status)),"undefined"!==e.type(t.url_index)&&(F=parseInt(t.url_index,10)),t.urls&&e.isArray(t.urls)&&t.urls.length){var i=e("#crawler-urls-textarea");i.length&&i.show().val(e.trim(i.val())+"\n"+t.urls.join("\n")).scrollTop(9999999)}t.redirect?(clearTimeout(M),h.redirect(t.redirect),e("#crawler-cancel").hide(),e("#crawler-stopsave").hide(),e("#crawlerpage").find("h2").html("<span>building sitemap</span>")):M=setTimeout(a,2e3)},error:function(){M=setTimeout(a,2e3)}})}function o(a,o){var n=w.getRealTarget(a);if(n){var s=w.hasClass(n,"bar-section"),r=!s&&w.hasClass(n,"bar-archetype");if(s||r){var l=n.parentNode;if(w.hasClass(l,"cell")){if(s)B.addClass("section").children("span").html(t.__("View Section").replace(" ","&nbsp;"));else{var c=n.href.baseVal.toString().replace("#svg-bar-archetype-",""),d=b.get("archetypes");c="_"===c.charAt(0)&&d[c]!==i&&d[c].name!==i?d[c].name:d._custom!==i&&d._custom[c]!==i&&d._custom[c].name!==i?d._custom[c].name:t.__("Page Type"),c.replace(" ","&nbsp;"),B.removeClass("section").children("span").text(c)}var u=w.hasClass(l,"has-section"),p=w.hasClass(l,"has-archetype"),m=C.getOffsets(l),f=m.top,h=m.left;f+=u&&p||w.hasClass(l,"has-desc")&&w.hasClass(l,"has-url")?m.height-19*m.scale:m.height/2,r&&u&&p&&(h+=27*m.scale),o="number"===e.type(o)?o:0,f-=51*m.scale,h+=(41+o)*m.scale,B.css({top:f,left:h,transform:"scale("+m.scale+")"})}}}}function n(a,o,n){if(a&&!K&&!t.$body.children(".ui-widget-overlay").filter(":visible").length){a=w.getElement(a);var s=w.getElement(a,!0);if(a&&a.id&&!s.closest(".sitemap-wrapper-area").hasClass("dragging")){var r=a.getElementById("bar-icons-wrapper-"+a.id),l=a.getElementById("bar-icons-wrapper-left-"+a.id),c=a.getElementById("bar-icons-wrapper-right-"+a.id);if(r||l||c){var d=a.getElementById("bar-section-"+a.id),u=w.getData(a,"section"),p="string"===e.type(u)&&"link"===u.split(":")[0],m=a.getElementById("bar-archetype-"+a.id),f=m&&d?54:m||d?27:0;d&&p&&(f+=3);var h=w.getFloat(a,"width",!0),g=!!r;G[a.id]={timeout:!1,is_changed:!1,is_changed_recalculated:!1,start_time:(new Date).getTime(),current_time:0,percent:0,duration:120};var v=18;if(n)return Y[a.id]&&(clearInterval(Y[a.id]),Y[a.id]=i),w.setMatrix(l,o?[1,0,0,1,0,0]:[1,0,0,1,v,0]),w.setMatrix(c,o?[1,0,0,1,0,0]:[1,0,0,1,-v,0]),g&&w.setAttr(r,"width",o?h-8-f:h-8-f-2*v,!0),G[a.id]=i,!0;Y[a.id]&&clearInterval(Y[a.id]),Y[a.id]=setInterval(function(){if(G&&G[a.id]){if(G[a.id].current_time=(new Date).getTime()-G[a.id].start_time,G[a.id].is_changed&&!G[a.id].is_changed_recalculated){var e=G[a.id].duration*G[a.id].percent;G[a.id].start_time-=G[a.id].duration-e-e,G[a.id].current_time=(new Date).getTime()-G[a.id].start_time,G[a.id].is_changed_recalculated=!0}if(G[a.id].current_time<G[a.id].duration){G[a.id].percent=G[a.id].current_time/G[a.id].duration;var t=o?1-G[a.id].percent:G[a.id].percent,n=v*t;w.setMatrix(l,[1,0,0,1,n,0]),w.setMatrix(c,[1,0,0,1,-n,0]),g&&w.setAttr(r,"width",h-8-f-2*v*t,!0)}else w.setMatrix(l,o?[1,0,0,1,0,0]:[1,0,0,1,v,0]),w.setMatrix(c,o?[1,0,0,1,0,0]:[1,0,0,1,-v,0]),g&&w.setAttr(r,"width",o?h-8-f:h-8-f-2*v,!0),Y[a.id]&&(clearInterval(Y[a.id]),Y[a.id]=i),G[a.id]=i}},13)}}}}function s(e,t){if(!w.hasClass(e,"block-edit")){var i=C.getCurrentSection();V[i]||(V[i]={}),V[i][e.id]||(V[i][e.id]=e,n(e,!1,t))}}function r(e,t,a){if(a||(a=C.getCurrentSection()),V&&V[a])for(var o in V[a])!V[a].hasOwnProperty(o)||!V[a][o]||e&&V[a][o].id===e.id||(V[a][o]=i,delete V[a][o],n(o,!0,t))}function l(i,a,o){"function"===e.type(o)&&o(),i.success&&(i.last_saved&&e("#lastsaved").html(i.last_saved),t.has_unsaved_changes.sitemap=!1,t.publish("sitemap/saved",[i]),C.refreshPageCount()),i.error&&g.error(i.error),a!==!0&&(i.success?g.success(t.__("Sitemap saved")):i.redirect&&h.redirect(i.redirect))}function c(e,t,i,a){f.request({data:{partial_save:e,action_type:a,current_section:C.getCurrentSection()},success:function(e){l(e,t,i)}})}function d(e,i,a){N&&N.abort();var o={sitemap:C.getSerialized(!0),action_type:"string"==typeof a?a:"",current_section:C.getCurrentSection()};o=t.applyFilters("sitemap_save_data",o),N=f.request({data:o,success:function(t){l(t,e,i)}})}function u(t,i,a){e(".top-modal").dialog("close");var o=C.getScrollWrapper(t),n={my:"right top",at:"right center",of:t},s=o.scrollTop(),r=e("#topmodal-cell-note.top-modal").parent().end();if(r.find("form").each(function(){this.reset()}).end().dialog("open"),w.position(r.parent(),n,{top:0,left:0}),o.scrollTop(s),"object"===e.type(t)&&t.length){i=_.charsDecode(i);var l=e("#topmodal-cell-note");l.css({height:""}).find(".note-text").show().html(i).end().height(e("#topmodal-cell-note .note-text").outerHeight(!0)).parent(".ui-tooltip-modal").css({top:"+=13px",left:"+=10px"}).find(".note-text a").attr("target","_blank"),a&&t.find(".icon-note").length?r.parent().addClass("arrow-second"):r.parent().removeClass("arrow-second"),l.hasClass("tinyscrollbar-enabled")?y.update(l):y.init(l)}}var p,m=t.require("form"),f=t.require("websocket"),h=t.require("http"),g=t.require("notification"),v=t.require("helper"),b=t.require("config"),_=t.require("string"),y=t.require("scrollbar"),w=t.require("svg"),C=t.require("sitemap"),k=window.document,x=e("#slickplan-sitemap"),S=x.data("id")||0,D=e("#sitemap-top"),q=e("#sitemap-comments"),E=e("#map-dropdown"),A=e("#sitemap-menu"),T=e("#sitemap-wrapper"),z=b.get("allow_edit",!1),$=b.get("all_privileges",!1),L="undefined"!==e.type(window.SVGElementInstance),O=!1,I=!1,j=!!T.data("locked"),P=!!T.data("approved"),N=null,U=0===parseInt(t.currentUserCan("contributors",!0),10)||0===parseInt(b.get("account",{active_contributors:0}).active_contributors,10),R=k.getElementById("crawlerpage");if(R){if(z){var M,F=-1;a(),C.crawler=!0,e("#crawler-cancel").on("click",function(t){t.preventDefault(),clearTimeout(M),e("#crawler-cancel").hide(),e("#crawler-stopsave").hide(),f.request({data:{crawler:1,cancel:1},success:function(e){e.success&&h.refresh()}})}),e("#crawler-stopsave").on("click",function(t){t.preventDefault(),clearTimeout(M),e("#crawler-cancel").hide(),e("#crawler-stopsave").hide(),e("#crawlerpage").find("h2").html("<span>building sitemap</span>"),f.request({data:{crawler:1,stop_save:1},success:function(e){e.success&&h.refresh()}})})}else k.getElementById("crawler-cancel").style.display="none",k.getElementById("crawler-stopsave").style.display="none";return!1}v.warnBeforeLeave(),C.setOptions({container:x[0],edit:z,allow_collapsing:!0}),_SLICKPLAN_JSON=_SLICKPLAN_JSON&&v.isObject(_SLICKPLAN_JSON)?_SLICKPLAN_JSON:{},x.empty(),C.initSitemap(),z||(t.$body.addClass("sitemappreview"),C.setOption("edit",!1)),(j||P)&&(C.setOption("preview",!0),C.setOption("autosave",!1)),t.$window.on("load",function(){if(!O){O=!0;var i=C.getOption("id_main_section");v.isObject(_SLICKPLAN_JSON)&&C.setJSON(_SLICKPLAN_JSON,!0),C.loadSection(i),C.fullRefresh();var a=e("#"+i+" svg.cell.level-home");a.length||(a=e("#"+i+" svg.cell").filter(":first"),a.length&&C.setCurrentCell(a[0]))}t.publish("sitemap/after_load")});var B=e("#cell-info-tooltip");if(z){D.find("h1 > span").on("dblclick",function(){e(this).siblings("a").trigger("click")}),t.$body.on("click",".sitemap-wrapper-area .add-button",function(){return C.isEditBlocked()||t.$body.hasClass("expanded-batch")?!1:(w.hasClass(this,"add-button-cell")?C.insertNewCell():w.hasClass(this,"add-button-home")?C.insertNewCell(null,"home"):w.hasClass(this,"add-button-util")?C.insertNewCell(null,"util"):w.hasClass(this,"add-button-foot")&&C.insertNewCell(null,"foot"),void e(this).remove())}),t.$body.on("blur keydown.return keydown.shift_return keydown.ctrl_return keydown.meta_return keydown.alt_return","#svg-text-edit",function(t){var a=w.getData(this,C.getOption("data_cell_ref"));a=w.getElement(a);var o=C.getCellLevel(a);if(a&&"number"===e.type(o)){var n=C.getAllParents(a);a=n.length?n[n.length-1]:a,a=w.getElement(a)}var s=C.finishTextEdit(i,!b.get("cells_numbering",!1));s?C.cellEditGroupStop(function(){e("#batch-cell-names").val(s).trigger("blur")}):"util"!==o&&C.maybePartialRefresh(a,!1),"util"===o&&C.fullRefresh(),"keydown"===t.type&&t.preventDefault()}).on("keyup","#svg-text-edit",function(){C.autosizeTextEdit()}),k.body.addEventListener("dblclick",function(t){var i=w.getRealTarget(t);if(i&&w.hasClass(i,"foreground")){var a=e(i).closest("svg.cell");a.length&&(C.setCurrentCell(a[0]),E.find(".dblclick").trigger("click"))}});var W=!1;t.$body.on("mousemove",".sitemap-wrapper-area",function(e){W&&C.dndMove(e),C.calculateCellHoverHelpers(e,W)}).on("mousedown",".sitemap-wrapper-area .action.move",function(e){e.preventDefault(),C.dndStart(e,this.parentNode),W=!0}).on("mouseup",".sitemap-wrapper-area",function(e){W&&(C.dndStop(e),W=!1)});var H=t.$main.find(".top-nav");t.$window.scroll(function(){t.$window.scrollTop()>H.offset().top?H.addClass("floating"):H.removeClass("floating")});var K=!1,G={},Y={},V={};t.subscribe("sitemap/dropdown_open sitemap/fast_edit_sidebar/open",function(){K=!0}),t.subscribe("sitemap/dropdown_before_open",function(e,t,i){var a=C.getBlockedCell(w.getAttr(i,"id"));if(a){var o=".delete, .cellclone";a["lightbox-cell-content"]&&(o+=", .xcellcontent"),a["lightbox-cell-diagrams"]&&(o+=", .xcelldiagrams"),a["lightbox-cell-files"]&&(o+=", .xcellfile"),t.find(o).addClass("disabled-ws")}}),t.subscribe("sitemap/dropdown_close sitemap/fast_edit_sidebar/close",function(){K=e("#sitemap-fast-edit-overlay").is(":visible")}),t.subscribe("sitemap/dropdown_close",function(e,t){C.last_mouse_event=t;var i=C.getCellByCoords(t),a=C.getCurrentCell();i&&i.id===a.id||(n(a,!0),i&&i.id&&n(i))}),t.subscribe("sitemap/full_refresh",function(e,t,a){if(r(i,!0,a),V[a]={},!C.isEditBlocked()&&C.last_mouse_event){var o=C.getCellByCoords(C.last_mouse_event);o&&s(o,!0)}});var J=!1;t.subscribe("sitemap/drag_stop",function(e,t,i,a){if(C.isEditBlocked())return!1;if(a&&a.cell){var o=C.getCursorPoint(t,!0),s=w.getFloat(a.cell,"x"),r=w.getFloat(a.cell,"y"),l=w.getFloat(a.cell,"width"),c=w.getFloat(a.cell,"height"),d=!(o.x>=s&&o.x<=s+l&&o.y>=r&&o.y<=r+c);J=!d,n(a.cell,d,!0)}}),k.body.addEventListener("mouseover",function(e){if(C.isEditBlocked())return!1;if(J)return void(J=!1);e=e||window.event;var t=w.getRealTarget(e);if("svg-hover-button"===t.id){var i=e.relatedTarget||e.fromElement;if(i){if(L&&i.correspondingUseElement&&(i=i.correspondingUseElement),i.parentNode)for(;i.parentNode;){if(i==t)return;i=i.parentNode,L&&i&&i.correspondingUseElement&&(i=i.correspondingUseElement)}if(i.offsetParent)for(;i.offsetParent;){if(i==t)return;i=i.offsetParent,L&&i&&i.correspondingUseElement&&(i=i.correspondingUseElement)}}w.removeClass(t,"removing"),w.addClass(t,"freeze"),C.clearAddHelperTimer()}else"slickplan"===t.id?C.hideAddHelperPlaceholder():w.hasClass(t,"cellmask")||o(e)}),k.body.addEventListener("mouseout",function(e){if(C.isEditBlocked())return!1;e=e||window.event;var t=w.getRealTarget(e);if("svg-hover-button"===t.id){var i=e.relatedTarget||e.toElement;if(i){if(L&&i.correspondingUseElement&&(i=i.correspondingUseElement),i.parentNode)for(;i.parentNode;){if(i==t)return;i=i.parentNode,L&&i&&i.correspondingUseElement&&(i=i.correspondingUseElement)}if(i.offsetParent)for(;i.offsetParent;){if(i==t)return;i=i.offsetParent,L&&i&&i.correspondingUseElement&&(i=i.correspondingUseElement)}}w.removeClass(t,"freeze"),C.hideAddHelperPlaceholder(),r()}else w.hasClass(t,"cellmask")||B.css({left:-99999,top:-99999})}),k.body.addEventListener("click",function(a){a=a||window.event,C.last_mouse_event=a;var o=w.getRealTarget(a);if(o&&o.className&&o.className.baseVal){var n=C.isEditBlocked(),s=o.className.baseVal;if(!n&&s.indexOf("bar-section")>=0)if(t.currentUserCan("sitemap_sections")){K=!0;var l=e(o).closest(".cell").get(0);l&&(C.setCurrentCell(l),C.openSection(i,l),setTimeout(function(){K=!1,r(i,!0)},1e3))}else t.noPermissions();else if(!n&&(s.indexOf("bar-archetype")>=0||s.indexOf("icon-")>=0)){var l=e(o).closest(".cell").get(0);if(l){C.setCurrentCell(l);var c=(" "+w.getAttr(o,"class")+" ").match(/\s(?:icon|bar)\-([a-z]+)\s/);if(c&&c.length>1){var d=!1,u=E.find('[data-modalid="cell-'+c[1]+'"]');u.length||(u=E.find(".xcell"+c[1]),d=!0),u.length?(u.trigger("click"),d&&(K=!0,setTimeout(function(){K=!1,r(i,!0)},1e3))):t.noPermissions()}}}else if(n||"svg-hover-button"!==o.id){if(s.indexOf("collapse")>=0){var p=e.trim(s.replace(/(connection|collapse)/g,"")),u=E.find(".expandcollapse").filter(":first");u.length&&u.trigger("click",[p])}else if(s.indexOf("cellmask")>=0){var l=e(o).closest(".cell").get(0);l&&!w.hasClass(o,"non-clickable")&&C.toggleCellMaskHighlight(l)}}else{var p=w.getData(o,C.getOption("data_cell_ref")),m=w.getData(o,C.getOption("data_helper_type")),l=w.getElement(p),f={};switch(m){case"move-middle":case"add-middle":f.parent=p;break;case"move-top":case"add-top":case"move-top-left":case"add-top-left":f.before=p;break;case"move-bottom":case"add-bottom":case"move-top-right":case"add-top-right":f.after=p}var h=C.getCellLevel(l);"util"===h||"foot"===h?C.insertNewCell(f,h):"home"!==h&&C.insertNewCell(f)}}}),k.body.addEventListener("mousemove",function(e){if(C.last_mouse_event=e,!C.isEditBlocked()&&!C.isBatchEdit()){var t=C.getCellByCoords(e);t?(s(t),r(t)):r()}}),t.subscribe("sitemap/sitemap_modified sitemap/history_undo sitemap/history_redo sitemap/collapse_expand",function(e,i,a,o,n){if(C.serialize(a,!0),t.has_unsaved_changes.sitemap=!0,b.get("auto_save",!1)){var s=!1,r=null;if("sitemap/sitemap_modified"===e.type){var l="__slickplan_KURWA_remove";switch(i){case"color_scheme":r={},r[a]={options:{design:n.style,text_shadow:n.textShadow,color_scheme:o}};break;case"template":r={},r[a]={options:{template:o}};break;case"cell_add":case"cell_remove":case"drag_stop":case"content_edited":case"diagrams_edited":case"files_edited":case"batch_edit":var u=C.getSerialized(!0,a);u&&u.cells&&(r={},r[a]={cells:u.cells});break;case"cells_clone":if(!o&&a===C.getCurrentSection()){var u=C.getSerialized(!0,a);u&&u.cells&&(r={},r[a]={cells:u.cells})}break;case"cell_color":case"cell_text_color":o&&o.id&&(r={},r[a]={cells_data:{}},r[a].cells_data[o.id]={},"cell_color"===i&&(r[a].cells_data[o.id].color=o.color?o.color:l),"cell_text_color"===i&&(r[a].cells_data[o.id].textcolor=o.textcolor?o.textcolor:l));break;case"cell_data_add":case"cell_data_remove":o&&o.id&&n&&(r={},r[a]={cells_data:{}},r[a].cells_data[o.id]={},"cell_data_add"===i&&(r[a].cells_data[o.id][n]=o[n]?o[n]:l),"cell_data_remove"===i&&(r[a].cells_data[o.id][n]=l))}r&&(c(r,!0,null,i),s=!0)}else if("sitemap/history_undo"===e.type||"sitemap/history_redo"===e.type){if(o&&o.serialized&&o.serialized[a]&&o.serialized[a].cells)r={},r[a]={cells:o.serialized[a].cells};else{var u=C.getSerialized(!0,a);u&&u.cells&&(r={},r[a]={cells:u.cells})}r&&(c(r,!0,null,i),s=!0)}s||d(!0,null,i)}})}else{t.$body.on("click",".ui-widget-overlay",function(){e(".top-modal").dialog("close")}),k.body.addEventListener("mouseover",function(e){e=e||window.event,o(e,-17)}),k.body.addEventListener("mouseout",function(){B.css({left:-99999,top:-99999})});var Z=!1;t.$window.on("click",function(){if(Z){w.removeClass(Z,"highlighted");var e=C.getPapers();if(e&&e.svg)for(var t=e.svg.querySelectorAll(".cellmask"),i=t.length;i>=0;--i)w.removeElement(t[i]);Z=!1}}),k.body.addEventListener("click",function(a){var o=w.getRealTarget(a);if(o&&o.className&&o.className.baseVal){var n=o.className.baseVal;if(n.indexOf("icon-note")>=0){var s=e(o).closest(".cell");if("object"===e.type(s)&&s.length){var r=w.getData(s[0],C.getOption("data_desc"))||"";u(s,r)}}else if(n.indexOf("icon-file")>=0){var s=e(o).closest(".cell");t.publish("sitemap/lightbox_cell_files/open",[s.get(0),i,"images"])}else if(n.indexOf("icon-diagrams")>=0){var s=e(o).closest(".cell");t.publish("sitemap/lightbox_cell_diagrams/open",[s.get(0)])}else if(n.indexOf("icon-content")>=0){var s=e(o).closest(".cell");t.publish("sitemap/lightbox_cell_content/open",[s.get(0)])}else if(n.indexOf("icon-url")>=0){var l=w.getData(e(o).closest(".cell")[0],C.getOption("data_url"));if("string"===e.type(l))window.open(l);else if(l&&e.isArray(l))if(1===l.length&&"internal"===l[0].type&&l[0].page){var c=C.getCellSection(l[0].page),d=C.getCurrentSection();if(c&&d){var p=function(e){if(l[0].page){var t=C.getSectionElement(e);if(t&&t.group){var i=t.group.querySelectorAll(".cell");w.addClass(l[0].page,"highlighted");for(var a=0,o=i.length;o>a;++a)w.use("svg-cell-disabled-mask",{"class":"cellmask non-clickable "+(i[a].id===l[0].page?"enabled":"disabled")},i[a]);setTimeout(function(){Z=l[0].page},50)}}};if(c!==d){var m=C.getSectionCell(c);m&&C.openSection(c,m,i,i,i,function(e){_refreshVariables(),p(e)})}else p(d)}}else if(1===l.length&&"external"===l[0].type&&""===l[0].label)l[0].url&&window.open(l[0].url);else{for(var f="",h=0,g=l.length;g>h;++h)if("object"===e.type(l[h])&&l[h].type&&l[h].url&&"external"===l[h].type){var v=l[h].label;v||(v=l[h].url),f+='<li class="cell-url-preview"><a href="'+l[h].url.replace(/"/g,'\\"')+'" target="_blank"><span>'+_.charsEncode(v),f+='</span> <i class="fa fa-external-link"></i>',f+="</a></li>"}if(f){f="<ul>"+f+"</ul>";var s=e(o).closest(".cell");u(s,f,!0)}}}else if(n.indexOf("bar-section")>=0){var s=e(o).closest(".cell");C.setCurrentCell(s[0]),C.openSection(i,s[0])}else if(n.indexOf("bar-archetype")>=0){var s=e(o).closest(".cell"),k=s[0],x=w.getData(k,C.getOption("data_archetype"));if(x&&"string"===e.type(x)){var S=b.get("archetypes"),r=!1,D=!1,q=!1;if("_"===x.charAt(0)&&S[x]&&S[x].desc?(r=S[x].desc,r="<p>"+_.charsEncode(r)+"</p>",D=_.charsEncode(S[x].name)):S._custom[x]&&S._custom[x].desc&&(r=S._custom[x].desc,D=_.charsEncode(S._custom[x].name),"fa-"===S._custom[x].icon.substring(0,3)?D='<i class="fa '+S._custom[x].icon+'"></i>'+D:""!==S._custom[x].icon&&1===S._custom[x].icon.length&&(D='<span class="letter">'+_.charsEncode(S._custom[x].icon)+"</span>"+D),q=!0),r&&D){var E="black-arrow";e(".top-modal").dialog("close");var A={my:"left top",at:"left center",of:s,top_offset:20,left_offset:-8},T=k.getElementById("bar-section-"+k.id),$=k.getElementById("bar-archetype-"+k.id),L=k.getElementById("icon-note-"+k.id),O=k.getElementById("icon-url-"+k.id),I=k.getElementById("icon-file-"+k.id),j=k.getElementById("icon-diagrams-"+k.id),P=(T?1:0)+($?1:0),N=(L?1:0)+(O?1:0)+(I?1:0)+(j?1:0),U=!(!Boolean(P>1)&&!Boolean(N>1));U&&(A.at="left bottom",A.top_offset=1,E+=" arrow-second");var R=e("#topmodal-cell-archetype");if(R.dialog("open"),R.parent().removeClass("black-arrow arrow-second").addClass(E),w.position(R.parent(),A,{top:0,left:0}),"object"===e.type(s)&&s instanceof e&&s.length){e("#archetype-desc .title > h4").html(D).attr("class","archetype-"+(q?"custom":x));var M=e("#archetype-desc").show().find(".text");M.hasClass("tinyscrollbar-enabled")?(y.updateContent(M,r),y.update(M)):(M.html(r),y.init(M)),M.find("a").attr("target","_blank")}}}}else if(n.indexOf("collapse")>=0){var m=e.trim(n.replace(/(connection|collapse)/g,""));m&&C.toggleChildren(m,i,!z)}}})}var X=e("#modal-share");if(X.length){var Q=e("#share-basecamp"),ee=function(){var e=X.children("form").filter(":visible").height()+(X.outerHeight(!0)-X.height());e=Math.max(e,410);var i=t.$window.height()-e;i=i>0?Math.max(i/2,0):0,X.parent("div").css({top:i,height:e})};X.parent("div").addClass("ui-modal-share").end().tabs({activate:function(){ee()}});var te=Q.find(".select.baccount select");te.selectmenuslickplan("destroy"),te.selectmenuslickplan({style:"popup",maxHeight:400,format:function(e){return _.charsEncode(e)}}),te.change(function(){f.clearAll(),m.clearErrors(e(this).closest(".select"));var t=e(this).val();Q.find(".recipients > div").remove(),Q.find(".select.bproject").hide();var i=e('<div id="basecamp-project-'+t+'" class="loading" />').appendTo("#share-basecamp .recipients");f.request({data:{basecamp_share_account:t},success:function(e){if(e.projects){for(var t='<option value="">Select Project</option>',a=0;a<e.projects.length;++a)t+='<option value="'+e.projects[a].id+'">'+e.projects[a].full_name+"</option>";Q.find(".select.bproject select").html(t)}var o=Q.find(".select.bproject").show().find("select");o.selectmenuslickplan("destroy"),o.selectmenuslickplan({style:"popup",maxHeight:400,format:function(e){return _.charsEncode(e)}}),i.remove(),ee()}})}),te=Q.find(".select.bproject select"),te.selectmenuslickplan("destroy"),te.selectmenuslickplan({style:"popup",maxHeight:400,format:function(e){return _.charsEncode(e)}}),te.change(function(){f.clearAll(),m.clearErrors(e(this).closest(".select"));var t=e(this).val(),i=e(this).find("option:selected").text();Q.find(".recipients > div").remove();var a=e('<div id="basecamp-project-'+t+'" class="loading" />').appendTo("#share-basecamp .recipients"),o=0;Q.find(".select.baccount select").length&&(o=Q.find(".select.baccount select").val()),f.request({data:{basecamp_account:o,basecamp_share:t},success:function(o){e(".basecamp-hide").show(),a.removeClass("loading");var n="<h2>"+i+"</h2>";if(o.recipients)for(var s=0;s<o.recipients.length;++s){var r=0===s||s%3===0?" first":"";n+='<div class="checkbox border'+r+'"><input type="checkbox" id="form-brecipient-'+t+"-"+o.recipients[s].id+'" name="recipient[]" value="'+o.recipients[s].id+'"><label for="form-brecipient-'+t+"-"+o.recipients[s].id+'">'+o.recipients[s].first_name+" "+o.recipients[s].last_name+"</label></div>"}if(a.append(n).show(),v.wysiwygInit("share-basecamp-message",!1,{width:677,height:55}),o.categories){var l=Q.find("#basecampcat");l.selectmenuslickplan("destroy"),l.html('<option value="0">Category</option>');for(var s=0;s<o.categories.length;++s)l.append('<option value="'+o.categories[s].id+'">'+o.categories[s].name+"</option>");l.val("0").selectmenuslickplan({style:"popup",maxHeight:200,format:function(e){return _.charsEncode(e)}})}ee()}})}),Q.on("submit",function(i){i.preventDefault(),f.clearAll(),m.clearErrors(e(this));var a=v.wysiwyg("share-basecamp-message");a&&a.save();var o=e("#share-basecamp-subject"),n=e("#share-basecamp-message"),s=e("#basecampproject"),r=m.validate([{value:o.val(),tiperror:o.parent(),rules:{empty:"Subject must not be empty"},css:{left:666,bottom:5}},{value:n.val(),tiperror:n.parent(),rules:{empty:"Message must not be empty"},css:{left:666,bottom:170}},{value:s.val(),tiperror:s.parent(),rules:{empty:"Select a project"},css:{left:666,bottom:20}}]);if(r){var l=e(this).closest(".modal"),c=m.serializeObject(e(this));f.request({data:c,$loading:e(this).find(".loading").css({visibility:"visible"}),success:function(i){var a=Q.find("select");a.selectmenuslickplan("destroy"),a.not("#basecampcat").val("").selectmenuslickplan({
    style:"popup",maxHeight:400,format:function(e){return _.charsEncode(e)}}),Q.find("#basecampcat").selectmenuslickplan({style:"popup",maxHeight:200,format:function(e){return _.charsEncode(e)}}),Q.find(".recipients > div").remove(),e(".basecamp-hide").hide(),l.dialog("close"),i.error?g.error(t.__("An error occured")):g.success(t.__("Posted to Basecamp successfully"))},error:function(){var t=Q.find("select");t.selectmenuslickplan("destroy"),t.not("#basecampcat").val("").selectmenuslickplan({style:"popup",maxHeight:400,format:function(e){return _.charsEncode(e)}}),Q.find("#basecampcat").selectmenuslickplan({style:"popup",maxHeight:200,format:function(e){return _.charsEncode(e)}}),Q.find(".recipients > div").remove(),e(".basecamp-hide").hide(),l.dialog("close")}})}}),t.$body.on("click","#add-recipient button",function(i){i.preventDefault(),m.clearErrors(e("#share-email"));var a=e("#add-recipient input").filter(":last"),o=e("#add-recipient input").filter(":first"),n=m.validate([{value:a.val(),tiperror:a.parent(),rules:{empty:t.__("Email must not be empty"),email:t.__("Invalid Email")},bottom:10},{value:o.val(),tiperror:o.parent(),rules:{empty:t.__("Name must not be empty")},bottom:10}]);if(!n)return!1;var s=e("#share-email .recipients input").length,r=e("<div />").addClass("checkbox border");s%3===0&&r.addClass("first"),r.html('<input type="checkbox" id="form-recipient-'+ ++s+'" name="recipients[]" value="'+_.charsEncode(a.val())+'" checked><label for="form-recipient-'+s+'">'+_.charsEncode(o.val())+"</label>"),r.appendTo("#share-email .recipients"),e("#add-recipient input").val("").blur(),ee()}),e("#share-email").on("submit",function(a){a.preventDefault(),f.clearAll(),m.clearErrors(e(this));var o=e("#share-mail-subject"),n=e("#share-mail-message"),s=m.validate([{value:o.val(),tiperror:o.parent(),rules:{empty:t.__("Subject must not be empty")},css:{left:666,bottom:5}},{value:n.val(),tiperror:n.parent(),rules:{empty:t.__("Message must not be empty")},css:{left:666,bottom:170}}]);if(e("#share-email .recipients input:checked").length){if(s){var r=e(this).closest(".modal"),l=m.serializeObject(e(this));f.request({data:l,$loading:e(this).find(".loading").css({visibility:"visible"}),success:function(){r.dialog("close"),g.success(t.__("Email sent successfully"))},error:function(){r.dialog("close")}})}}else m.error(e("#add-recipient").children(".input").filter(":first"),t.__("Select at least one recipient"),{left:426,bottom:5},i,i,10)}),t.$body.on("change","#share-mail-subject, #share-mail-message",function(){e("#share-email .error").removeClass("error");var t=e("#share-mail-subject").val(),i=e("#share-mail-message").val(),a=e("#share-email .recipients input:checked").length;a&&e("#add-recipient > div.input").removeClass("error"),t&&e("#share-mail-subject").parent("div").removeClass("error"),i&&e("#share-mail-message").parent("div").removeClass("error")}),t.$body.on("change","#share-email .recipients input",function(){e("#add-recipient .error").removeClass("error");var t=e("#share-email .recipients input:checked").length;t||e("#add-recipient > div.input").addClass("error")}),t.$body.on("click",'#share-social input[type="submit"]',function(i){i.preventDefault();var a=e(this).closest("fieldset"),o=e('head > link[rel="canonical"]').attr("href"),n=e.trim(a.find('input[type="text"]').val().replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,"")),s=550,r=300;"share-social-facebook"===a.attr("id")?o="https://www.facebook.com/dialog/feed?app_id=1644584042446558&display=popup&caption="+encodeURIComponent(n)+"&picture&link="+encodeURIComponent(o)+"&redirect_uri="+encodeURIComponent(o):"share-social-linkedin"===a.attr("id")?(s=580,r=350,o="http://www.linkedin.com/shareArticle?mini=true&ro=false&trk=bookmarklet&title="+encodeURIComponent(n)+"&url="+encodeURIComponent(o)):o="https://twitter.com/intent/tweet?url="+encodeURIComponent(o)+"&text="+encodeURIComponent(n),window.open(o,"intent","scrollbars=yes,resizable=yes,toolbar=no,location=yes,width="+s+",height="+r+",left="+(t.getWindowWidth()/2-s/2)+",top="+(t.$window.height()/2-r/2)),f.request({data:{sitemap_shared:"social"}})}),e("#share-password").on("submit",function(a){a.preventDefault(),f.clearAll(),m.clearErrors(e(this));var o=m.serializeObject(e(this)),n=e(this).closest(".modal"),s=e("#form-share-password"),r=e("#form-enablepass"),l=e.trim(s.val()),c=l.replace(/\*/g,"");c?f.request({data:o,$loading:e(this).find(".loading").css({visibility:"visible"}),success:function(){n.dialog("close"),g.success(t.__("Password changed")),s.replaceWith('<input type="password" id="form-share-password" name="password_protect" value="********">'),r.replaceWith('<input type="checkbox" id="form-enablepass" name="password_protect_enabled" value="1" checked>'),e("#share-password").data("haspasswd","1")},error:function(){n.dialog("close")}}):l?(n.dialog("close"),g.success(t.__("Password not changed")),r.replaceWith('<input type="checkbox" id="form-enablepass" name="password_protect_enabled" value="1" checked>'),e("#share-password").data("haspasswd","1")):m.error(s.parent(),t.__("Password must not be empty"),i,i,i,10)}),t.$body.on("change","#form-enablepass",function(){var i=e(this),a=i.parent().next(".input");if(this.checked)e("#form-share-password").replaceWith('<input type="password" id="form-share-password" name="password_protect" value="">'),a.show();else{a.hide();var o=parseInt(e("#share-password").data("haspasswd"),10);o&&(f.request({data:this.name+"=0"}),i.replaceWith('<input type="checkbox" id="form-enablepass" name="password_protect_enabled" value="1">'),e("#share-password").data("haspasswd","0"),g.success(t.__("Password removed")))}}).on("click","#share-open-new-window",function(t){t.preventDefault();var i=e(this).siblings(".urlfield").val();window.open(i)}).on("click","#share-clipboard",function(e){e.preventDefault()}),t.subscribe("modal/open/modal-share",function(t,i){if(i.length){i.find(".shprivacy").show();var a=e("#lightbox-cell-diagrams"),o=i.data("url"),n="sitemap",s=e("#change-sitemap-version").find("option:selected").text(),r=e("#change-sitemap").find("option:selected").text();if(a.length&&a.hasClass("show")){var l=a.find(".title .tab.current"),c=l&&l.length?l.data("diagram_id"):null;c&&(o+="/diagram/"+c.replace("svgdiagram",""),n="diagram",r=l.text(),s="",i.find(".shprivacy").hide())}else{var d=i.find("#form-enablepass");d.length&&d.is(":checked")?d.parent().next(".input").show():d.parent().next(".input").hide()}i.find(".ui-tabs-nav").children("li").filter(":first").children("a").trigger("click"),i.find(".shtype").text(n.charAt(0).toUpperCase()+n.substr(1)),i.find("input[data-template], textarea[data-template]").each(function(){var t=e(this),i=t.data("template").replace(/\{version\}/g,s).replace(/\{type\}/g,n).replace(/\{url\}/g,o).replace(/\{title\}/g,r);t.val(i),t.hasClass("urlfield")&&e("#share-clipboard").attr("data-clipboard-text",i)}),ee()}}),ZeroClipboard.config({trustedDomains:[window.location.hostname.replace(/^\/|\/$/g,""),b.get("statics_path_subdomained").replace(/^https?:\/\//,"").replace(/\/static\/?$/,"")],allowScriptAccess:"always",swfPath:b.get("statics_path_subdomained")+"js/ZeroClipboard/ZeroClipboard.swf",forceHandCursor:!0});var ie=new ZeroClipboard(k.getElementById("share-clipboard"));ie.on("ready",function(){ie.on("aftercopy",function(){f.request({data:{sitemap_shared:"url"}})})})}D.on("click","#comments.button",function(i){return i.preventDefault(),q.length?(t.$body.removeClass(function(e,t){return(t.match(/(^|\s)expanded-\S+/g)||[]).join(" ")}).addClass("expanded-comments"),e(this).children("span").removeClass("new"),v.metaTitleNotification(),f.request({data:{commentview:1},dataType:"html"}),void(e(this).parent().children(".mce-tinymce").length||v.wysiwygInit("form-comment",!1,{width:348,height:280}))):t.noPermissions()}),e("#sitemap-comments-top").on("click","button.reset",function(e){e.preventDefault(),t.$body.removeClass(function(e,t){return(t.match(/(^|\s)expanded-\S+/g)||[]).join(" ")})});var ae=!1,oe=!1,ne=e("#post-comment");if(ne.on("submit",function(i,a,o){if(i.preventDefault(),oe)return!1;if(f.clearAll(),m.clearErrors(ne),!a){var n=v.wysiwyg("form-comment");n&&n.save(),a=e("#form-comment").val()}if(e.trim(a.replace(/<[^>]+>/g,""))){oe=!0;var s=m.serializeObject(e(this));s.comment=a,f.request({data:s,dataType:"html",$loading:e(this).find(".loading").css({visibility:"visible"}),success:function(i){if(i){var a=e("<div />").append(i);if(i=a.find("#scroll-area").html(),t.require("scrollbar").updateContent("#scroll-area",i).update("#scroll-area",ne.find(".reply").is(":visible")?"relative":"bottom"),e("#comments > span").text(parseInt(e("#comments > span").html(),10)+1),!U&&"function"===e.type(f.getSession)){var n=f.getSession();n&&C.getUsersCount()>0&&n.publish("sitemap_comment_"+S,{added:i,count:k.getElementById("comments").querySelector("span").innerHTML,sitemap_id:S})}i=null,o&&"function"===e.type(o)&&o()}else alert("Unknown error");var s=v.wysiwyg("form-comment");s&&s.setContent(""),ne.find("textarea").val(""),ne.find(".reply > a").trigger("click"),oe=!1},error:function(){oe=!1}})}else m.error(ne.find(".submit"),t.__("Comments must not be empty"),{bottom:6},!1,-165)}),e("#scroll-area").on("click","a.reply",function(t){t.preventDefault();var i=ne.find('input[name="reply"]');if(i.length||(i=e('<input type="hidden" name="reply">').appendTo(ne)),i.val(e(this).data("id")),!ae){var a=v.wysiwyg("form-comment");if(a&&a.iframeElement){var o=e(a.iframeElement);o.height(o.height()-24)}ae=!0}ne.find(".reply").show().find("span").html(e(this).siblings("span").html())}),ne.on("click",".reply > a",function(t){if(t.preventDefault(),ne.find('input[name="reply"]').remove(),e(this).parent().hide(),ae){var i=v.wysiwyg("form-comment");if(i&&i.iframeElement){var a=e(i.iframeElement);a.height(a.height()+24)}}ae=!1}),ne.find(".item a").attr("target","_blank"),q.on("click","a[data-delete]",function(i,a,o){i.preventDefault();var n=e(this),s=q.find(".group-"+n.closest(".item").data("id")),r=function(i){if(s.remove(),e("#comments").children("span").text(q.find("div.item").length),t.require("scrollbar").update("#scroll-area","relative"),"function"===e.type(a)&&a(),!U&&"function"===e.type(f.getSession)){var o=f.getSession();o&&C.getUsersCount()>0&&o.publish("sitemap_comment_"+S,{deleted:i,count:k.getElementById("comments").querySelector("span").innerHTML,sitemap_id:S})}},l=n.data("delete");o?r(l):s.animate({height:0,opacity:0},300,function(){e(this).hide()}),f.request({data:{deletecomment:l},success:function(e){e.success?r(l):e.error&&(s.stop().show().css({opacity:1,height:""}),notify(e.error))},error:function(){s.stop().show().css({opacity:1,height:""})}})}),k.createElement("audio").canPlayType){var se=k.createElement("audio"),re=se.canPlayType&&""!=se.canPlayType('audio/ogg; codecs="vorbis"')?"ogg":se.canPlayType&&""!=se.canPlayType("audio/mpeg")?"mp3":"";re.length?(se.setAttribute("src",b.get("statics_path")+"commentsnd."+re),se.load()):se=null}e("#sitemap-name").on("change","select.change_sitemap",function(){if(this.value){var e=k.location.href.split("/");e[e.length-1]=this.value,h.redirect(e.join("/"))}}),t.$body.on("click","a[data-action]",function(t){t.preventDefault(),e(e(this).data("action")).trigger("click")}).on("click","#action-lock, #action-unlock, #action-approve",function(e){e.preventDefault();var i=this.id.replace("action-","");I=!0,g.clearAll(!0);var a={};a["sitemap_"+i]=1,f.request({data:a,success:function(e){e.redirect?(t.publish("sitemap/status_changed/"+i),h.redirect(e.redirect)):(e.error||(e.error=t.__("An error occured")),g.error(e.error),I=!1)},error:function(){g.error(t.__("An error occured")),I=!1}})}).on("click","#action-request-unlock",function(e){e.preventDefault(),I=!0,g.clearAll(!0),f.request({data:{sitemap_request_unlock:1},success:function(e){e.success?g.success(e.success):(e.error||(e.error=t.__("An error occured")),g.error(e.error),I=!1)},error:function(){g.error(t.__("An error occured")),I=!1}})}),A.on("click",".collapseall, .expandall",function(t){t.preventDefault();var i=C.getSectionElement();if(!i||!i.group)return!1;if(e(this).hasClass("collapseall"))for(var a=i.group.querySelectorAll(".cell.has-childs"),o=0,n=a.length;n>o;++o)w.hasClass(a[o],"collapsed")||C.toggleChildren(a[o],!0,!0,!0);else for(var a=i.group.querySelectorAll(".cell.collapsed"),o=0,n=a.length;n>o;++o)C.toggleChildren(a[o],!0,!0,!0);C.fullRefresh()}),t.subscribe("sitemap/after_load notification_closed",function(){I||"object"===e.type(window._SLICKPLAN_LOCK)&&window._SLICKPLAN_LOCK.type&&window._SLICKPLAN_LOCK.message&&g.display(window._SLICKPLAN_LOCK.message,{persistent:!0,html:!0,type:window._SLICKPLAN_LOCK.type})}),z&&A.on("click","#action-save",function(e,t){e.preventDefault(),d(!1,t,"manual_save")}).on("click","#action-orientation-horizontal, #action-orientation-vertical, #action-orientation-tree",function(a){if(a.preventDefault(),C.isEditBlocked(i,"sitemap"))return!1;var o=(""+this.id).replace("#","").replace("action-orientation-","");e(this).removeClass("vertical horizontal tree").addClass(o),w.clearCache(),C.clearCache(),C.changeTemplate(o),setTimeout(function(){C.getScrollWrapper().scrollLeft(0),C.fullRefresh()},10),t.publish("sitemap/sitemap_modified",["template",C.getCurrentSection(),o])}),A.on("click","#action-print",function(e){e.preventDefault(),window.print!==i&&window.print()}).on("click","#action-zoom-in, #action-zoom-out",function(e){e.preventDefault();var i="action-zoom-in"===this.id?C.zoomIn():C.zoomOut();g.info(t.__("Zoom: {1}%",Math.round(100*i)),{icon:!1,persistent:!1})}).find(".editdisabled").off("click").on("click",function(e){return e.preventDefault(),e.stopPropagation(),j||P?void 0:t.noPermissions()});var le=t.getWindowWidth(),ce=t.$window.height();t.$window.on("debouncedresize",function(i,a){if("object"===e.type(a)&&a.element&&a.position)return!1;var o=t.getWindowWidth(),n=t.$window.height();le!=o&&(C.fullRefresh(),le=o),ce!=n&&(C.refreshContainerSize(),ce=n)});var de=b.get("me"),ue=!1,pe=!1;t.subscribe("websocket/sitemap/edit/"+S,function(a,o){if(!U){if(t.$body.addClass("canwebsocket"),o.subscribe("account_data_changed_"+b.get("account").subdomain,function(t,i){if(i.user_id){var a=i.user_id,o=e("#box-contributor-"+a);o.length&&o.attr("title",i.email).data("email",i.email).data("first",i.first_name).data("last",i.last_name).children("span").text(i.first_name+" "+i.last_name)}}),o.subscribe("sitemap_comment_"+S,function(a,o){var n=k.getElementById("comments").querySelector("span");if(n&&o.added&&o.count!==i){var s=parseInt(n.innerHTML,10);if(o.count=parseInt(o.count,10),o.count!==s){t.require("scrollbar").updateContent("#scroll-area",o.added).update("#scroll-area"),n.classList.add("new");var r=o.count-n.innerHTML;n.innerHTML=o.count,"object"===e.type(se)&&(se.play(),v.metaTitleNotification(r));var l=e("#scroll-area");if(l.find("a[data-delete]").remove(),$){var c=t.__("Delete");l.find(".reply").each(function(){var t=e(this).closest(".item").data("id");e(this).before('<a data-delete="'+t+'" href="#">'+c+"</a>")})}}}n&&o.deleted&&o.count!==i&&(o.count=parseInt(o.count,10),n.innerHTML=o.count,e("#comment-item-"+o.deleted).remove())}),o.subscribe("sitemap_"+S+"_cells_group_change",function(e,t){t.user_id&&t.user_id!==de.id&&v.isObject(t.groups)&&C.loadCellsGroupsJSON(t.groups)}),o.subscribe("sitemap_"+S+"_user_"+de.id+"_onconnect_callback",function(i,a){a.user&&a.user.user_id!==de.id&&C.addUser(a.user);var o=C.getOption("id_main_section");if(!ue&&a.sitemap&&a.sitemap[o]&&a.sitemap[o].cells&&a.sitemap[o].cells.length){O=!0,ue=!0,C.blockEdit(o,"sitemap",a.user.user_id),C.loadFromWebsocket(a.sitemap);var n=k.getElementById(o);if(n){var s=n.querySelector("svg.cell.level-home");s||(s=n.querySelector("svg.cell")),s&&C.setCurrentCell(s)}C.unblockEdit(o,"sitemap",a.user.user_id),C.fullRefresh()}if(a.editing&&a.editing.sitemap_id===S)if("lightbox_dark"===a.editing.type){if(a.editing.cell_id&&a.editing.dialog_id){var r=e.extend({},a.user,a.editing);C.setBlockedCell(a.editing.cell_id,r)}}else a.editing.section_id===o&&C.blockEdit(o,"color"===a.editing.type?"colors":"sitemap",a.user.user_id);a.content_planner_page_edit&&(a.page_id=a.content_planner_page_edit,t.publish("websocket/content_planner/edit_start",[a])),ue=!0}),o.subscribe("sitemap_"+S+"_user_connected",function(i,a){if(a.user_id&&a.user_id!==de.id){var n={user_id:de.id,user:{user_id:de.id,user_name:de.full_name,user_initials:de.initials,user_avatar:e("#user-box img").data("blank")?!1:e("#user-box img").attr("src")},sitemap:z&&!t.$main.hasClass("preview")?C.getSerialized(!0):null,editing:pe,sitemap_id:S};n=t.applyFilters("websocket_pub_user_connected_callback",n),o.publish("sitemap_"+S+"_user_"+a.user_id+"_onconnect_callback",n),C.addUser(a),a.content_planner_page_edit&&(a.page_id=a.content_planner_page_edit,t.publish("websocket/content_planner/edit_start",[a]))}}),o.subscribe("sitemap_"+S+"_user_disconnected",function(e,i){i.user&&i.user.id&&i.user.id!==de.id&&(C.unblockEdit(i.section_id,"sitemap",i.user.id),C.removeUser(i.user.id),C.removeUserFromChat(i.user),t.publish("websocket/content_planner/edit_end",[i.user.id]))}),o.subscribe("sitemap_"+S+"_changed",function(a,o){if(o.action&&o.section_id&&o.user_id!==de.id){var n=!1,s=!0,r=C.getCurrentSection();o.sitemap&&"color_scheme"!==o.action?(o.sitemap[o.section_id]&&o.sitemap[o.section_id].cells&&o.sitemap[o.section_id].cells.length&&C.loadFromWebsocket(o.sitemap,o.section_id),s=o.section_id===r,n=!0):(C.setCurrentSection(o.section_id),"color_scheme"===o.action&&o.data&&"undefined"!==e.type(o.data.default_color)&&("string"===e.type(o.additional_data)?C.changeStyle(o.additional_data,!0):o.additional_data&&("string"===e.type(o.additional_data.style)&&C.changeStyle(o.additional_data.style,!0),o.additional_data.textShadow!==i&&C.setTextShadow(!!o.additional_data.textShadow,o.section_id)),C.setTempScheme(o.data),n=!0,pe&&(s=!1))),s&&C.fullRefresh(),n&&z&&t.publish("sitemap/sitemap_modified_via_websocket",[null,o.section_id]),r&&C.setCurrentSection(r)}}),o.subscribe("sitemap_"+S+"_logo_changed",function(a,o){if(o.new_logo!==i&&o.user_id!==de.id){var n=e("#sitemap-logo");"string"===e.type(o.new_logo)&&o.new_logo.length>0?n.find(".loading-logo").hide().end().find(".add-logo").hide().end().find(".sitemap-logo").addClass("visible").show().find("img").attr("src",o.file_path):(n.find(".sitemap-logo").removeClass("visible"),n.find(".loading-logo").hide(),e("#pluploadbtn").show()),t.publish("upload/refresh")}}),o.subscribe("sitemap_"+S+"_custom_archetype_saved",function(t,a){if(a.archetype_id&&a.archetype_name&&a.archetype_icon&&a.user_id!==de.id){var o=b.get("archetypes",{});if(o._custom[a.archetype_id]===i){if("fa-"===a.archetype_icon.substring(0,3))var n='<i class="fa '+a.archetype_icon+'"></i>',s={type:"fa",fa:a.archetype_icon};else var n=a.archetype_icon,s={type:"letter",letter:a.archetype_icon};o._custom[a.archetype_id]={name:a.archetype_name,icon:a.archetype_icon},b.set("archetypes",o),C.updateArchetypeDef(a.archetype_id,a.archetype_name,s);var r=e('<div data-archetype="'+a.archetype_id+'" class="archetype archetype-'+a.archetype_id+'" title="'+a.archetype_name.replace(/"/g,"&quot;")+'"><span>'+a.archetype_name+'</span><div class="icon">'+n+'</div><a href="#" class="edit"><i class="fa fa-pencil"></i></a></div>');e("#topmodal-cell-archetype #archetype-desc").before(r),a.cell_id!==i&&C.addCellArchetype(a.cell_id,a.archetype_id,!0)}}}),o.subscribe("sitemap_"+S+"_custom_archetype_removed",function(t,a){if(a.archetype_id&&a.user_id!==de.id){var o=b.get("archetypes",{});o._custom[a.archetype_id]!==i&&(o._custom[a.archetype_id]=i,delete o._custom[a.archetype_id],b.set("archetypes",o),e("#topmodal-cell-archetype div.archetype-"+a.archetype_id).remove(),C.removeArchetypeDef(a.archetype_id,!0))}}),o.subscribe("sitemap_"+S+"_history_change",function(e,i){i.section_id&&i.sitemap&&i.user_id!==de.id&&i.sitemap[i.section_id]&&i.sitemap[i.section_id].cells&&i.sitemap[i.section_id].cells.length&&(C.loadFromWebsocket(i.sitemap,i.section_id),C.fullRefresh(),z&&t.publish("sitemap/sitemap_modified_via_websocket",[null,i.section_id]))}),o.subscribe("sitemap_"+S+"_refresh",function(e,t){t.user_id!==de.id&&(b.set("warn_before_leave",!1),h.refresh())}),o.subscribe("sitemap_"+S+"_contributor_"+de.id,function(i,a){if(a.user_id!==de.id&&a.sitemap_id===S&&a.contributor_data){var o=T.data("role");if(!a.contributor_data.role||o!=a.contributor_data.role)return h.refresh();e("#action-approve, #action-unlock, #action-lock").remove(),a.contributor_data.can_lock&&(j?A.find("a.text.close").closest("li").before('<li><a href="#" class="text icon lock" id="action-unlock">Unlock Sitemap</a></li>'):A.find("a.text.close").closest("li").before('<li><a href="#" class="text icon lock" id="action-lock">Lock Sitemap</a></li>')),a.contributor_data&&a.contributor_data.can_approve&&!P&&A.find("a.text.close").closest("li").before('<li><a href="#" class="text icon approve" id="action-approve">Approve Sitemap</a></li>'),I=!0,window._SLICKPLAN_LOCK={},P?(window._SLICKPLAN_LOCK.type="success",window._SLICKPLAN_LOCK.message=t.__("This sitemap has been approved"),a.contributor_data.can_lock?window._SLICKPLAN_LOCK.message+=' <a href="#" data-action="#action-unlock"><i class="fa fa-unlock"></i> '+t.__("Unlock")+"</a>":window._SLICKPLAN_LOCK.message+=' <a href="#" data-action="#action-request-unlock"><i class="fa fa-unlock"></i> '+t.__("Request Unlock")+"</a>",I=!1):a.contributor_data.can_approve&&!j?(window._SLICKPLAN_LOCK.type="info",window._SLICKPLAN_LOCK.message=t.__("You have been assigned to approve this sitemap. ")+' <a href="#" id="action-approve"><i class="fa fa-check"></i> '+t.__("Approve Sitemap")+"</a>",I=!1):j&&(window._SLICKPLAN_LOCK.type="error",window._SLICKPLAN_LOCK.message=t.__("This sitemap has been locked"),a.contributor_data.can_lock?window._SLICKPLAN_LOCK.message+=' <a href="#" data-action="#action-unlock"><i class="fa fa-unlock"></i> '+t.__("Unlock")+"</a>":window._SLICKPLAN_LOCK.message+=' <a href="#" data-action="#action-request-unlock"><i class="fa fa-unlock"></i> '+t.__("Request Unlock")+"</a>",I=!1),g.clearAll(!0),t.publish("notification_closed")}}),o.subscribe("sitemap_"+S+"_chat",function(t,i){if(i.user_id!==de.id)if("chat_message"===i.action&&(C.showChat(),v.metaTitleNotification(1)),i.user){if(C.addUserToChat(i.user),i.message&&i.id){var a=e.trim(""+i.message);""!==a&&C.addMessageToChat(i.user,a,i.id)}}else i.user_left&&C.removeUserFromChat(i.user_left)}),z){var n=function(e,t){t.section_id&&t.user_id&&t.user_id!==de.id&&C.blockEdit(t.section_id,"sitemap",t.user_id)},s=function(e,t){t.section_id&&t.user_id&&t.user_id!==de.id&&C.unblockEdit(t.section_id,"sitemap",t.user_id)};o.subscribe("sitemap_"+S+"_drag_start",n),o.subscribe("sitemap_"+S+"_cell_note_edit_open",n),o.subscribe("sitemap_"+S+"_cell_url_edit_open",n),o.subscribe("sitemap_"+S+"_cell_archetype_edit_open",n),o.subscribe("sitemap_"+S+"_cell_color_edit_open",n),o.subscribe("sitemap_"+S+"_cell_text_color_edit_open",n),o.subscribe("sitemap_"+S+"_cell_text_edit_open",n),o.subscribe("sitemap_"+S+"_lightbox_dark_open",function(e,t){t&&t.dialog_id&&"lightbox-cell-sections"!==t.dialog_id&&"lightbox-cell-content"!==t.dialog_id&&n(e,t),t&&t.cell_id&&t.dialog_id&&C.setBlockedCell(t.cell_id,t)}),o.subscribe("sitemap_"+S+"_drag_stop",s),o.subscribe("sitemap_"+S+"_cell_note_edit_close",s),o.subscribe("sitemap_"+S+"_cell_url_edit_close",s),o.subscribe("sitemap_"+S+"_cell_archetype_edit_close",s),o.subscribe("sitemap_"+S+"_cell_color_edit_close",s),o.subscribe("sitemap_"+S+"_cell_text_color_edit_close",s),o.subscribe("sitemap_"+S+"_cell_text_edit_close",s),o.subscribe("sitemap_"+S+"_lightbox_dark_close",function(e,i){i&&i.dialog_id&&"lightbox-cell-content"===i.dialog_id&&t.publish("websocket/content_planner/edit_end",[i.user_id]),s(e,i),i&&i.cell_id&&C.setBlockedCell(i.cell_id,i,!0)}),o.subscribe("sitemap_"+S+"_batch_edit_open",function(e,t){t.user_id&&t.user_id!==de.id&&C.blockEdit(i,"batchedit",t.user_id)}),o.subscribe("sitemap_"+S+"_batch_edit_close",function(e,t){t.user_id&&t.user_id!==de.id&&C.unblockEdit(i,"batchedit",t.user_id)}),o.subscribe("sitemap_"+S+"_color_edit_open",function(e,t){if(t.type&&t.section_id&&t.user_id)if(t.user_id!==de.id)section_id=C.getCurrentSection(),section_id===t.section_id&&D.find("form.show").find("button.reset").trigger("click",[!0]),C.blockEdit(t.section_id,"colors",t.user_id),p=(new Date).getTime();else if(p&&(new Date).getTime()-p<750){C.unblockEdit(t.section_id,"colors",t.user_id);var i=t.type;switch(t.type){case"swatch_presets":i="color";break;case"lines_text":i="lines-text-colors";break;case"custom_color":i="custom";break;case"shadows_gradients":i="shadows-gradients";break;case"themes":i="color-themes"}D.children("#sitemap-"+i).addClass("show")}}),o.subscribe("sitemap_"+S+"_color_edit_close",function(e,t){t.type&&t.section_id&&t.user_id!==de.id&&C.unblockEdit(t.section_id,"colors",t.user_id)}),o.subscribe("sitemap_"+S+"_content_planner_page_start",function(e,i){i.page_id&&i.section_id&&i.user_id!==de.id&&t.publish("websocket/content_planner/edit_start",[i])}),o.subscribe("sitemap_"+S+"_content_planner_page_end",function(e,i){i.page_id&&i.section_id&&i.user_id!==de.id&&t.publish("websocket/content_planner/edit_end",[i])}),t.subscribe("sitemap/cells_group_add sitemap/cells_group_update sitemap/cells_group_remove",function(e,t,i){C.getUsersCount()<=0||!i||o.publish("sitemap_"+S+"_cells_group_change",{user_id:de.id,user_name:de.full_name,groups:i})}),t.subscribe("sitemap/history_undo sitemap/history_redo",function(e,t,i,a){!(C.getUsersCount()<=0)&&a&&a.serialized&&a.hash&&o.publish("sitemap_"+S+"_history_change",{user_id:de.id,user_name:de.full_name,section_id:i,sitemap:a.serialized,hash:a.hash,sitemap_id:S})}),t.subscribe("sitemap/custom_archetype_saved",function(e,t,i,a){C.getUsersCount()<=0||o.publish("sitemap_"+S+"_custom_archetype_saved",{user_id:de.id,user_name:de.full_name,archetype_id:t,archetype_icon:a,archetype_name:i,sitemap_id:S})}),t.subscribe("sitemap/custom_archetype_removed",function(e,t){C.getUsersCount()<=0||o.publish("sitemap_"+S+"_custom_archetype_removed",{user_id:de.id,user_name:de.full_name,archetype_id:t,sitemap_id:S})}),t.subscribe("sitemap/logo_changed",function(e,t){C.getUsersCount()<=0||o.publish("sitemap_"+S+"_logo_changed",{user_id:de.id,user_name:de.full_name,new_logo:t,sitemap_id:S})}),t.subscribe("sitemap/sitemap_modified",function(e,t,i,a,n){!t||C.getUsersCount()<=0||(i||(i=C.getCurrentSection()),o.publish("sitemap_"+S+"_changed",{user_id:de.id,user_name:de.full_name,action:t,section_id:i,data:a,additional_data:n,sitemap:C.getSerialized(!0),sitemap_id:S}))}),t.subscribe("sitemap/section_opened",function(e,t,i,a,n){C.getUsersCount()<=0||n||o.publish("sitemap_"+S+"_changed",{user_id:de.id,user_name:de.full_name,action:"section_open",section_id:t,data:i,additional_data:a,sitemap:C.getSerialized(!0),sitemap_id:S})}),t.subscribe("sitemap/drag_start",function(e,t,i){pe={sitemap_id:S,section_id:i,type:"drag"},C.getUsersCount()<=0||o.publish("sitemap_"+S+"_drag_start",{user_id:de.id,user_name:de.full_name,section_id:i,sitemap_id:S})}),t.subscribe("sitemap/drag_stop",function(e,t,i){pe=!1,C.getUsersCount()<=0||o.publish("sitemap_"+S+"_drag_stop",{user_id:de.id,user_name:de.full_name,section_id:i,sitemap_id:S})}),t.subscribe("sitemap/color_edit_open",function(e,t,i){pe={sitemap_id:S,section_id:t,type:i},C.getUsersCount()<=0||o.publish("sitemap_"+S+"_color_edit_open",{user_id:de.id,user_name:de.full_name,section_id:t,type:i,sitemap_id:S})}),t.subscribe("sitemap/color_edit_close",function(e,t,i){pe=!1,C.getUsersCount()<=0||o.publish("sitemap_"+S+"_color_edit_close",{user_id:de.id,user_name:de.full_name,section_id:t,type:i,sitemap_id:S})}),t.subscribe("sitemap/batch_edit_open",function(e,t,i){pe={sitemap_id:S,section_id:t,type:i},C.getUsersCount()<=0||o.publish("sitemap_"+S+"_batch_edit_open",{user_id:de.id,user_name:de.full_name,section_id:t,type:i,sitemap_id:S})}),t.subscribe("sitemap/batch_edit_close",function(e,t,i){pe=!1,C.getUsersCount()<=0||o.publish("sitemap_"+S+"_batch_edit_close",{user_id:de.id,user_name:de.full_name,section_id:t,type:i,sitemap_id:S})}),t.subscribe("top_modal/open/topmodal-cell-note",function(){pe={sitemap_id:S,section_id:C.getCurrentSection(),type:"cell_note"},C.getUsersCount()<=0||o.publish("sitemap_"+S+"_cell_note_edit_open",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("top_modal/close/topmodal-cell-note",function(){pe=!1,C.getUsersCount()<=0||o.publish("sitemap_"+S+"_cell_note_edit_close",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("top_modal/open/topmodal-cell-url",function(){pe={sitemap_id:S,section_id:C.getCurrentSection(),type:"cell_url"},C.getUsersCount()<=0||o.publish("sitemap_"+S+"_cell_url_edit_open",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("top_modal/close/topmodal-cell-url",function(){pe=!1,C.getUsersCount()<=0||o.publish("sitemap_"+S+"_cell_url_edit_close",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("top_modal/open/topmodal-cell-archetype",function(){pe={sitemap_id:S,section_id:C.getCurrentSection(),type:"cell_archetype"},C.getUsersCount()<=0||o.publish("sitemap_"+S+"_cell_archetype_edit_open",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("top_modal/close/topmodal-cell-archetype",function(){pe=!1,C.getUsersCount()<=0||o.publish("sitemap_"+S+"_cell_archetype_edit_close",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("top_modal/after_open/topmodal-farbtastic",function(e,t){var i=t.parent().hasClass("cell_color")?"cell_color":t.parent().hasClass("cell_text_color")?"cell_text_color":!1;if(i){if(pe={sitemap_id:S,section_id:C.getCurrentSection(),type:i},C.getUsersCount()<=0)return;o.publish("sitemap_"+S+"_"+i+"_edit_open",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}}),t.subscribe("top_modal/close/topmodal-farbtastic",function(e,t){var i=t.parent().hasClass("cell_color")?"cell_color":t.parent().hasClass("cell_text_color")?"cell_text_color":!1;if(i){if(pe=!1,C.getUsersCount()<=0)return;o.publish("sitemap_"+S+"_"+i+"_edit_close",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}}),t.subscribe("sitemap/cell_text_edit_open",function(){pe={sitemap_id:S,section_id:C.getCurrentSection(),type:"cell_text"},C.getUsersCount()<=0||o.publish("sitemap_"+S+"_cell_text_edit_open",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("sitemap/cell_text_edit_close",function(){pe=!1,C.getUsersCount()<=0||o.publish("sitemap_"+S+"_cell_text_edit_close",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("sitemap/lightbox_dark/open",function(e,t,i){pe={dialog_id:t.attr("id"),section_id:C.getCurrentSection(),sitemap_id:S,cell_id:i,type:"lightbox_dark"},C.getUsersCount()<=0||o.publish("sitemap_"+S+"_lightbox_dark_open",{dialog_id:t.attr("id"),user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S,cell_id:i})}),t.subscribe("sitemap/lightbox_dark/close",function(e,t,i){pe=!1,C.getUsersCount()<=0||o.publish("sitemap_"+S+"_lightbox_dark_close",{dialog_id:t.attr("id"),user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S,cell_id:i})}),t.subscribe("sitemap/content_planner/edit_start",function(e,t){C.getUsersCount()<=0||o.publish("sitemap_"+S+"_content_planner_page_start",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S,page_id:t})}),t.subscribe("sitemap/content_planner/edit_end",function(e,t){C.getUsersCount()<=0||o.publish("sitemap_"+S+"_content_planner_page_end",{
    user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S,page_id:t})})}t.subscribe("sitemap/contributors_changed",function(e,t){for(var i=0;i<t.length;i++)t[i].user_id&&o.publish("sitemap_"+S+"_contributor_"+t[i].user_id,{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S,contributor_data:t[i]})}),t.subscribe("sitemap/status_changed/lock sitemap/status_changed/unlock sitemap/status_changed/approve",function(){o.publish("sitemap_"+S+"_refresh",{user_id:de.id,user_name:de.full_name,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("sitemap/chat_open",function(){o.publish("sitemap_"+S+"_chat",{action:"chat_open",user:de,message:!1,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("sitemap/chat_close",function(){o.publish("sitemap_"+S+"_chat",{action:"chat_close",user_left:de,message:!1,section_id:C.getCurrentSection(),sitemap_id:S})}),t.subscribe("sitemap/chat_message",function(e,t,i){o.publish("sitemap_"+S+"_chat",{action:"chat_message",user:de,message:t,id:i,section_id:C.getCurrentSection(),sitemap_id:S})});var r={user_id:de.id,user_name:de.full_name,user_initials:de.initials,user_avatar:e("#user-box img").data("blank")?!1:e("#user-box img").attr("src"),allow_edit:z,sitemap_id:S,subdomain:b.get("account").subdomain};r=t.applyFilters("websocket_pub_user_connected",r),o.publish("sitemap_"+S+"_user_connected",r)}}),t.subscribe("websocket/disconnect",function(e,t){U||C.getUsersCount()<=0||t.publish("sitemap_"+S+"_user_disconnected",{user:de,allow_edit:z,sitemap_id:S,subdomain:b.get("account").subdomain})}),e("#headercollapse").on("click",function(t){t.preventDefault(),g.clearAll();var i=e(this).toggleClass("collapsed"),a=e("#header-wrapper");i.hasClass("collapsed")?a.css({overflow:"hidden"}).animate({height:0},{duration:333,complete:function(){a.hide()}}):a.show().animate({height:84},{duration:333,complete:function(){a.css({overflow:"visible"})}})}),t.subscribe("sitemap/json_loaded sitemap/section_opened sitemap/section_closed",function(){var t=C.getTemplate();t&&e("#action-orientation").removeClass("vertical horizontal tree").addClass(t)}),t.subscribe("sitemap/sitemap_modified sitemap/history_undo sitemap/history_redo sitemap/sitemap_modified_via_websocket",function(){C.refreshPageCount()}),t.subscribe("sitemap/section_before_open sitemap/section_before_close",function(){e("#sitemap-top").find("form.show").find("button.reset").trigger("click")}),function(){var a=e("#section-trans-overlay"),o=null,n={},s=null,r={width:0,height:0},l=function(){var t=0;"object"===e.type(o)&&o instanceof e&&o.length&&(t=o.outerHeight()+150),t=Math.max(500,t),a.width(r.width+200).height(r.height+t)};t.subscribe("sitemap/section_before_open",function(){r={width:0,height:0}}),t.subscribe("sitemap/container_refreshed",function(t,i,n,s){if(!C.isMainSection(s)&&a.length){if(r.width=i,r.height>0&&n>r.height&&"object"===e.type(o)&&o instanceof e&&o.length){var c=n-r.height;o.is("#map-dropdown")?o.css("top","-="+c+"px"):o.closest(".ui-dialog").css("top","-="+c+"px")}r.height=n,l()}}),t.subscribe("sitemap/dropdown_open top_modal/open/topmodal-cell-note top_modal/open/topmodal-cell-url top_modal/open/topmodal-cell-archetype top_modal/open/topmodal-farbtastic",function(e,t){clearTimeout(s),o=t,!C.isMainSection()&&a.length&&(a.show(),l())}),t.subscribe("sitemap/dropdown_close top_modal/close/topmodal-cell-note top_modal/close/topmodal-cell-url top_modal/close/topmodal-cell-archetype top_modal/close/topmodal-farbtastic",function(){o=null,s=setTimeout(function(){!C.isMainSection()&&a.length&&a.hide()},50)}),t.subscribe("sitemap/map_dropdown/init top_modal/open/topmodal-farbtastic top_modal/open/topmodal-cell-note top_modal/open/topmodal-cell-url top_modal/open/topmodal-cell-archetype",function(e,t){n[e.type]||(n[e.type]=!0,t.on("mousewheel",function(e){if(!C.isMainSection()){var t=C.getSectionWrapper(i,!0,!0);if(t.length){var a=t.scrollTop()-e.deltaY*e.deltaFactor;t.scrollTop(a)}}}))}),e("#section-svg-wrapper").on("scrolldelta",function(t){if("object"===e.type(o)&&o instanceof e&&o.length){var i={};0!==t.scrollTopDelta&&(i.top=(t.scrollTopDelta<0?"+=":"-=")+Math.abs(t.scrollTopDelta).toString()+"px"),0!==t.scrollLeftDelta&&(i.left=(t.scrollLeftDelta<0?"+=":"-=")+Math.abs(t.scrollLeftDelta).toString()+"px"),(i.top||i.left)&&(o.is("#map-dropdown")?o.css(i):o.closest(".ui-dialog").css(i))}})}()})}),Slickplan.module(function(e,t,i){function a(t,i){if(window.document.getElementById("form-cell-archetype-desc")){t?(e("#archetype-custom-description").hide(),e("#archetype-custom-wysiwyg").show()):(e("#archetype-custom-description").show(),e("#archetype-custom-wysiwyg").hide()),e("#form-cell-archetype-desc").val("");var a=s.wysiwyg("form-cell-archetype-desc");a&&(i=i||"",a.setContent(i))}}function o(t){if(t)e("#topmodal-cell-archetype .types").removeAttr("style");else{var i=e("#archetype-custom-add"),a=i.children(".title").outerHeight(!0)+i.children(".text").outerHeight(!0);a-=25,i.closest(".types").attr("style","min-height: "+a+"px !important")}}function n(e){return"fa-"===e.slice(0,3)?'<i class="fa '+e+'"></i>':""!==e&&1===e.length?'<span class="letter">'+t.require("string").charsEncode(e)+"</span>":!1}var s=t.require("helper"),r=!1;t.subscribe("route/sitemap",function(){var l=t.require("sitemap"),c=t.require("config"),d=t.require("string"),u=t.require("websocket"),p=t.require("scrollbar"),m=c.get("archetypes"),f=e("#topmodal-cell-archetype");window.document.getElementById("form-cell-archetype-desc")&&s.wysiwygInit("form-cell-archetype-desc",!1,{width:246,height:150,content_css:"/static/tinymce/content.dark.css"}),f.on("click",".types div[data-archetype]",function(t){t.preventDefault();var a=e(this).data("archetype"),o=l.cellEditGroupStop(function(){l.batchAddCellArchetype(a)});if(!o)if(f.parent().hasClass("batchediting")){l.batchAddCellArchetype(a);var s=m[a]||m._custom[a];if(s&&s.icon!==i){var r=n(s.icon);r||(r='<img src="'+c.get("statics_path")+"img/icon-archetype-"+a.replace(/^_/,"")+'.png">'),e("#sitemap-batch-edit .icon.border").html(r),e("#sitemap-batch-edit .ui-selectmenu.batchediting.archetype > .ui-selectmenu-status").text(s.name)}}else l.addCellArchetype(i,a);f.dialog("close")}).on("mouseenter",".types div[data-archetype]",function(){e(this).addClass("hover")}).on("mouseleave",".types div[data-archetype]",function(){e(this).removeClass("hover")}).on("click",".types div[data-archetype] .help",function(t){t.stopPropagation(),t.preventDefault(),r=!1;var i=e(this).closest("div[data-archetype]"),a=i.data("archetype");f.parent().addClass("black-arrow");var o=!1,s=!1;if("_"===a.charAt(0))o=e.extend({},m[a]),o.desc="<p>"+d.charsEncode(o.desc)+"</p>";else if(m._custom&&m._custom[a]){o=e.extend({},m._custom[a]),o.name=d.charsEncode(o.name);var l=n(o.icon);l&&(o.name=l+o.name),s=!0}if(o&&o.name&&o.desc){e("#archetype-desc .title > h4").html(o.name).attr("class","archetype-"+(s?"custom":a));var c=e("#archetype-desc .text");e("#archetype-desc").stop().css({opacity:0}).show().animate({top:-f.find(".tooltip-modal-titlebar").height(),opacity:1},200),c.hasClass("tinyscrollbar-enabled")?(p.updateContent(c,o.desc),p.update(c)):(c.html(o.desc),p.init(c)),c.find("a").attr("target","_blank"),e(this).parent().addClass("selected").siblings(".archetype").removeClass("selected")}}).on("click","#archetype-desc .title > a",function(i){i.stopPropagation(),i.preventDefault(),t.$body.hasClass("sitemappreview")?f.dialog("close"):(r=!1,e("#archetype-desc").stop().animate({top:"-100%",opacity:0},200,function(){e(this).hide()}),f.parent().removeClass("black-arrow"),f.find(".selected").removeClass("selected"),o(!0))}).on("click",".types div[data-archetype] .edit",function(i){i.stopPropagation(),i.preventDefault(),r=!0;var o=e(this).closest("div[data-archetype]"),n=o.data("archetype");if(m._custom&&m._custom[n]){var s=m._custom[n].icon;"fa-"!==s.slice(0,3)&&(s="");var l=e("#form-page_type_name"),c=e("#form-page_type_icon");f.parent().addClass("black-arrow"),l.val(m._custom[n].name).trigger("keyup"),c.val(s),s?(e("#archetype-custom-icon a span").html(t.__("Edit icon")).closest(".cbuttons").addClass("edit saved"),e("#archetype-custom-icon-wrapper").html('<i class="fa '+s+'"></i>')):e("#archetype-custom-icon a span").html(t.__("Add custom icon")).closest(".cbuttons").addClass("saved").removeClass("edit");var d=e("#archetype-custom-add").data("edit",o).stop().css({opacity:0}).show();m._custom[n].desc&&(e("#archetype-custom-description a").trigger("click"),a(!0,m._custom[n].desc)),d.animate({top:-25,opacity:1},200,function(){l.trigger("keyup").putCursorAtEnd()})}}).on("click","#archetype-custom-add .title > a",function(t){t.stopPropagation(),t.preventDefault(),r=!1,a(!1),e("#archetype-custom-add").removeData("edit").stop().animate({top:"-100%",opacity:0},200,function(){e(this).hide()}),f.parent().removeClass("black-arrow"),o(!0)}).on("click","#archetype-delete",function(i){if(i.preventDefault(),e(this).closest(".cbuttons").hasClass("blocked"))return!1;var a=l.cellEditGroupStop(function(){l.batchRemoveCellArchetype()});a||(f.parent().hasClass("batchediting")?(l.batchRemoveCellArchetype(),e("#sitemap-batch-edit .icon.border").html(""),e("#sitemap-batch-edit .ui-selectmenu.batchediting.archetype > .ui-selectmenu-status").html(t.__("Add Page Type"))):l.removeCellArchetype()),f.dialog("close")}).on("click","#archetype-custom-delete a",function(o){if(o.stopPropagation(),o.preventDefault(),e(this).closest(".cbuttons").hasClass("blocked"))return!1;var n=e("#archetype-custom-add").data("edit");if("object"===e.type(n)&&n instanceof e){var s=n.data("archetype");s&&u.request({data:{delete_custom_archetype:s},success:function(o){n.remove(),a(!1),e("#custom-archetypes-list > .archetype").length||e("#custom-archetypes-list").remove(),e("#archetype-custom-add .title > a").trigger("click"),r=!1,m._custom[s]!==i&&(m._custom[s]=i,delete m._custom[s],c.set("archetypes",m)),l.removeArchetypeDef(s,!0),t.publish("sitemap/custom_archetype_removed",[s])}})}}).on("click","#archetype-custom-icon a",function(t){return e(this).closest(".cbuttons").hasClass("blocked")?(t.stopPropagation(),t.preventDefault(),!1):void 0}).on("click","#archetype-custom-icon-remove a",function(t){return t.stopPropagation(),t.preventDefault(),e(this).closest(".cbuttons").hasClass("blocked")?!1:(e("#form-page_type_icon").val(""),e("#archetype-custom-icon-remove").closest(".cbuttons").addClass("edit"),void e("#archetype-custom-icon a span").html("Add custom icon").closest(".cbuttons").removeClass("edit"))}).on("click","#archetype-cancel",function(e){e.preventDefault(),f.dialog("close")}).on("click","#archetype-save",function(i){if(i.preventDefault(),r){var a=e.trim(e("#form-page_type_name").val());if(a){var o=e("#archetype-custom-add").data("edit"),n=null;o&&o.length&&o.data("archetype")&&(n=o.data("archetype"));var d=s.wysiwyg("form-cell-archetype-desc");d&&d.save();var p=e.trim(e("#form-cell-archetype-desc").val());p&&(p=p.replace(/\<br\>\s*$/,"").replace(/\n/g,"")),u.request({data:{custom_archetype_id:n,custom_archetype:a,custom_archetype_desc:p,custom_icon:e("#form-page_type_icon").val()},success:function(i){var a=f.find(".archetype-"+i.id);if("fa-"===i.icon.slice(0,3))var o='<i class="fa '+i.icon+'"></i>',n={type:"fa",fa:i.icon};else var o=i.icon,n={type:"letter",letter:i.icon};if(a.length){a.attr("title",i.name).children("span").text(i.name).siblings(".icon").html(o);var s=a.find(".help");i.desc?s.length||a.find(".icon").after('<a href="#" class="help"><i class="fa fa-question"></i></a>'):s.length&&s.remove()}else{var r=e("#custom-archetypes-list");if(!r.length){r=e("<div>").attr("id","custom-archetypes-list");var d=e("#archetype-custom");d.length?d.before(r):e("#archetypes-list").append(r)}var u="";r.children("hr").length||(u+="<hr />"),u+='<div data-archetype="'+i.id+'" class="archetype archetype-custom-item archetype-'+i.id+'" title="'+i.name.replace(/"/g,"&quot;")+'"><span>'+i.name+'</span><div class="icon">'+o+"</div>",i.desc&&(u+='<a href="#" class="help"><i class="fa fa-question"></i></a>'),u+='<a href="#" class="edit"><i class="fa fa-pencil"></i></a></div>',r.append(u),a=r.children(".archetype-"+i.id),a.data("archetype",i.id)}m._custom[i.id]={name:i.name,desc:i.desc,icon:i.icon},c.set("archetypes",m),t.publish("sitemap/custom_archetype_saved",[i.id,i.name,i.icon]),l.updateArchetypeDef(i.id,i.name,n),e("#archetype-custom-add .title > a").trigger("click")}})}else f.dialog("close");r=!1}else{var h=f.find(".types div.selected");h.length?h.trigger("click"):f.dialog("close")}}).on("click","#archetype-custom a",function(t){t.preventDefault(),r=!0,f.parent().addClass("black-arrow"),e("#form-page_type_name, #form-page_type_icon").val("").trigger("keyup"),e("#archetype-custom-icon a span").html("Add custom icon").closest(".cbuttons").removeClass("edit saved"),e("#archetype-custom-add").removeData("edit").stop().css({opacity:0}).show().animate({top:-25,opacity:1},200,function(){e("#form-page_type_name").trigger("keyup").putCursorAtEnd()})}).on("click","#archetype-custom-description a",function(t){return t.preventDefault(),e(this).closest(".cbuttons").hasClass("blocked")?!1:(a(!0),void o())}).on("keyup","#form-page_type_name",function(t){var i=e.trim(this.value);i?e("#archetype-custom-add .cbuttons").removeClass("blocked"):e("#archetype-custom-add .cbuttons").addClass("blocked")}),e("#modal-font-awesome").on("keyup change","#modal-font-awesome-search",function(i){var a=e.trim(this.value.toString().replace(/[^a-z0-9 ]+/gi,"").toLowerCase()),o=e("#modal-font-awesome").find(".icons-list").removeData("plugin_tinyscrollbar").removeClass("tinyscrollbar-enabled"),n=o.find("i.fa");if(a){n.hide(),a=a.split(" ");for(var s=[],r=0;r<a.length;++r)""!==a[r]&&s.push('[title*="'+a+'"]');s.length&&n.filter(s.join(",")).show()}else n.show();t.require("scrollbar").init(o,{thumbSize:64,trackSize:385})}).on("click",".icons-list i",function(t){t.preventDefault();var i=e.trim(e(this).attr("class").replace("fa",""));e("#form-page_type_icon").val(i),e("#archetype-custom-icon-wrapper").html(e(this).clone()),e("#archetype-custom-icon a span").html("Edit icon").closest(".cbuttons").addClass("edit"),e(this).closest(".modal").dialog("close")})}),t.subscribe("modal/open/modal-font-awesome",function(e,a){var o=a.find(".icons-list").removeData("plugin_tinyscrollbar").removeClass("tinyscrollbar-enabled");if(o.find("#modal-font-awesome-search").val(""),!o.children(".fa").filter(":first").length){var n=t.require("config").get("fontawesome"),s="";for(var r in n)r!==i&&n.hasOwnProperty(r)&&(s+='<i class="fa fa-'+r+'" title="'+r.replace("-o","").replace("-square","").replace(/-/g," ")+'"></i>');o.html(s+'<div class="clear"></div>')}t.require("scrollbar").init(o,{thumbSize:64,trackSize:385})}),t.subscribe("top_modal/before_init/topmodal-cell-archetype",function(e,i){t.$body.hasClass("sitemappreview")||(i.find(".archetype > .icon").length?i.addClass("has-custom"):i.removeClass("has-custom"))}),t.subscribe("top_modal/open/topmodal-cell-archetype",function(e,i){if(!t.$body.hasClass("sitemappreview")){r=!1,a(!1),o(!0);var n=t.require("sitemap"),s=t.require("svg"),l=n.getCurrentCell();l&&s.hasClass(l,"has-section")?i.parent().addClass("arrow-second"):i.parent().removeClass("arrow-second");var c=s.getData(l,n.getOption("data_archetype"));i.find(".archetype.selected").removeClass("selected"),c&&(c=c.replace(/^_/,""),i.find(".archetype.archetype-"+c).addClass("selected"))}}),t.subscribe("top_modal/close/topmodal-cell-archetype",function(i,a){t.$body.hasClass("sitemappreview")||(o(!0),e("#archetype-desc, #archetype-custom-add").removeData("edit").stop().css({opacity:0,top:"-100%"}).hide(),a.parent().removeClass("black-arrow").find(".selected").removeClass("selected"))})}),Slickplan.module(function(e,t,i){var a="transparent";t.subscribe("route/sitemap",function(){var o=t.require("sitemap"),n=t.require("helper"),s=e("#topmodal-farbtastic");s.on("keyup change","#colorinput",function(){var t=this.value.replace(/[^0-9a-f]/gi,"");if(3===t.length||6===t.length){t="#"+t;var a=e(this).closest(".ui-dialog"),n=a.data("type");"text"===n?o.updateTextColor(t):"line"===n?o.updateLinesColor(t):"batch_cell"===n?(e("#sitemap-batch-edit .colors.batch-cell .color-box").css({backgroundColor:t,borderWidth:0}),o.batchChangeCellColor(t)):"batch_text"===n?(e("#sitemap-batch-edit .colors.batch-text .color-box").css({backgroundColor:t,borderWidth:0}),o.batchChangeCellTextColor(t)):a.hasClass("topFive")||(a.hasClass("cell_color")?o.changeCellColor(i,t,!0):a.hasClass("cell_text_color")&&o.changeCellTextColor(i,t,!0))}}).on("click",".submit input",function(a){a.preventDefault();var r=e(this).closest(".ui-dialog"),l=r.hasClass("topFive"),c=r.data("type");if("submit"===e(this).attr("type")){var d=s.find("#colorinput").val().replace(/[^0-9a-f]/gi,"");if(3===d.length||6===d.length){d="#"+d;var u=o.cellEditGroupStop(function(){"text"===c||"batch_text"===c||r.hasClass("cell_text_color")?o.batchChangeCellTextColor(d):o.batchChangeCellColor(d)});if(!u)if("text"===c)e("#custom-text-color").data("color",d).children("p").css({backgroundColor:d}),o.modified=!0;else if("line"===c)e("#custom-lines-color").data("color",d).children("p").css({backgroundColor:d}),o.modified=!0;else if("batch_cell"===c)e("#sitemap-batch-edit .colors.batch-cell .color-box").css({backgroundColor:d}),o.modified=!0;else if("batch_text"===c)e("#sitemap-batch-edit .colors.batch-text .color-box").css({backgroundColor:d}),o.modified=!0;else if(l){var p=r.data("li");p&&p instanceof e&&(p.data("color",d).children("p").css({backgroundColor:d}),t.publish("modal/farbtastic_swatch_saved",[p,d]))}else r.hasClass("cell_color")?o.changeCellColor(i,d):r.hasClass("cell_text_color")&&o.changeCellTextColor(i,d)}}else{var m=o.getCurrentCell(),f=r.hasClass("cell_color");this.value===t.__("Cancel")?r.find(".close").trigger("click"):n.cellGroupWarningDialog(m,{on_single:function(e){f?o.changeCellColor(e):o.changeCellTextColor(e)},on_unlink:function(e){f?o.changeCellColor(e):o.changeCellTextColor(e)},on_update:function(e){o.cellEditGroupStop(function(e){if(e&&e.cells)for(var t=0,a=e.cells.length;a>t;++t)f?o.changeCellColor(e.cells[t],i,a-1>t):o.changeCellTextColor(e.cells[t],i,a-1>t)})}})}s.dialog("close")}).on("click",".close",function(t){t.preventDefault();var n=e(this).closest(".ui-dialog"),s=n.hasClass("topFive"),r=n.data("type");if("text"===r){var l=e("#custom-text-color").data("color");o.updateTextColor(l)}else if("line"===r){var l=e("#custom-lines-color").data("color");o.updateLinesColor(l)}else if("batch_cell"===r)o.batchChangeCellColor(a),o.batchRestoreCellDatas(o.getOption("data_color")),e("#sitemap-batch-edit .colors.batch-cell .color-box").css({backgroundColor:a,borderWidth:"transparent"===a?"1px":0});else if("batch_text"===r)o.batchChangeCellTextColor(a),o.batchRestoreCellDatas(o.getOption("data_text_color")),e("#sitemap-batch-edit .colors.batch-text .color-box").css({backgroundColor:a,borderWidth:"transparent"===a?"1px":0});else if(!s){var c=n.find(".breset").data("oldcolor");n.hasClass("cell_color")?o.changeCellColor(i,c,!0):n.hasClass("cell_text_color")&&o.changeCellTextColor(i,c,!0)}e(this).closest(".top-modal").dialog("close")})}),t.subscribe("top_modal/after_open/topmodal-farbtastic",function(i,o){var n=t.require("sitemap"),s=o.parent().data("type");"batch_cell"===s?(n.batchBackupCellDatas(n.getOption("data_color")),a=e("#sitemap-batch-edit .colors.batch-cell .color-box").css("background-color")):"batch_text"===s&&(n.batchBackupCellDatas(n.getOption("data_text_color")),a=e("#sitemap-batch-edit .colors.batch-text .color-box").css("background-color")),0!==a.indexOf("#")&&0!==a.indexOf("rgb(")&&(a="transparent")}),t.subscribe("top_modal/close/topmodal-farbtastic",function(e,t){t.parent().removeClass("linetext").removeData("type")})}),Slickplan.module(function(e,t,i){var a=348;t.subscribe("route/sitemap",function(){function o(){n||(n=setTimeout(function(){var t=e("#topmodal-cell-note"),i=t.children("div"),a=i.outerHeight();t.height(a).parent().height(a),n=null},10))}var n,s=t.require("helper"),r=t.require("sitemap"),l=e("#topmodal-cell-note");window.document.getElementById("form-cell-note")&&s.wysiwygInit("form-cell-note",!1,{width:a,plugins:"autoresize",autoresize_min_height:70,autoresize_max_height:520,setup:function(e){e.on("init",function(){e.focus(),o()}),e.on("nodechange setcontent keyup",function(){o()})}}),l.on("click","#note-edit",function(e){if(e.preventDefault(),!l.parent().hasClass("batchediting")){var i=r.getCurrentCell(),a=t.require("svg"),o=a.getData(i,r.getOption("data_desc"));o||r.removeCellNote()}l.dialog("close")}).on("click","#note-save",function(a){a.preventDefault();var o=s.wysiwyg("form-cell-note");o&&o.save();var n=e.trim(l.find("textarea").val());if(n){n=n.replace(/\<br\>\s*$/,"").replace(/\n/g,"");var c=r.cellEditGroupStop(function(){r.batchAddCellNote(n)});if(!c)if(l.parent().hasClass("batchediting")){r.batchAddCellNote(n);var d=e("#sitemap-batch-edit .ui-selectmenu.batchediting.desc");d.data("batchdata",n),d.children(".ui-selectmenu-status").html(t.__("Edit Note"))}else r.addCellNote(i,n);l.dialog("close")}else e("#note-delete").trigger("click")}).on("click","#note-delete",function(i){i.preventDefault();var a=r.cellEditGroupStop(function(){r.batchRemoveCellNote()});if(!a)if(l.parent().hasClass("batchediting")){r.batchRemoveCellNote();var o=e("#sitemap-batch-edit .ui-selectmenu.batchediting.desc");o.data("batchdata",""),o.children(".ui-selectmenu-status").html(t.__("Add Note"))}else r.removeCellNote();l.dialog("close")})}),t.subscribe("top_modal/open/topmodal-cell-note",function(e,o){var n=t.require("sitemap"),s=t.require("svg"),r=n.getCurrentCell(),l=s.getData(r,n.getOption("data_desc_width"));l!==i&&(l=parseInt(l,10))>a||(l=a),o.dialog("option","width",l),o.parent().removeClass("arrow-second arrow-first-offset"),r&&s.hasClass(r,"has-url")&&o.parent().addClass("arrow-first-offset")})}),Slickplan.module(function(e,t,i){function a(e){e||(e=s.children("div")),e.hasClass("tinyscrollbar-enabled")&&(e.css("height",""),e.removeClass("tinyscrollbar-enabled").removeData(),e.find(".external-link").appendTo(e),e.find(".viewport, .scrollbar, .overview").remove())}function o(e){var i=t.require("scrollbar"),o=s.children("div");e||o.find(".external-link").length>2?(o.css("height",320),o.hasClass("tinyscrollbar-enabled")?i.update(o,"relative"):i.init(o,{})):a(o)}function n(t){t>1?s.find(".external-link input.url").each(function(t){e(this).prev("label").html("URL #"+ ++t+":")}):s.find(".external-link input.url").prev("label").html("URL:")}var s=e("#cell-new-link-external-links"),r=e("#sitemap-batch-edit").find(".ui-selectmenu.batchediting.url");t.subscribe("route/sitemap",function(){var l=t.require("sitemap"),c=t.require("form"),d=t.require("string"),u=(t.require("svg"),e("#topmodal-cell-url")),p=10;u.on("click","#url-cancel",function(e){e.preventDefault(),u.dialog("close")}).on("click","#url-save",function(a){a.preventDefault();var o=[],n=e("#topmodal-cell-url").find('input[name="cell_new_link"]:checked').val();if("internal"===n){var c=e.trim(e("#cell-link-top-parent-page").val());c&&(o=[{type:n,page:c}])}else s.find(".external-link").each(function(){var t=e.trim(e(this).find("input.label").val()),i=e.trim(e(this).find("input.url").val());i&&"http://"!==i&&"https://"!==i&&"ftp://"!==i&&o.push({type:n,label:t,url:i})}),1===o.length&&""===o[0].label&&(o=o[0].url);if(o.length){var d=l.cellEditGroupStop(function(){l.batchAddCellUrl(o)});d||(u.parent().hasClass("batchediting")?(l.batchAddCellUrl(o),r.data("batchdata",o),r.children(".ui-selectmenu-status").html(t.__("Edit Link"))):l.addCellUrl(i,o))}else e("#url-delete").trigger("click");u.dialog("close")}).on("click","#url-delete",function(e){e.preventDefault();var i=l.cellEditGroupStop(function(){l.batchRemoveCellUrl()});i||(u.parent().hasClass("batchediting")?(l.batchRemoveCellUrl(),r.data("batchdata",""),r.children(".ui-selectmenu-status").html(t.__("Add Link"))):l.removeCellUrl()),u.dialog("close")}).on("change",'input[name="cell_new_link"]',function(){var t=this.id.replace("cell-new-link-","");e("#cell-new-link-internal-links, #cell-new-link-external-links").hide(),"internal"===t?e("#cell-new-link-internal-links").show():s.show().find("input.url").putCursorAtEnd(),a(),o(!1)}).on("click",".link-fields .new-row",function(t,i){t.preventDefault();var a=s.find(".external-link").length;if(a>=p)return!1;++a;var r=s.find(".external-link").filter(":first").clone().insertAfter(e(this).closest(".external-link"));r.find("input.label").val(i&&i.label?i.label:""),r.find("input.url").val(i&&i.url?i.url:"http://").putCursorAtEnd(),s.find(".remove").show(),a>=p&&s.find(".new-row").hide(),i||(o(a>=p),r.stop().hide().slideDown(250,function(){o()})),n(a)}).on("click",".link-fields .remove",function(t){t.preventDefault(),e(this).closest(".link-fields").slideUp(250,function(){e(this).remove();var t=s.find(".external-link").length;s.find(".new-row").show(),1>=t&&s.find(".remove").hide(),o(),n(t)})}).on("change","#cell-link-top-section-id",function(i,a){var o=e("#cell-link-top-parent-page");c.clearErrors(e("#cell-urls"));var n=o.closest("#cell-urls");if(this.value){n.find(".link-internal-pages").show();var s='<option value="">'+t.__("Select Page")+"</option>";if(o.html(s),l.isMainSection(this.value))var r=["util","home","1","foot"];else var r=["util","1","foot"];for(var u=l.serializeCells(this.value,!0,r),p=0;p<u.length;++p){var m=l.getCellLevel(u[p]),f="number"===e.type(m)?m:0,h=e('<option value="'+u[p].id+'">'+u[p].text+("home"===m?" ("+t.__("Home")+")":"")+"</option>").data("indent",f).appendTo(o);u[p].id===a&&h.prop("selected",!0)}o.selectmenuslickplan("destroy"),o.selectmenuslickplan({style:"popup",maxHeight:300,format:function(e){return d.charsEncode(e)}})}else n.find(".link-internal-pages").hide()}),t.subscribe("sitemap/cell_removed",function(e,t){l.removeInternalLinking(t)})}),t.subscribe("top_modal/open/topmodal-cell-url",function(a,o){var n=t.require("sitemap"),l=t.require("svg"),c=t.require("string");if(o.parent().removeClass("arrow-second arrow-first-offset"),n.isBatchEdit())var d=r.data("batchdata");else{var u=n.isBatchEdit()?i:n.getCurrentCell(),d=l.getData(u,n.getOption("data_url"));u&&l.hasClass(u,"has-desc")&&o.parent().addClass("arrow-second")}s.find(".external-link + .external-link").remove(),o.find("input.label").val(""),o.find("input.url").val("http://"),d&&"string"===e.type(d)&&(d=[{type:"external",label:"",url:d}]);var p=!1;d&&e.isArray(d)&&d[0]&&"string"===e.type(d[0].type)&&"internal"===d[0].type&&d[0].page&&(p=d[0].page);var m=n.getListOfSections(),f="";if(p){var h=n.getCellSection(p);m[h]?f=h:p=!1}var g=0,v=e("#cell-link-top-section-id");v.selectmenuslickplan("destroy");var b='<option value="">Select Section</option>';e.each(m,function(e,t){b+='<option value="'+e+'"',b+=">"+c.charsEncode(t)+"</option>",++g}),v.html(b);var _=o.find(".link-internal-sections").hide(),y=o.find(".link-internal-pages").hide();if(g>1?(v.val(f),_.show()):(v.val(n.getOption("id_main_section")),y.show()),v.trigger("change",[p]),v.selectmenuslickplan({style:"popup",maxHeight:300,format:function(e){return c.charsEncode(e)}}),d&&e.isArray(d))if(d[0]&&"string"===e.type(d[0].type)&&"internal"===d[0].type)e("#cell-new-link-"+(p?"internal":"external")).prop("checked",!0).trigger("change");else for(var w=0,C=d.length;C>w;++w)d[w]&&d[w].type&&"external"===d[w].type&&(0===w?s.find(".external-link").filter(":first").find("input.label").val(d[w].label).end().find("input.url").val(d[w].url):s.find(".link-fields .new-row").filter(":last").trigger("click",[d[w],!0]),w+1===C&&e("#cell-new-link-"+d[w].type).prop("checked",!0).trigger("change"));else e("#cell-new-link-external").prop("checked",!0).trigger("change")})}),Slickplan.module(function(e,t,i){var a=function(e){for(var t,i={},a=/<([a-z0-9_]+)>([^<]+)<\/\1>/gi;t=a.exec(e);){var o=t[1].toLowerCase();i[o]=t[2]}return i},o=function(o,n){var s=t.require("http"),r=t.require("config"),l=e(o),c=l.data("maxsize")||"1mb",d=l.data("multiple")||!1,u=l.data("droptarget")||!1,p=l.data("mimes"),m=l.data("s3");if(p=p&&"all"!==p&&"files"!==p?p.split(","):[],p&&p.length){for(var f=[],h=0,g=p.length;g>h;++h)switch(p[h]){case"images":f.push({title:"Image Files",extensions:["bmp","gif","jpg","jpeg","png","tiff"].join(",")});break;case"videos":f.push({title:"Video Files",extensions:["3gp","avi","flv","m4v","mov","mp4","mpg","mpeg","wmv","ogv","webm"].join(",")});break;default:f.push({title:(""+p[h]).toUpperCase()+" files",extensions:p[h]})}p=f}var v=null;if(m){var b=r.get("s3");if(b){var _="https://"+b.bucket+".s3.amazonaws.com:443/";v={acl:b.acl,"Content-Type":"text/plain","Cache-Control":"public",Expires:b.expires,AWSAccessKeyId:b.key,policy:b.policy,signature:b.signature,success_action_status:"201"}}else m=!1}if(!v){var _=s.url(l.closest("form").attr("action")||i);if(v={ajax:1,plupload:1,_nonce:e('meta[name="csrf-token"]').attr("content"),UPLOADIFYSESSION:s.getCookie("session")},l.closest("form").length){var y=l.closest("form").serializeObject();v=e.extend(v,y)}}var w=new window.plupload.Uploader({runtimes:"html5,flash,html4",browse_button:o,multi_selection:d,drop_element:u,url:_,filters:{prevent_duplicates:!1,max_file_size:c,mime_types:p},flash_swf_url:"/static/js/plupload/Moxie.swf",multipart_params:v,max_retries:1,init:{Init:function(){if(u&&this.features.dragdrop){var t=e("#"+u);if(t.length){var i,a=t.get(0);a&&(a.ondragover=function(e){e.dataTransfer.dropEffect="copy"},a.ondrop=function(e){t.removeClass("dragover")}),t.on("dragenter",function(e){i=e.target;var a=e.originalEvent.dataTransfer;null!=a.types&&(a.types.indexOf?-1!=a.types.indexOf("Files"):a.types.contains("application/x-moz-file"))&&t.addClass("dragover")}).on("dragleave",function(a){e(this).find(i).size()||e(this).find(a.target).size()||t.removeClass("dragover")})}}},PostInit:function(){t.publish("upload/post_init_"+n,[w,o])},FilesAdded:function(e,i){t.publish("upload/files_added_"+n,[e,i,o])},BeforeUpload:function(e,i){if(m&&b&&i){var a=t.require("string");e.settings.multipart_params["Content-Type"]=/^(image\/.+|video\/.+|application\/pdf)$/.test(i.type)?i.type:"application/octet-stream";var o=(""+i.name).split(".").pop().toLowerCase();e.settings.multipart_params.key=b.folder+"/"+a.random(32)+"_"+Math.floor(Date.now()/1e3)+(""!==o?"."+o:""),e.settings.multipart_params.Filename=e.settings.multipart_params.key}t.publish("upload/file_before_upload_"+n,[e,i])},UploadFile:function(e,i){t.publish("upload/file_upload_file_"+n,[e,i])},FileUploaded:function(i,s,r){r=r.response,m?r=a(r):"string"===e.type(r)&&(r="["===r.charAt(0)||"{"===r.charAt(0)?e.parseJSON(r):{error:r}),t.publish("upload/file_uploaded_"+n,[i,s,r,o])},UploadProgress:function(e,i){t.publish("upload/uploads_progress_"+n,[e,i,o])},UploadComplete:function(e,i){t.publish("upload/uploads_complete_"+n,[e,i,o])},Error:function(e,i){t.publish("upload/error_"+n,[e,i,o])}}});return w.init(),w};t.$body.find(".uploadbutton:not(.dynamic)").each(function(){var t=e(this).data("name")||this.id;o(this,t)});var n=t.require("form"),s=window.File&&window.FileReader&&window.FileList;t.$body.find("input:file.plainupload").each(function(){var t=e(this),a=(t.attr("name").replace(/[^a-z0-9_-]/g,""),t.siblings(".filename"));t.on("change",function(o){if(s&&o.target&&o.target.files&&o.target.files[0]&&o.target.files[0].name)var r=o.target.files[0].name;else var r=t.val().split(/(\\|\/)/g).pop();var l=t.closest("#importopts");if(s&&l.length){n.clearErrors(l.parent());var c=-1!==r.indexOf(".")?r.replace(/.*[.]/,"").toLowerCase():"",d=null;"dash"===e('#import-tab input[name="import[type]"]:checked').val()?"txt"!==c&&(d="File has an invalid extension, it should be txt."):"xml"!==c&&(d="File has an invalid extension, it should be xml."),d&&n.error(l.prev(),d,{bottom:-41},i,-20)}a.length&&(a.is("input")?a.val(r):a.html(escape(r)))})});var r={};t.subscribe("upload/dynamic_uploader/init",function(t,i,a,n){
    if(i&&a){var s=e(i);i=o(i,a),n&&(r[n]&&r[n].destroy(),r[n]=i,s.closest("#modal-confirm").length&&s.data("uploader_key",n))}}),t.subscribe("upload/dynamic_uploader/destroy",function(e,t){r&&r[t]&&(r[t].destroy(),delete r[t],r[t]=i)})});
    //# sourceMappingURL=controllers.pack.js.map
